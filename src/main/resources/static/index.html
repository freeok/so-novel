<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico"/>
    <link rel="stylesheet" href="/css/normalize.css"/>
    <link rel="stylesheet" href="/css/index.css"/>
</head>
<body>
<div class="wrap-container">
    <div class="container download-container">
        <div class="title">下载</div>
        <div class="search-container">
            <input id="downloadSearchName" placeholder="请输入书名或作者（尽量输完整）"/>
            <button onclick="searchFile()">搜索</button>
        </div>
        <div class="body-container">
            <table>
                <thead>
                <tr>
                    <th>序号</th>
                    <th>书名</th>
                    <th>作者</th>
                    <th>最新章节</th>
                    <th>最后更新时间</th>
                    <th>书源</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="downloadTableBody">
                </tbody>
            </table>
        </div>
    </div>
    <div class="container result-container">
        <div class="title">已下载文件列表</div>
        <div class="search-container">
            <button id="refreshList" onclick="searchList()">刷新列表</button>
        </div>
        <div class="body-container">
            <table>
                <thead>
                <tr>
                    <th>文件名</th>
                    <th>文件大小</th>
                    <th>下载时间</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="loading-container" id="tipEle">
    <div class="content">
        <svg t="1754132474424" class="icon" viewBox="0 0 1105 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
             p-id="4590" width="256" height="256">
            <path d="M990.723072 342.87616a115.0976 115.0976 0 0 0-99.75808 57.91744 116.38784 116.38784 0 0 0 0 115.83488 115.0976 115.0976 0 0 0 99.75808 57.91744c63.63136 0 115.2-51.85536 115.2-115.83488 0-63.97952-51.56864-115.83488-115.2-115.83488zM566.787072 18.5344a13.86496 13.86496 0 0 0-13.824 13.90592 13.80352 13.80352 0 1 0 25.8048 6.9632 13.96736 13.96736 0 0 0 0-13.9264 13.80352 13.80352 0 0 0-11.9808-6.94272zM354.819072 0c-15.2576 0-27.648 12.45184-27.648 27.79136 0 15.36 12.3904 27.81184 27.648 27.81184 15.27808 0 27.648-12.45184 27.648-27.81184 0-15.36-12.36992-27.79136-27.648-27.79136zM188.931072 101.92896A41.5744 41.5744 0 0 0 147.459072 143.64672 41.5744 41.5744 0 0 0 188.931072 185.344a41.5744 41.5744 0 0 0 41.472-41.69728 41.5744 41.5744 0 0 0-41.472-41.71776zM59.907072 417.01376c-21.4016 0-41.1648 11.4688-51.87584 30.1056a60.5184 60.5184 0 0 0 0 60.25216 59.84256 59.84256 0 0 0 51.87584 30.1056c21.4016 0 41.18528-11.4688 51.89632-30.1056a60.5184 60.5184 0 0 0 0-60.25216 59.84256 59.84256 0 0 0-51.89632-30.1056zM202.755072 732.09856c-40.71424 0-73.728 33.1776-73.728 74.1376 0 40.93952 33.01376 74.1376 73.728 74.1376 40.73472 0 73.728-33.19808 73.728-74.1376 0-40.96-32.99328-74.1376-73.728-74.1376zM534.531072 847.93344a87.4496 87.4496 0 0 0-75.81696 44.01152 88.4736 88.4736 0 0 0 0 88.04352A87.4496 87.4496 0 0 0 534.531072 1024a87.4496 87.4496 0 0 0 75.83744-44.032 88.4736 88.4736 0 0 0 0-88.02304 87.4496 87.4496 0 0 0-75.83744-44.032zM861.699072 690.3808c-55.99232 0-101.376 45.64992-101.376 101.94944 0 56.29952 45.38368 101.92896 101.376 101.92896s101.376-45.62944 101.376-101.92896c0-56.32-45.38368-101.94944-101.376-101.94944z"
                  p-id="4591"></path>
        </svg>
        <span class="text" id="tipText">正在下载</span>
    </div>
</div>
<script>
    const hostname = window.location.hostname;
    const port = window.location.port;
    const protocol = window.location.protocol.startsWith('https') ? 'wss' : 'ws';
    let ws;

    const initWebsocket = () => {
        ws = new WebSocket(`${protocol}://${hostname}:${port}/ws`);
        ws.onopen = () => {
            console.log('WebSocket Open!');
        }
        ws.onmessage = (e) => {
            const json = JSON.parse(e.data);
            if (json.type === 'download') {
                updateTip('当前进度：' + json.index + ' / ' + json.count);
            }
        }
        ws.onerror = (e) => {
            setTimeout(() => {
                initWebsocket()
            }, 1000)
        }
        ws.onclose = (e) => {
            setTimeout(() => {
                initWebsocket()
            }, 1000)
        }
    }
    initWebsocket()

    const searchList = () => {
        fetch('/file/list').then(res => res.json()).then((data) => {
            console.log('data: ', data)
            data = data.sort((a, b) => b.time - a.time);
            const array = []
            data.forEach(item => {
                const liStr = `
                    <tr>
                        <td>${item.name}</td>
                        <td>${formatSize(item.size)}</td>
                        <td>${formatDate(item.time)}</td>
                        <td><button onclick="downloadFile('${item.name}')">下载</button></td>
                    </tr>
                `
                array.push(liStr)
            })
            document.getElementById('tableBody').innerHTML = array.join('')
        })
    }
    searchList()
    const formatSize = (bytes) => {
        if (bytes === 0) return '0.00 B';

        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];

        // 确定单位
        const i = Math.floor(Math.log(bytes) / Math.log(k));

        // 计算对应单位的大小并保留两位小数
        const sizeValue = parseFloat((bytes / Math.pow(k, i)).toFixed(2));

        return sizeValue + sizes[i];
    }
    const formatDate = (time) => {
        const date = new Date(time);
        const year = date.getFullYear();
        let month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hour = date.getHours().toString().padStart(2, '0');
        const minute = date.getMinutes().toString().padStart(2, '0');
        const second = date.getSeconds().toString().padStart(2, '0');
        return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
    }
    const downloadFile = (name) => {
        console.log('下载:', name)
        window.open(window.location.origin + '/file/download?filename=' + name, '_blank');
    }
    let bookCache = []
    const searchFile = () => {
        const value = document.getElementById('downloadSearchName').value.trim();
        if (!value) {
            return;
        }
        showTip('正在搜索。。。')
        fetch('/search?name=' + value).then(res => res.json()).then((data) => {
            console.log(data);
            bookCache = data
            const array = []
            data.forEach((item, index) => {
                const liStr = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.bookName}</td>
                        <td>${item.author}</td>
                        <td>${item.latestChapter || ''}</td>
                        <td>${item.lastUpdateTime || ''}</td>
                        <td>${item.sourceId}</td>
                        <td><button onclick="downloadFileToSever(${index})">下载</button></td>
                    </tr>
                `
                array.push(liStr)
            })
            document.getElementById('downloadTableBody').innerHTML = array.join('')
        }).finally(() => {
            hideTip()
        })
    }

    const downloadFileToSever = (index) => {
        const item = bookCache[index];
        if (!item) {
            alert("参数错误，请重新搜索")
            return;
        }
        console.log('item: ', item)
        let query = []
        Object.keys(item).forEach((key) => {
            query.push(key + '=' + item[key])
        })
        showTip('正在下载：' + item.bookName)
        fetch('/download?' + query.join('&')).then((data) => {
            searchList()
        }).finally(() => {
            hideTip()
        })
    }

    const tipEle = document.getElementById('tipEle');
    const tipText = document.getElementById('tipText');
    const showTip = (text) => {
        tipEle.style.display = 'flex';
        if (text) {
            updateTip(text)
        }
    }
    const updateTip = (text) => {
        tipText.innerHTML = text;
    }
    const hideTip = () => {
        tipEle.style.display = 'none';
    }
</script>
</body>
</html>