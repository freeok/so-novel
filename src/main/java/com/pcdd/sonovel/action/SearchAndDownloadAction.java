/* 习皇的新装 秦城监狱 孢 任大炮 朝令夕改 坟头蹦迪 截颈平 习一尊 维尼DISCO 动森 第一书记王沪宁 习总 通商宽衣 孤独的毒王 九评 习梦死 灰习牛 共哀宗 捐麦子 习式病毒 冤大头 扛麦帝 裹嘎举吸钢闸门 人类命运共同体首席架构师 习达姆 习猪头 那翠化 习正日 习澳塞斯库 《生物安全法》 刁人13 V尼哥 主席+终身制 不知名氏 包子兵法 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 习大郎 毛进平 XD WHO的君王 氼兲嫑炛 毛孙 祈翠語言包 爱新觉罗近平 习流氓 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 倒车 720事件 维尼之声 nmslman（习主席） 发皇帝梦 小习微信 刁斤二 4中组长 SB包子 习king 习犬犬 xdd 皇帝亲临忠诚的武汉 骑巨龙 九大诉求 神明论 头号球迷 习思想 万岁来武汉 习卒 习殡法 中国离岸隐匿资产管理工作领导小组组组长 维尼连任 Criminal##Xi##"Xitler"##Jinping 猪禁评 崇祯帝 包经 毛二 “梦回大清” 法习斯 当皇帝的小丑 维尼写史 shuu##kinn##pei 习张三丰 Voice##of##Pooh 蔡英文最强助选 家业论 胡志平 昆明湖涨潮 习时代 玉习大帝 西朝鲜人民自治岛 习总输记 习大乞 卡近菲 习二世胡亥 刁近乎 阳台上的哨兵 爱新觉罗·近平 习皇帝 刁斤山 亲自封号 中国的新皇帝 赛禁评 疫情蔓延 指定接班人 不敢高声语 习匪帝 习兵法 相信有神论的物理学博士 读书单 Adolf##Xitler 北京中南海支部书记 无限连任 添宪宝宝 红旗下的蛋 习大犬 塔西佗陷阱 习Core shit##hole##bing##fa 习三拍 墨索里习 习匪 粪坑先生 邪大大 任志强 “无罩”现身 央视姓党 儿童习典 习废帝 送礼平 庆丰包·勃列日涅夫 习远凸 我是一个足球迷 习夶 总加速师 赵弹 习是春竹 中国特色射秽煮疫制度 习大帝 virus##king 裸宽包子劾心 口罩大会 刁大犬 不同意的举手##没有##没有 称帝修宪 小学博士 习二胖 十日文革 A##Big##Deal 国贼习近平 習敗北 习后主 役民五术 屎禁评 老歪脖子树 连专家也为之叹服的电脑天才 维尼梗有害 席子兵法 200吨 戏包皮 万岁 嘻包皮 集近闭 倒车斯基 云视察 重地之战 狙击手布阵 仲夏夜之中国梦 修宪连任 你是反贼吗 习emperor 崇祯 中字头组长 习和谐 维尼熊 慨撒大帝 号屎洞 袁世凯第二 习蛤 粪坑兵法 做N届的主席 习梦思 隔离”的金葫芦 皇帝亲临忠诚的武汉 习奥塞斯库 人均接近八千万 维尼史 细颈瓶 颐指气使 梁家河 庆丰废物 甩锅侠 Cicada##3301##XD 吃赵弹 习大 口罩外交 Mr##Shithole 赵家家仆 维持会长 民进党 习近砰 維尼頌 包包侠 习尿瓶 叼斤干 阿道夫-习 维尼挂彩 头上三尺有神明 人民领袖 冰棒外交 包子病毒 習敗敗 习低能儿 厕所革命 晚共昏君 人民战争 集金pay 假.."~bang！卒 维尼带货 恐惊天上人 野兽先辈 包皇 羽日帝 䒒(tiáo)菦(qín)苹(píng) 撒币宝 终身领导人 初二圣君 支那精神野爹 世界最强乞丐 包子宪法 一带一路 习包子的Fa 时间控制 习包子 赵人13 親自視頻 席近平 糖尿维尼 習大佬 习呆呆 格萨尔 毛装 毛近平 大兔 习太孑 习王的田野上 习习蛤蛤 清单帝 亲自指挥疫情 悉包皮 大撒币 劝进 学包分子 Heil##Xitler 人民领袖 吸精瓶 彭主席（习主席走了太太接班） 大撒幣 习像章 屎進瓶 川普的朋友or敌人 阿平 读稿机 错误执行者 总书记来我家 习驴 祈翠 shit禁评 10号跳跳虎被维尼拉清单 维尼快乐组织（Winnie##Happy##Organization）简称WHO 日子像蜜甜 2020全面小康 新影帝 vop 中国离岸隐匿资产管理工作领导小组组组长 Corona##Xi（习病毒） 疯狂宇宙 退党 习是春绿 闹得欢 习条英机 宰相 哲欣 腊肉馅儿包子 这个年很静 NMSL 独彩者 大大招牌 韦来书记 64岁 习包子 御板泽民 大锅瞻遗 尼哥 习二蛋 没规划的葬礼 黑白翠 没有网络安全就没有国家安全 庆丰帝的千秋梦 禁评封号 亲自脱贫 亲自考察 智商不重要 北红尾鸲 巴拿马文件 世宗 现任匪首 20000T麦子 嬉包皮 修宪 习包皮 形式主义防疫 习贼 主席贺词 近身平A 食腐虫 禁评的理由 平平 习梦撕 尊蛤讨包 领袖习澡水 翡翠娘娘 386系统驱动游戏 习卒习 习厉王 包子金刚腿 中国爱非洲 动物之森 shit侯 普习金 维尼熊给跳跳虎黄牌 维尼大帝 富平学霸刁斤干 习“甩锅” 习下台 冠子兵法 习教父 electron8964 黄俄 维稳警察（O） 喷粪帝 孙笑川 满脸喷粪 十一郎习近平 基拉大和习近平 习言乱语 刁后主 叩谢习恩 武统时代 沼气专家 宽衣帝 亲自指挥 包禁评 习侯 刁近猴 洗包皮 倒车帝 戏博士 拉清单 背书单 习武帝 太祖兔 习猪下台 狙击手待命 动物森友会 近言 bingbang帝 中国拉清单工作领导小组组长 习二二（二零二零年五月二十二日开二会） 包帝巡游 习背书 梦回大清 五毛主席 坡涛汹涌 彩色哥 蹄防 总统包子习 电脑世代586 断崖式下跌 刁二婚 法外狂徒Lucy（德国） 集金币 疯狂宇宙包 感恩教育 花花公子 最后领导人 灭共助推器 贬词包用 近日成 岿然不动 包大人 恩重如删 野兽主席 大国造疫 墙内人 超邓赶毛 习孢子 帝皇頌 习公奭 傻大头 习大林 老街 夶 清华毕业 刁槑夶尛 包子露宪 青年大学包 CoronaXi 系包皮 追思焦裕禄 喜包皮 毛二习 野心习 人尽皆知的体育迷 习付 习语 当代秦二世 足球外交 习三点 习猪席 坡涛汹涌 刁人13 “登基” 外交习语 刁远山 戴口赵 XDD 糟糕皇帝 习进棺 叩谢习恩 腊肉包 半羽习近平 当代秦始皇 一天游泳一千米 战“疫”金句 刁二将 习禁评 亲自删评 习狍 东瘟疫之地统治者暨全境守护者 习得梁家书卷 讨习檄文 纳翠党 恩维尔·霍习 独裁者 梁家河贵族 疯狂宇宙大帝 抗麦套装 吸包皮 学包积极分子 包惠帝 游泳一千米 习歪嘴 习博士 次级乳包 末代皇帝 扛麦郎 屎侯 核平全世界 二百五大帝 学包率 第22条军规 毛二世 习包子 天安门合法继承人 nmslese##dream 支那毒王 袭包皮 包包大人 文明其精神 小学居士 战疫国 视频看望 “登机”（与登基同音） 习屎黄 习尔布特 习老八 狙击手待命 耀眼黄红黄 白猪 庆丰称帝 金科律玉 公车上书 瘟疫降生习近平 国王 习索里尼 习病法 习奥赛斯库 Chairman##Xi 乳透社##小反旗 大撒币 字共狗 习语录 维尼警察（X） 总书记来过我的家 “黄袍加身” “皇帝梦” “复辟” 动物庄园 乳制品 大海掀翻小池塘 共哀宗 皇帝的新衣 禁评大帝 书单吟诵者 普近 影子末帝 习##卡##巴##卡 习二坐船 毛魔转世 彩色熊 颐使气指 平&强 親自蒞臨 习特勒 百万雄师事件 通商宽衣 习躲躲 武汉委托李克强 两会期间+隐瞒 乳包文化 皇帝梦 细瓶颈 官僚主义 习家军 习二卒 红二代 鞋哥 习近平光辉形象 不强自息 平话 梦帝 惜包皮 瘟疫领主习近平 每日祈翠 习瘟猪 赵王 ChinaXi 武当七侠的政治斗争 枪毙名单 The##Xi##Factor（习近平因素） 万岁来武汉了 冲塔 习核心 东方project 迈克尔·索伊 野蛮其体魄 专治各种不服 匪酋习维尼 号尿壶公 赵付 “习泽东”和“洪宪”（袁世凯的帝号） 大大品牌 维尼·屎(Winnie##the##Poo) 中国首席造梦大师 习宽衣 洗尽贫 信女愿一生吃素 */
package com.pcdd.sonovel.action;

import cn.hutool.core.collection.CollUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.core.util.NumberUtil;
import com.pcdd.sonovel.core.Crawler;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.model.*;
import com.pcdd.sonovel.parse.BookParser;
import com.pcdd.sonovel.parse.SearchResultParser;
import com.pcdd.sonovel.parse.TocParser;
import com.pcdd.sonovel.util.JsoupUtils;
import lombok.AllArgsConstructor;
import lombok.SneakyThrows;
import org.jline.reader.LineReader;
import org.jline.reader.LineReaderBuilder;
import org.jline.terminal.Terminal;

import java.util.List;

import static org.fusesource.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2024/11/10
 */
@AllArgsConstructor
public class SearchAndDownloadAction {

    private final AppConfig config;

    public void downloadFromUrl(LineReader reader) {
        String bookUrl = reader.readLine(render("==> @|blue 请输入书籍详情页网址: |@")).strip();
        Rule rule = new Source(config).rule;
        // www.69shuba.me 的链接转换为 69shuba.cx 的
        bookUrl = JsoupUtils.invokeJs(rule.getBook().getUrl(), bookUrl);
        Book book = new BookParser(config).parse(bookUrl);
        SearchResult sr = SearchResult.builder()
                .url(book.getUrl())
                .bookName(book.getBookName())
                .author(book.getAuthor())
                .latestChapter(book.getLatestChapter())
                .latestUpdate(book.getLatestUpdate())
                .build();
        TocParser tocParser = new TocParser(config);
        List<Chapter> toc = tocParser.parse(sr.getUrl());
        // tocParser.shutdown();
        Console.log("<== 《{}》({})，共计 {} 章", sr.getBookName(), sr.getAuthor(), toc.size());
        double res = new Crawler(config).crawl(sr, toc);
        Console.log("<== 完成！总耗时 {} s\n", NumberUtil.round(res, 2));
    }

    public void downloadByKeyword(LineReader reader) {
        // 1. 查询
        String keyword = reader.readLine(render("==> @|blue 请输入书名或作者（宁少字别错字）: |@")).strip();
        if (keyword.isEmpty()) return;
        List<SearchResult> results = new Crawler(config).search(keyword);
        if (results.isEmpty()) return;

        // 2. 打印搜索结果
        SearchResultParser.printSearchResult(results);

        int num;
        int action;
        SearchResult sr;
        List<Chapter> toc;
        // 3. 选择下载章节
        while (true) {
            String input = reader.readLine("==> 请输入下载序号（首列的数字，或输入 0 返回）：").strip();
            // 健壮性判断：必须为数字
            try {
                num = Integer.parseInt(input);
            } catch (NumberFormatException e) {
                continue;
            }

            // 没有搜到想要的书，返回
            if (num == 0) return;
            // 健壮性判断：必须为首列的序号
            if (num < 0 || num > results.size()) continue;

            sr = results.get(num - 1);
            Console.log("<== 正在获取章节目录 ...");
            TocParser tocParser = new TocParser(config);
            toc = tocParser.parse(sr.getUrl(), 1, Integer.MAX_VALUE);
            // tocParser.shutdown();

            Console.log("<== 你选择了《{}》({})，共计 {} 章", sr.getBookName(), sr.getAuthor(), toc.size());
            Console.log("==> 0: 重新选择功能");
            Console.log("==> 1: 下载全本");
            Console.log("==> 2: 下载指定范围章节");
            Console.log("==> 3: 下载最新章节");
            Console.log("==> 4: 重新输入序号");

            try {
                action = Integer.parseInt(reader.readLine("==> 请输入序号："));
            } catch (NumberFormatException e) {
                continue;
            }

            if (action != 4) break;
        }
        if (action == 0) return;
        if (action == 2) {
            try {
                String[] split = reader.readLine("==> 请输起始章(最小为1)和结束章，用空格隔开：").strip().split("\\s+");
                int start = Integer.parseInt(split[0]) - 1;
                int end = Integer.parseInt(split[1]);
                toc = CollUtil.sub(toc, start, end);
            } catch (Exception e) {
                return;
            }
        }
        if (action == 3) {
            try {
                int i = Integer.parseInt(reader.readLine("==> 请输入要下载最新章节的数量："));
                toc = CollUtil.sub(toc, toc.size() - i, toc.size());
            } catch (Exception e) {
                return;
            }
        }

        double res = new Crawler(config).crawl(sr, toc);
        Console.log("<== 完成！总耗时 {} s\n", NumberUtil.round(res, 2));
    }

    @SneakyThrows
    public void execute(Terminal terminal) {
        LineReader reader = LineReaderBuilder.builder().terminal(terminal).build();
        Source source = new Source(config.getSourceId());

        // URL 下载的小说，rule.json 删除 search
        if (source.rule.getSearch() == null) {
            downloadFromUrl(reader);
        } else {
            downloadByKeyword(reader);
        }
    }

}