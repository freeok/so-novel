/* 习三拍 甩锅侠 背书单 天安门合法继承人 共哀宗 习奥赛斯库 食腐虫 儿童习典 习梦撕 夶 习梦死 包包大人 恩重如删 包惠帝 习孢子 耀眼黄红黄 冠子兵法 刁人13 瘟疫降生习近平 野兽主席 维尼之声 吃赵弹 习大乞 “习泽东”和“洪宪”（袁世凯的帝号） SB包子 号尿壶公 庆丰帝的千秋梦 超邓赶毛 当皇帝的小丑 包经 习进棺 假.."~bang！卒 亲自删评 中字头组长 习emperor 万岁来武汉 动物庄园 习匪帝 习张三丰 喷粪帝 习和谐 维尼警察（X） nmslese##dream 连专家也为之叹服的电脑天才 灭共助推器 主席贺词 野兽先辈 包子金刚腿 闹得欢 维尼连任 习近砰 拉清单 习奥塞斯库 世界最强乞丐 习二胖 动森 晚共昏君 塔西佗陷阱 习是春绿 习Core 維尼頌 不强自息 Cicada##3301##XD 刁远山 号屎洞 尼哥 亲自指挥 领袖习澡水 瘟疫领主习近平 习包子 发皇帝梦 狙击手待命 《生物安全法》 10号跳跳虎被维尼拉清单 格萨尔 颐使气指 习式病毒 习正日 大大招牌 The##Xi##Factor（习近平因素） 通商宽衣 初二圣君 包皇 习低能儿 习猪头 吸精瓶 每日祈翠 一带一路 阿道夫-习 口罩大会 文明其精神 洗包皮 智商不重要 大国造疫 花花公子 游泳一千米 親自蒞臨 总书记来我家 哲欣 梁家河贵族 九评 禁评的理由 动物之森 習敗北 电脑世代586 糖尿维尼 平话 习大郎 習敗敗 习得梁家书卷 不敢高声语 大撒币 习达姆 洗尽贫 bingbang帝 集金币 集近闭 维持会长 毛二习 冤大头 错误执行者 阿平 习皇的新装 枪毙名单 爱新觉罗近平 习宽衣 细颈瓶 普近 墙内人 习公奭 民进党 大大品牌 当代秦始皇 习尔布特 倒车帝 隔离”的金葫芦 红旗下的蛋 习核心 末代皇帝 近言 习后主 维尼梗有害 学包积极分子 万岁来武汉了 人尽皆知的体育迷 爱新觉罗·近平 维尼带货 中国拉清单工作领导小组组长 嬉包皮 刁斤山 次级乳包 皇帝梦 战疫国 悉包皮 崇祯帝 中国特色射秽煮疫制度 Criminal##Xi##"Xitler"##Jinping 习呆呆 大锅瞻遗 毛二 修宪连任 捐麦子 叼斤干 习废帝 习侯 包子病毒 百万雄师事件 二百五大帝 习包子的Fa 央视姓党 维尼·屎(Winnie##the##Poo) 纳翠党 习大林 法习斯 黄俄 西朝鲜人民自治岛 习瘟猪 匪酋习维尼 庆丰包·勃列日涅夫 朝令夕改 习“甩锅” 大海掀翻小池塘 习犬犬 头号球迷 野蛮其体魄 截颈平 书单吟诵者 皇帝亲临忠诚的武汉 头上三尺有神明 Voice##of##Pooh 无限连任 彩色哥 赵弹 人类命运共同体首席架构师 傻大头 习驴 疯狂宇宙包 包子宪法 Heil##Xitler 你是反贼吗 戏博士 总书记来过我的家 北红尾鸲 亲自脱贫 “复辟” 皇帝的新衣 当代秦二世 集金pay 习躲躲 包包侠 乳透社##小反旗 惜包皮 屎侯 灰习牛 东瘟疫之地统治者暨全境守护者 习是春竹 xdd 抗麦套装 习澳塞斯库 川普的朋友or敌人 2020全面小康 总加速师 羽日帝 最后领导人 帝皇頌 刁二婚 包帝巡游 富平学霸刁斤干 共哀宗 习歪嘴 彭主席（习主席走了太太接班） 席近平 卡近菲 阳台上的哨兵 刁近乎 扛麦郎 习贼 Chairman##Xi 吸包皮 平平 疯狂宇宙大帝 包大人 叩谢习恩 玉习大帝 撒币宝 shit##hole##bing##fa 习包皮 大撒币 习梦思 讨习檄文 习二世胡亥 粪坑先生 习条英机 习病法 维尼熊给跳跳虎黄牌 习武帝 梦帝 沼气专家 中国离岸隐匿资产管理工作领导小组组组长 青年大学包 习禁评 包禁评 官僚主义 万岁 shuu##kinn##pei 公车上书 親自視頻 中国首席造梦大师 小习微信 习包子 人民领袖 厕所革命 祈翠 习家军 人均接近八千万 疯狂宇宙 日子像蜜甜 鞋哥 孙笑川 WHO的君王 shit侯 金科律玉 NMSL 专治各种不服 颐指气使 疫情蔓延 习尿瓶 䒒(tiáo)菦(qín)苹(píng) 岿然不动 野心习 习猪席 细瓶颈 这个年很静 习博士 宽衣帝 习语 赛禁评 习大 主席+终身制 读稿机 席子兵法 冰棒外交 人民领袖 习厉王 “黄袍加身” 追思焦裕禄 巴拿马文件 “梦回大清” 大撒幣 时间控制 V尼哥 粪坑兵法 习时代 近日成 小学居士 习流氓 刁斤二 不知名氏 没规划的葬礼 维尼挂彩 第22条军规 红二代 退党 习思想 坡涛汹涌 皇帝亲临忠诚的武汉 “无罩”现身 指定接班人 习远凸 扛麦帝 毛孙 nmslman（习主席） 御板泽民 习兵法 毛魔转世 習大佬 相信有神论的物理学博士 嘻包皮 足球外交 近身平A 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 屎禁评 恐惊天上人 亲自考察 习一尊 习特勒 习老八 猪禁评 坡涛汹涌 国贼习近平 狙击手待命 邪大大 家业论 ChinaXi 喜包皮 大兔 习二二（二零二零年五月二十二日开二会） 赵家家仆 维稳警察（O） 刁槑夶尛 胡志平 系包皮 坟头蹦迪 386系统驱动游戏 半羽习近平 动物森友会 清单帝 200吨 孤独的毒王 屎進瓶 恩维尔·霍习 A##Big##Deal 新影帝 习包子 蔡英文最强助选 那翠化 老歪脖子树 倒车斯基 基拉大和习近平 刁二将 核平全世界 武当七侠的政治斗争 昆明湖涨潮 断崖式下跌 独裁者 贬词包用 慨撒大帝 袭包皮 习二蛋 “登机”（与登基同音） 学包分子 两会期间+隐瞒 庆丰称帝 XD 习语录 五毛主席 习狍 韦来书记 4中组长 毛近平 CoronaXi 习猪下台 习下台 蹄防 影子末帝 习总输记 读书单 Mr##Shithole 毛二世 赵付 习二坐船 老街 electron8964 毛进平 中国离岸隐匿资产管理工作领导小组组组长 维尼写史 外交习语 支那精神野爹 习屎黄 现任匪首 武汉委托李克强 Corona##Xi（习病毒） 总统包子习 习教父 称帝修宪 腊肉包 没有网络安全就没有国家安全 狙击手布阵 倒车 “皇帝梦” 赵人13 骑巨龙 口罩外交 维尼史 裸宽包子劾心 尊蛤讨包 习二卒 普习金 役民五术 独彩者 习皇帝 赵王 习殡法 中国爱非洲 世宗 不同意的举手##没有##没有 学包率 毛装 Adolf##Xitler 习言乱语 支那毒王 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ “登基” 任志强 习像章 形式主义防疫 习卒习 裹嘎举吸钢闸门 平&强 任大炮 shit禁评 中国的新皇帝 劝进 刁大犬 vop 武统时代 梦回大清 习背书 迈克尔·索伊 XDD 送礼平 一天游泳一千米 习索里尼 习总 氼兲嫑炛 刁人13 我是一个足球迷 仲夏夜之中国梦 糟糕皇帝 习大帝 包子露宪 战“疫”金句 叩谢习恩 习太孑 亲自封号 袁世凯第二 维尼快乐组织（Winnie##Happy##Organization）简称WHO 宰相 64岁 720事件 通商宽衣 字共狗 刁近猴 法外狂徒Lucy（德国） 终身领导人 做N届的主席 东方project 视频看望 virus##king 北京中南海支部书记 冲塔 小学博士 翡翠娘娘 包子兵法 习夶 崇祯 墨索里习 习习蛤蛤 习king 习蛤 第一书记王沪宁 庆丰废物 习匪 重地之战 神明论 禁评封号 习大犬 人民战争 十日文革 维尼熊 黑白翠 习三点 戴口赵 彩色熊 习近平光辉形象 十一郎习近平 乳制品 添宪宝宝 信女愿一生吃素 习卒 20000T麦子 梁家河 习##卡##巴##卡 修宪 腊肉馅儿包子 戏包皮 云视察 白猪 习王的田野上 乳包文化 感恩教育 刁后主 九大诉求 满脸喷粪 亲自指挥疫情 禁评大帝 清华毕业 维尼大帝 国王 孢 习付 太祖兔 维尼DISCO 秦城监狱 祈翠語言包 */
package com.pcdd.sonovel.action;

import cn.hutool.core.comparator.VersionComparator;
import cn.hutool.core.io.FileUtil;
import cn.hutool.core.io.StreamProgress;
import cn.hutool.core.lang.Console;
import cn.hutool.core.util.StrUtil;
import cn.hutool.http.Header;
import cn.hutool.http.HttpResponse;
import cn.hutool.http.HttpUtil;
import cn.hutool.json.JSONArray;
import cn.hutool.json.JSONObject;
import cn.hutool.json.JSONUtil;
import cn.hutool.setting.dialect.Props;
import cn.hutool.system.OsInfo;
import cn.hutool.system.SystemUtil;
import com.pcdd.sonovel.util.ConfigUtils;
import com.pcdd.sonovel.util.FileUtils;
import com.pcdd.sonovel.util.RandomUA;
import me.tongfei.progressbar.ProgressBar;
import me.tongfei.progressbar.ProgressBarStyle;

import java.io.File;

import static org.fusesource.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2024/11/10
 */
public class CheckUpdateAction {

    public static final String GHP = "https://ghproxy.net/";
    public static final String RELEASE_URL = "https://api.github.com/repos/freeok/so-novel/releases";
    public static final String ASSETS_URL = "https://github.com/freeok/so-novel/releases/download/{}/sonovel-{}.tar.gz";
    private final int timeoutMills;

    public CheckUpdateAction() {
        this.timeoutMills = 5_000;
    }

    public CheckUpdateAction(int timeout) {
        this.timeoutMills = timeout;
    }

    public void execute() {
        Console.log("<== 检查更新中...");

        try (HttpResponse resp = HttpUtil.createGet(RELEASE_URL)
                .timeout(timeoutMills)
                .header(Header.USER_AGENT, RandomUA.generate())
                .execute()) {

            Props sys = ConfigUtils.sys();
            String jsonStr = resp.body();
            JSONArray arr = JSONUtil.parseArray(jsonStr);
            JSONObject latest = JSONUtil.parseObj(arr.get(0));
            // v1.7.0-beta.2
            String currentVersion = ("v" + sys.getStr("version"));
            // v1.7.0
            String latestVersion = latest.get("tag_name", String.class);
            String latestUrl = latest.get("html_url", String.class);

            if (VersionComparator.INSTANCE.compare(currentVersion, latestVersion) < 0) {
                Console.log("<== 发现新版本: {} ({})", latestVersion, latestUrl);
                download(getDownloadUrl(latestVersion));
            } else {
                Console.log("<== {} 已是最新版本！({})", latestVersion, latestUrl);
            }
        } catch (Exception e) {
            Console.log(render("\n<== 更新失败，当前网络环境无法访问 GitHub，请稍后再试 ({})", "red"), e.getMessage());
        }
    }

    private String getDownloadUrl(String version) {
        OsInfo osInfo = SystemUtil.getOsInfo();
        String osName = osInfo.getName();
        String arch = osInfo.getArch();
        String fileName = "windows";

        if (osName.contains("Windows")) {
            fileName = "windows";
        } else if (osName.contains("Mac")) {
            // 根据架构进一步细分
            fileName = "aarch64".equals(arch) ? "macos_arm64" : "macos_x64";
        } else if (osName.contains("Linux")) {
            fileName = "linux";
        }

        return GHP + StrUtil.format(ASSETS_URL, version, fileName);
    }

    private void download(String url) {
        // 预获取文件大小
        long fileSize = FileUtils.fileSize(url);
        // 设置进度条
        ProgressBar bar = ProgressBar.builder()
                .setTaskName("Downloading new version")
                .setInitialMax(fileSize)
                .setStyle(ProgressBarStyle.ASCII)
                .setMaxRenderedLength(100)
                .setUpdateIntervalMillis(10)
                .build();
        //  下载到上一级路径
        File file = new File(System.getProperty("user.dir")).getParentFile();

        // 带进度显示的文件下载
        HttpUtil.downloadFile(url, file, new StreamProgress() {
            @Override
            public void start() {
                bar.setExtraMessage("Downloading ...");
            }

            @Override
            public void progress(long total, long read) {
                // 更新进度条
                bar.stepTo(read);
            }

            @Override
            public void finish() {
                bar.setExtraMessage("Done!");
            }
        });

        bar.close();
        Console.log("<== 下载位置: {}", file + File.separator + FileUtil.getName(url));
    }

}