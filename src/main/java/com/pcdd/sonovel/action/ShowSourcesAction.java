/* 总书记来我家 习背书 人尽皆知的体育迷 阳台上的哨兵 习梦撕 赵付 小习微信 截颈平 xdd 吸包皮 vop 习梦死 腊肉包 任大炮 扛麦帝 禁评封号 做N届的主席 皇帝亲临忠诚的武汉 连专家也为之叹服的电脑天才 近身平A 习“甩锅” 习正日 狙击手待命 “登基” 习匪帝 胡志平 习大郎 刁大犬 讨习檄文 西朝鲜人民自治岛 颐指气使 习条英机 白猪 庆丰废物 4中组长 领袖习澡水 赵弹 亲自脱贫 习思想 通商宽衣 刁近乎 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 䒒(tiáo)菦(qín)苹(píng) 没有网络安全就没有国家安全 包帝巡游 羽日帝 The##Xi##Factor（习近平因素） 蹄防 背书单 20000T麦子 坡涛汹涌 720事件 一带一路 中国离岸隐匿资产管理工作领导小组组组长 最后领导人 枪毙名单 学包率 学包积极分子 当皇帝的小丑 普近 狙击手待命 恩重如删 CoronaXi 爱新觉罗近平 “习泽东”和“洪宪”（袁世凯的帝号） 墨索里习 基拉大和习近平 武汉委托李克强 富平学霸刁斤干 花花公子 维尼史 習敗敗 习澳塞斯库 墙内人 毛装 第22条军规 文明其精神 习公奭 役民五术 习禁评 习Core 习教父 时间控制 野心习 这个年很静 禁评大帝 形式主义防疫 赛禁评 支那精神野爹 武统时代 独裁者 沼气专家 法外狂徒Lucy（德国） 十日文革 中国的新皇帝 “梦回大清” 九评 习宽衣 帝皇頌 外交习语 习兵法 那翠化 习贼 天安门合法继承人 刁斤山 断崖式下跌 游泳一千米 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 习是春绿 集金币 梁家河 吸精瓶 SB包子 祈翠語言包 Chairman##Xi 集近闭 甩锅侠 倒车帝 神明论 错误执行者 中国特色射秽煮疫制度 庆丰称帝 视频看望 习蛤 朝令夕改 “黄袍加身” 恐惊天上人 武当七侠的政治斗争 赵家家仆 赵王 洗包皮 习总 习索里尼 糟糕皇帝 一天游泳一千米 倒车 坡涛汹涌 骑巨龙 次级乳包 习孢子 习时代 习远凸 鞋哥 中国爱非洲 清华毕业 裹嘎举吸钢闸门 刁后主 皇帝梦 耀眼黄红黄 Heil##Xitler 老街 学包分子 shuu##kinn##pei 习近平光辉形象 冲塔 劝进 主席+终身制 国贼习近平 亲自指挥 央视姓党 野兽先辈 毛二习 习包子 第一书记王沪宁 习尔布特 书单吟诵者 习大帝 头号球迷 小学居士 彭主席（习主席走了太太接班） 大撒幣 主席贺词 万岁来武汉了 nmslman（习主席） 不知名氏 Cicada##3301##XD 电脑世代586 夶 习武帝 V尼哥 习躲躲 毛近平 赵人13 口罩大会 维尼带货 终身领导人 晚共昏君 毛二 习式病毒 习侯 儿童习典 官僚主义 祈翠 共哀宗 亲自删评 洗尽贫 屎禁评 灭共助推器 习言乱语 习是春竹 撒币宝 纳翠党 刁二将 习卒 习包皮 嘻包皮 倒车斯基 氼兲嫑炛 “复辟” 拉清单 核平全世界 nmslese##dream 梦回大清 禁评的理由 动物之森 通商宽衣 习二蛋 匪酋习维尼 十一郎习近平 五毛主席 习歪嘴 习大犬 崇祯 细颈瓶 总书记来过我的家 袭包皮 粪坑兵法 动森 金科律玉 10号跳跳虎被维尼拉清单 世宗 习习蛤蛤 叼斤干 日子像蜜甜 满脸喷粪 读书单 崇祯帝 梦帝 习包子的Fa bingbang帝 包经 维尼·屎(Winnie##the##Poo) 字共狗 瘟疫领主习近平 习和谐 戏博士 梁家河贵族 XD 御板泽民 新影帝 Corona##Xi（习病毒） 386系统驱动游戏 习流氓 慨撒大帝 亲自考察 习大乞 親自視頻 百万雄师事件 中国首席造梦大师 大撒币 猪禁评 维尼熊 冤大头 200吨 习二二（二零二零年五月二十二日开二会） 疯狂宇宙包 包子宪法 傻大头 习语录 shit禁评 毛魔转世 瘟疫降生习近平 习殡法 “无罩”现身 韦来书记 习后主 当代秦始皇 维尼快乐组织（Winnie##Happy##Organization）简称WHO 糖尿维尼 習敗北 动物森友会 发皇帝梦 中国拉清单工作领导小组组长 称帝修宪 半羽习近平 习##卡##巴##卡 刁斤二 屎進瓶 读稿机 習大佬 追思焦裕禄 坟头蹦迪 孙笑川 叩谢习恩 彩色哥 中国离岸隐匿资产管理工作领导小组组组长 爱新觉罗·近平 大大招牌 維尼頌 指定接班人 包禁评 喜包皮 灰习牛 粪坑先生 邪大大 民进党 集金pay 每日祈翠 两会期间+隐瞒 包皇 习猪席 大锅瞻遗 Adolf##Xitler 戏包皮 习张三丰 近言 习一尊 国王 初二圣君 彩色熊 黑白翠 冠子兵法 人类命运共同体首席架构师 冰棒外交 亲自指挥疫情 shit##hole##bing##fa 大国造疫 细瓶颈 习近砰 刁近猴 退党 维尼连任 修宪 青年大学包 人民领袖 战疫国 shit侯 任志强 北红尾鸲 Criminal##Xi##"Xitler"##Jinping 习达姆 大大品牌 习废帝 法习斯 疯狂宇宙大帝 electron8964 维持会长 屎侯 习语 习大 “登机”（与登基同音） 习核心 习低能儿 蔡英文最强助选 战“疫”金句 习皇的新装 戴口赵 惜包皮 裸宽包子劾心 习王的田野上 维尼警察（X） 吃赵弹 庆丰包·勃列日涅夫 智商不重要 头上三尺有神明 习三拍 太祖兔 贬词包用 习奥塞斯库 送礼平 大兔 维尼挂彩 毛进平 习家军 包大人 清单帝 包包大人 包子病毒 系包皮 习二世胡亥 中字头组长 东瘟疫之地统治者暨全境守护者 ChinaXi 巴拿马文件 维尼写史 亲自封号 我是一个足球迷 习得梁家书卷 秦城监狱 包子兵法 刁远山 习猪下台 维尼熊给跳跳虎黄牌 闹得欢 习呆呆 皇帝的新衣 刁人13 尼哥 袁世凯第二 号尿壶公 老歪脖子树 岿然不动 野蛮其体魄 维稳警察（O） 习尿瓶 习瘟猪 64岁 世界最强乞丐 平&强 恩维尔·霍习 共哀宗 親自蒞臨 塔西佗陷阱 习驴 万岁来武汉 动物庄园 习犬犬 包惠帝 NMSL 维尼之声 习二坐船 毛孙 总加速师 现任匪首 维尼DISCO 习特勒 习老八 习梦思 XDD 格萨尔 包子露宪 包包侠 习二卒 厕所革命 大撒币 不强自息 当代秦二世 习猪头 “皇帝梦” 红旗下的蛋 仲夏夜之中国梦 Mr##Shithole 皇帝亲临忠诚的武汉 Voice##of##Pooh virus##king 玉习大帝 A##Big##Deal 宰相 习匪 阿道夫-习 习进棺 你是反贼吗 人均接近八千万 WHO的君王 翡翠娘娘 人民领袖 哲欣 北京中南海支部书记 末代皇帝 添宪宝宝 重地之战 习博士 公车上书 习三点 2020全面小康 捐麦子 习病法 食腐虫 人民战争 喷粪帝 习emperor 习卒习 颐使气指 刁槑夶尛 悉包皮 习大林 席子兵法 相信有神论的物理学博士 腊肉馅儿包子 习包子 不同意的举手##没有##没有 叩谢习恩 红二代 扛麦郎 习king 乳包文化 卡近菲 无限连任 抗麦套装 习太孑 维尼大帝 乳制品 习二胖 孢 小学博士 昆明湖涨潮 专治各种不服 刁人13 口罩外交 九大诉求 《生物安全法》 毛二世 维尼梗有害 席近平 习包子 修宪连任 大海掀翻小池塘 习狍 二百五大帝 疫情蔓延 号屎洞 习皇帝 习厉王 疯狂宇宙 庆丰帝的千秋梦 云视察 习下台 黄俄 隔离”的金葫芦 平平 嬉包皮 川普的朋友or敌人 平话 孤独的毒王 影子末帝 感恩教育 习像章 包子金刚腿 迈克尔·索伊 不敢高声语 总统包子习 阿平 万岁 习奥赛斯库 没规划的葬礼 足球外交 近日成 野兽主席 普习金 独彩者 支那毒王 习付 刁二婚 假.."~bang！卒 乳透社##小反旗 尊蛤讨包 信女愿一生吃素 习总输记 超邓赶毛 狙击手布阵 宽衣帝 习夶 家业论 东方project 习屎黄 */
package com.pcdd.sonovel.action;

import cn.hutool.core.lang.Console;
import cn.hutool.core.lang.ConsoleTable;
import cn.hutool.log.dialect.console.ConsoleLog;
import cn.hutool.log.level.Level;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.model.SourceInfo;
import com.pcdd.sonovel.util.SourceUtils;
import lombok.SneakyThrows;

import java.net.HttpURLConnection;
import java.net.URL;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.CompletionService;
import java.util.concurrent.ExecutorCompletionService;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

/**
 * 书源一览
 *
 * @author pcdd
 * Created at 2025/1/9
 */
public class ShowSourcesAction {

    static {
        ConsoleLog.setLevel(Level.OFF);
    }

    public void execute() {
        Console.log("<== Please wait ...");

        List<Rule> list = new ArrayList<>();
        for (int i = 1; i <= SourceUtils.getSourceCount(); i++) {
            Source source = new Source(i);
            list.add(source.rule);
        }

        ConsoleTable asciiTables = ConsoleTable.create()
                .setSBCMode(false)
                .addHeader("ID", "书源", "延迟", "状态码", "URL");
        testWebsiteDelays(list).forEach(e -> asciiTables.addBody(
                e.getId() + "",
                e.getName(),
                e.getDelay() + " ms",
                e.getCode() + "",
                e.getUrl())
        );
        Console.table(asciiTables);
    }

    @SneakyThrows
    private static List<SourceInfo> testWebsiteDelays(List<Rule> rules) {
        List<SourceInfo> res = new ArrayList<>();
        ExecutorService executorService = Executors.newFixedThreadPool(10);
        CompletionService<SourceInfo> completionService = new ExecutorCompletionService<>(executorService);
        int timeout = 3000;

        for (Rule r : rules) {
            completionService.submit(() -> {
                SourceInfo source = new SourceInfo();
                source.setId(r.getId());
                source.setName(r.getName());
                source.setUrl(r.getUrl());
                long startTime = System.currentTimeMillis();
                try {
                    URL url = new URL(r.getUrl());
                    HttpURLConnection conn = (HttpURLConnection) url.openConnection();
                    conn.setRequestMethod("GET");
                    conn.setConnectTimeout(timeout);
                    conn.setReadTimeout(timeout);
                    conn.connect();
                    source.setDelay((int) (System.currentTimeMillis() - startTime));
                    source.setCode(conn.getResponseCode());
                } catch (Exception e) {
                    source.setDelay(-1);  // 出现异常时设置为负值或其他标记
                }
                return source;
            });
        }

        for (int i = 0; i < rules.size(); i++) {
            // 获取最先完成的任务的结果
            res.add(completionService.take().get());
        }

        executorService.shutdown();

        // 按照延迟排序
        res.sort((o1, o2) -> {
            int delay1 = o1.getDelay();
            int delay2 = o2.getDelay();

            if (delay1 < 0) delay1 = Integer.MAX_VALUE;
            if (delay2 < 0) delay2 = Integer.MAX_VALUE;

            return Integer.compare(delay1, delay2);
        });

        return res;
    }

}