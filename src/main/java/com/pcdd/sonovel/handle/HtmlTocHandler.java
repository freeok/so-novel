/* 重地之战 习尔布特 狙击手待命 bingbang帝 维尼快乐组织（Winnie##Happy##Organization）简称WHO 袁世凯第二 慨撒大帝 WHO的君王 当皇帝的小丑 总书记来过我的家 梦帝 Chairman##Xi 半羽习近平 刁远山 天安门合法继承人 两会期间+隐瞒 CoronaXi 胡志平 习尿瓶 习包子 大锅瞻遗 SB包子 戏包皮 冤大头 人民领袖 老街 野兽先辈 习奥赛斯库 初二圣君 儿童习典 做N届的主席 塔西佗陷阱 习包皮 庆丰称帝 習敗北 终身领导人 维尼写史 中国特色射秽煮疫制度 习躲躲 扛麦帝 习博士 现任匪首 习蛤 包经 吸精瓶 世界最强乞丐 十一郎习近平 毛进平 一天游泳一千米 腊肉馅儿包子 万岁来武汉 毛二 倒车帝 枪毙名单 捐麦子 习匪帝 爱新觉罗·近平 包子兵法 冠子兵法 习呆呆 秦城监狱 䒒(tiáo)菦(qín)苹(píng) 习驴 撒币宝 相信有神论的物理学博士 习一尊 近言 Voice##of##Pooh 習敗敗 学包分子 东方project 包禁评 洗尽贫 梦回大清 习禁评 nmslese##dream 野蛮其体魄 不敢高声语 耀眼黄红黄 习总 傻大头 刁后主 习澳塞斯库 青年大学包 梁家河 动森 书单吟诵者 普习金 中国离岸隐匿资产管理工作领导小组组组长 2020全面小康 习“甩锅” 武当七侠的政治斗争 次级乳包 乳透社##小反旗 家业论 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 红二代 习贼 习三拍 习包子 维尼DISCO 戴口赵 习王的田野上 习屎黄 席近平 国王 “黄袍加身” 习是春绿 Corona##Xi（习病毒） 习emperor 赵付 习皇帝 影子末帝 太祖兔 岿然不动 习废帝 乳制品 云视察 帝皇頌 祈翠語言包 灭共助推器 中国的新皇帝 修宪连任 蔡英文最强助选 口罩大会 习大林 維尼頌 东瘟疫之地统治者暨全境守护者 习三点 战“疫”金句 习条英机 nmslman（习主席） 亲自脱贫 戏博士 皇帝的新衣 赵家家仆 国贼习近平 平话 习猪席 亲自考察 无限连任 崇祯帝 断崖式下跌 读稿机 花花公子 《生物安全法》 央视姓党 ChinaXi 嘻包皮 习二坐船 “梦回大清” 习太孑 阿道夫-习 总书记来我家 富平学霸刁斤干 恐惊天上人 讨习檄文 游泳一千米 崇祯 尼哥 阳台上的哨兵 叩谢习恩 人民领袖 刁斤二 大大招牌 维尼熊 包皇 日子像蜜甜 毛魔转世 哲欣 当代秦二世 翡翠娘娘 大撒幣 黑白翠 中国爱非洲 习式病毒 大撒币 野心习 武汉委托李克强 背书单 10号跳跳虎被维尼拉清单 任大炮 维尼熊给跳跳虎黄牌 平平 A##Big##Deal 习卒 核平全世界 electron8964 迈克尔·索伊 shuu##kinn##pei 字共狗 中国首席造梦大师 基拉大和习近平 习病法 毛孙 赛禁评 不强自息 甩锅侠 习老八 瘟疫降生习近平 主席+终身制 系包皮 习梦死 猪禁评 维尼梗有害 刁二婚 神明论 支那毒王 退党 电脑世代586 人均接近八千万 拉清单 喜包皮 “复辟” 袭包皮 送礼平 习瘟猪 维尼之声 Heil##Xitler 习张三丰 糟糕皇帝 shit禁评 腊肉包 昆明湖涨潮 截颈平 五毛主席 习king 末代皇帝 维尼挂彩 民进党 200吨 当代秦始皇 十日文革 习总输记 法习斯 足球外交 超邓赶毛 洗包皮 庆丰包·勃列日涅夫 狙击手待命 匪酋习维尼 公车上书 彩色哥 世宗 添宪宝宝 习家军 习大帝 闹得欢 卡近菲 习下台 亲自删评 总统包子习 習大佬 习Core 平&强 親自蒞臨 包子宪法 shit##hole##bing##fa 坡涛汹涌 羽日帝 金科律玉 刁二将 习夶 头上三尺有神明 梁家河贵族 720事件 “登机”（与登基同音） 格萨尔 大国造疫 习侯 庆丰废物 玉习大帝 追思焦裕禄 晚共昏君 清单帝 包包大人 百万雄师事件 吃赵弹 一带一路 总加速师 最后领导人 粪坑先生 习达姆 夶 裸宽包子劾心 virus##king 读书单 Criminal##Xi##"Xitler"##Jinping 视频看望 孤独的毒王 共哀宗 修宪 瘟疫领主习近平 vop 皇帝亲临忠诚的武汉 普近 习猪下台 大撒币 XD 席子兵法 习包子 任志强 形式主义防疫 64岁 红旗下的蛋 颐使气指 口罩外交 习二世胡亥 人尽皆知的体育迷 包帝巡游 习近砰 习包子的Fa 大海掀翻小池塘 习进棺 习宽衣 韦来书记 包子金刚腿 毛二习 刁大犬 动物森友会 NMSL 阿平 维尼带货 近身平A 学包率 习二二（二零二零年五月二十二日开二会） 习皇的新装 习梦思 “习泽东”和“洪宪”（袁世凯的帝号） “无罩”现身 大兔 人民战争 川普的朋友or敌人 习流氓 赵弹 这个年很静 战疫国 第一书记王沪宁 习后主 习近平光辉形象 习言乱语 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 御板泽民 习像章 shit侯 不知名氏 习二胖 刁近乎 连专家也为之叹服的电脑天才 刁斤山 包大人 习大犬 错误执行者 厕所革命 发皇帝梦 墨索里习 宽衣帝 亲自封号 时间控制 习得梁家书卷 我是一个足球迷 二百五大帝 巴拿马文件 官僚主义 习思想 疫情蔓延 屎進瓶 Adolf##Xitler 习低能儿 倒车 假.."~bang！卒 集金pay 习武帝 刁人13 疯狂宇宙包 氼兲嫑炛 九大诉求 集近闭 亲自指挥疫情 禁评封号 习索里尼 赵王 皇帝亲临忠诚的武汉 西朝鲜人民自治岛 “皇帝梦” 中国拉清单工作领导小组组长 包包侠 赵人13 灰习牛 老歪脖子树 万岁来武汉了 小学居士 没规划的葬礼 维尼连任 禁评大帝 万岁 感恩教育 大大品牌 小习微信 近日成 习梦撕 恩重如删 习大乞 劝进 倒车斯基 集金币 维稳警察（O） 孙笑川 习兵法 习二蛋 习是春竹 习语录 亲自指挥 习##卡##巴##卡 习孢子 你是反贼吗 沼气专家 人类命运共同体首席架构师 习大 领袖习澡水 毛二世 习狍 嬉包皮 彩色熊 糖尿维尼 习奥塞斯库 邪大大 共哀宗 文明其精神 黄俄 维持会长 仲夏夜之中国梦 维尼·屎(Winnie##the##Poo) 智商不重要 没有网络安全就没有国家安全 386系统驱动游戏 野兽主席 庆丰帝的千秋梦 坡涛汹涌 Mr##Shithole 白猪 疯狂宇宙大帝 恩维尔·霍习 叼斤干 彭主席（习主席走了太太接班） 包子病毒 惜包皮 称帝修宪 朝令夕改 维尼警察（X） 习习蛤蛤 武统时代 爱新觉罗近平 维尼大帝 信女愿一生吃素 叩谢习恩 习厉王 毛装 习和谐 每日祈翠 刁近猴 习大郎 尊蛤讨包 XDD 贬词包用 习背书 习犬犬 通商宽衣 满脸喷粪 北京中南海支部书记 习二卒 习特勒 习卒习 习远凸 Cicada##3301##XD 骑巨龙 习语 抗麦套装 习正日 刁人13 屎侯 外交习语 清华毕业 “登基” 中字头组长 专治各种不服 习匪 疯狂宇宙 不同意的举手##没有##没有 坟头蹦迪 The##Xi##Factor（习近平因素） 小学博士 皇帝梦 习猪头 九评 号尿壶公 头号球迷 独裁者 禁评的理由 食腐虫 北红尾鸲 细颈瓶 指定接班人 喷粪帝 冰棒外交 主席贺词 纳翠党 乳包文化 动物庄园 习教父 习时代 通商宽衣 包惠帝 屎禁评 独彩者 中国离岸隐匿资产管理工作领导小组组组长 4中组长 那翠化 习歪嘴 习付 毛近平 冲塔 粪坑兵法 颐指气使 xdd 墙内人 悉包皮 号屎洞 习核心 扛麦郎 维尼史 新影帝 親自視頻 习公奭 细瓶颈 支那精神野爹 第22条军规 习殡法 狙击手布阵 蹄防 鞋哥 宰相 孢 祈翠 法外狂徒Lucy（德国） 学包积极分子 裹嘎举吸钢闸门 隔离”的金葫芦 役民五术 刁槑夶尛 动物之森 20000T麦子 包子露宪 V尼哥 吸包皮 */
package com.pcdd.sonovel.handle;

import cn.hutool.core.io.FileUtil;
import cn.hutool.core.io.file.FileReader;
import cn.hutool.core.io.file.FileWriter;
import cn.hutool.core.lang.Console;
import cn.hutool.core.util.ReUtil;
import cn.hutool.core.util.StrUtil;
import cn.hutool.http.HttpUtil;
import com.pcdd.sonovel.model.Book;
import com.pcdd.sonovel.util.FileUtils;

import java.io.File;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;

/**
 * @author pcdd
 * Created at 2024/12/4
 */
public class HtmlTocHandler implements PostProcessingHandler {

    @Override
    public void handle(Book book, File saveDir) {
        List<String> strings = new ArrayList<>();
        String regex = "<title>(.*?)</title>";

        strings.add("文件名\t\t章节名");
        List<File> files = FileUtils.sortFilesByName(saveDir);
        int i = Integer.parseInt(StrUtil.subBefore(files.get(0).getName(), "_", false));
        for (File file : files) {
            FileReader fr = FileReader.create(file, StandardCharsets.UTF_8);
            // 获取 <title> 内容
            String title = ReUtil.getGroup1(regex, fr.readString());
            strings.add(StrUtil.format("{}_.html\t\t{}", i++, title));
        }

        File file = FileUtil.touch(saveDir + File.separator, "0_目录.txt");
        FileWriter fw = FileWriter.create(file, StandardCharsets.UTF_8);
        fw.writeLines(strings);

        Console.log("<== 正在下载封面：{}", book.getCoverUrl());
        File coverFile = HttpUtil.downloadFileFromUrl(book.getCoverUrl(), System.getProperty("user.dir") + File.separator + saveDir);
        FileUtil.rename(coverFile, "0_封面." + FileUtil.getType(coverFile), true);
    }

}