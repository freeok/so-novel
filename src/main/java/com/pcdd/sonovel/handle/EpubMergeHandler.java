/* 沼气专家 亲自封号 清华毕业 习废帝 满脸喷粪 亲自指挥 刁大犬 习大林 刁二婚 庆丰帝的千秋梦 维尼警察（X） 赵人13 刁人13 彩色哥 那翠化 氼兲嫑炛 家业论 冰棒外交 瘟疫降生习近平 习犬犬 外交习语 狙击手待命 中国首席造梦大师 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 习屎黄 武汉委托李克强 毛魔转世 亲自考察 阳台上的哨兵 集金币 人均接近八千万 清单帝 习Core 视频看望 书单吟诵者 口罩大会 九大诉求 法外狂徒Lucy（德国） 习式病毒 第22条军规 shit##hole##bing##fa 习一尊 洗包皮 悉包皮 西朝鲜人民自治岛 毛二世 electron8964 次级乳包 共哀宗 包子宪法 戴口赵 游泳一千米 主席贺词 云视察 习包子 太祖兔 袁世凯第二 维尼熊 中国拉清单工作领导小组组长 花花公子 习低能儿 毛进平 感恩教育 指定接班人 nmslman（习主席） 学包积极分子 习二世胡亥 领袖习澡水 发皇帝梦 通商宽衣 习是春竹 倒车 终身领导人 动物庄园 现任匪首 宰相 親自蒞臨 习下台 皇帝亲临忠诚的武汉 习时代 习##卡##巴##卡 “无罩”现身 习梦思 习二胖 纳翠党 尼哥 习歪嘴 刁远山 刁槑夶尛 阿平 皇帝梦 电脑世代586 鞋哥 头上三尺有神明 习是春绿 习大帝 习远凸 疯狂宇宙大帝 xdd 你是反贼吗 习张三丰 维尼连任 富平学霸刁斤干 习呆呆 叼斤干 习卒 第一书记王沪宁 号尿壶公 中国特色射秽煮疫制度 傻大头 基拉大和习近平 习大乞 席子兵法 哲欣 亲自指挥疫情 大撒币 玉习大帝 墨索里习 习公奭 核平全世界 裹嘎举吸钢闸门 民进党 粪坑先生 nmslese##dream virus##king 独裁者 大兔 粪坑兵法 屎侯 追思焦裕禄 习核心 维尼写史 习武帝 仲夏夜之中国梦 做N届的主席 恩重如删 冲塔 嘻包皮 央视姓党 厕所革命 《生物安全法》 最后领导人 席近平 习匪帝 爱新觉罗·近平 习教父 习王的田野上 Heil##Xitler 屎進瓶 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 大锅瞻遗 川普的朋友or敌人 末代皇帝 当代秦二世 大大品牌 普近 包惠帝 疯狂宇宙 隔离”的金葫芦 bingbang帝 shuu##kinn##pei 袭包皮 颐指气使 慨撒大帝 习言乱语 禁评封号 Voice##of##Pooh 孙笑川 习宽衣 200吨 支那毒王 维尼大帝 包包侠 刁后主 亲自脱贫 习匪 背书单 “登基” 习付 恐惊天上人 刁近乎 共哀宗 蔡英文最强助选 晚共昏君 10号跳跳虎被维尼拉清单 “黄袍加身” 韦来书记 毛孙 WHO的君王 Adolf##Xitler 大撒币 维尼DISCO 习猪席 添宪宝宝 修宪连任 二百五大帝 祈翠語言包 百万雄师事件 维持会长 儿童习典 昆明湖涨潮 恩维尔·霍习 武统时代 “梦回大清” 撒币宝 维尼带货 习后主 吸包皮 包禁评 主席+终身制 习近平光辉形象 天安门合法继承人 人类命运共同体首席架构师 不知名氏 毛近平 一天游泳一千米 习索里尼 吸精瓶 习皇的新装 拉清单 当皇帝的小丑 梁家河贵族 习习蛤蛤 动森 维尼挂彩 人民领袖 习尔布特 金科律玉 读书单 嬉包皮 吃赵弹 包经 屎禁评 包皇 万岁 习博士 习大 习正日 习总 习大犬 包帝巡游 野心习 狙击手布阵 半羽习近平 迈克尔·索伊 赵家家仆 中国离岸隐匿资产管理工作领导小组组组长 小习微信 “皇帝梦” 十一郎习近平 Cicada##3301##XD 修宪 东方project 灭共助推器 捐麦子 细瓶颈 错误执行者 专治各种不服 习“甩锅” 习语录 字共狗 XDD 巴拿马文件 习蛤 任大炮 刁斤山 扛麦郎 刁近猴 这个年很静 当代秦始皇 坡涛汹涌 乳包文化 习卒习 大大招牌 惜包皮 親自視頻 世宗 赛禁评 386系统驱动游戏 不同意的举手##没有##没有 习老八 叩谢习恩 超邓赶毛 胡志平 黄俄 人民领袖 扛麦帝 野蛮其体魄 “复辟” shit禁评 乳制品 习奥赛斯库 万岁来武汉了 裸宽包子劾心 官僚主义 红旗下的蛋 每日祈翠 狙击手待命 倒车斯基 坡涛汹涌 梁家河 习澳塞斯库 闹得欢 亲自删评 彩色熊 战“疫”金句 戏博士 灰习牛 vop 尊蛤讨包 通商宽衣 习大郎 习躲躲 洗尽贫 讨习檄文 猪禁评 朝令夕改 习尿瓶 总书记来我家 匪酋习维尼 习侯 习包子 赵付 战疫国 禁评的理由 维尼熊给跳跳虎黄牌 邪大大 习流氓 毛装 包大人 小学博士 祈翠 习二二（二零二零年五月二十二日开二会） 信女愿一生吃素 中字头组长 习二卒 学包率 东瘟疫之地统治者暨全境守护者 疫情蔓延 习进棺 白猪 习兵法 爱新觉罗近平 习思想 习家军 习达姆 NMSL 没有网络安全就没有国家安全 大海掀翻小池塘 冠子兵法 ChinaXi 万岁来武汉 喜包皮 維尼頌 集金pay 帝皇頌 退党 任志强 习皇帝 独彩者 动物之森 习厉王 赵王 野兽主席 普习金 包子金刚腿 崇祯 九评 文明其精神 腊肉包 形式主义防疫 腊肉馅儿包子 乳透社##小反旗 坟头蹦迪 习病法 习emperor 人尽皆知的体育迷 习梦死 庆丰废物 十日文革 2020全面小康 维稳警察（O） The##Xi##Factor（习近平因素） 不强自息 习禁评 维尼史 习三拍 维尼之声 习二坐船 相信有神论的物理学博士 枪毙名单 4中组长 北京中南海支部书记 初二圣君 近言 我是一个足球迷 20000T麦子 皇帝的新衣 骑巨龙 塔西佗陷阱 SB包子 习贼 中国离岸隐匿资产管理工作领导小组组组长 贬词包用 格萨尔 习包子 老街 头号球迷 耀眼黄红黄 “登机”（与登基同音） 近身平A 习条英机 集近闭 赵弹 习太孑 習大佬 宽衣帝 夶 习三点 平话 冤大头 CoronaXi 720事件 戏包皮 崇祯帝 习梦撕 学包分子 Criminal##Xi##"Xitler"##Jinping 习和谐 习近砰 读稿机 XD 役民五术 维尼梗有害 习瘟猪 习殡法 蹄防 毛二 野兽先辈 64岁 包子病毒 墙内人 梦回大清 孤独的毒王 糖尿维尼 shit侯 Corona##Xi（习病毒） 新影帝 日子像蜜甜 总书记来过我的家 一带一路 羽日帝 大国造疫 卡近菲 皇帝亲临忠诚的武汉 习king 习孢子 习语 食腐虫 习猪下台 糟糕皇帝 两会期间+隐瞒 習敗北 法习斯 刁斤二 细颈瓶 庆丰称帝 习得梁家书卷 习奥塞斯库 甩锅侠 岿然不动 倒车帝 劝进 影子末帝 颐使气指 平&强 小学居士 公车上书 习夶 神明论 包子兵法 阿道夫-习 北红尾鸲 智商不重要 不敢高声语 中国的新皇帝 青年大学包 重地之战 習敗敗 足球外交 庆丰包·勃列日涅夫 包子露宪 叩谢习恩 瘟疫领主习近平 刁人13 习特勒 习驴 习背书 翡翠娘娘 维尼·屎(Winnie##the##Poo) 总统包子习 总加速师 喷粪帝 动物森友会 近日成 䒒(tiáo)菦(qín)苹(píng) 中国爱非洲 大撒幣 口罩外交 截颈平 世界最强乞丐 习二蛋 没规划的葬礼 Chairman##Xi 疯狂宇宙包 “习泽东”和“洪宪”（袁世凯的帝号） 断崖式下跌 连专家也为之叹服的电脑天才 假.."~bang！卒 彭主席（习主席走了太太接班） 支那精神野爹 国贼习近平 习包皮 系包皮 五毛主席 V尼哥 习猪头 习像章 毛二习 时间控制 无限连任 称帝修宪 A##Big##Deal 御板泽民 刁二将 国王 包包大人 孢 Mr##Shithole 维尼快乐组织（Winnie##Happy##Organization）简称WHO 人民战争 红二代 梦帝 武当七侠的政治斗争 号屎洞 老歪脖子树 抗麦套装 黑白翠 秦城监狱 平平 禁评大帝 送礼平 习包子的Fa 习狍 习总输记 */
package com.pcdd.sonovel.handle;

import cn.hutool.core.io.FileUtil;
import cn.hutool.core.io.resource.ResourceUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.core.util.StrUtil;
import cn.hutool.http.HttpUtil;
import com.pcdd.sonovel.model.Book;
import com.pcdd.sonovel.util.FileUtils;
import io.documentnode.epub4j.domain.*;
import io.documentnode.epub4j.epub.EpubWriter;
import lombok.SneakyThrows;

import java.io.File;
import java.io.FileOutputStream;
import java.util.Date;
import java.util.List;

import static org.fusesource.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2024/12/4
 */
public class EpubMergeHandler implements PostProcessingHandler {

    public static final String COVER_NAME = "cover.html";

    @SneakyThrows
    @Override
    public void handle(Book b, File savePath) {
        if (FileUtil.isDirEmpty(savePath)) {
            Console.error(render("==> @|red 《{}》（{}）下载章节数为 0，取消生成 EPUB|@"), b.getBookName(), b.getAuthor());
            return;
        }

        io.documentnode.epub4j.domain.Book book = new io.documentnode.epub4j.domain.Book();
        // content.opf > metadata
        Metadata meta = book.getMetadata();
        meta.addTitle(b.getBookName());
        meta.setAuthors(List.of(new Author(b.getAuthor())));
        meta.addDescription(b.getIntro());
        // 下载封面失败会导致生成 epub 中断
        try {
            Console.log("<== 正在下载封面：{}", b.getCoverUrl());
            byte[] bytes = HttpUtil.downloadBytes(b.getCoverUrl());
            book.setCoverImage(new Resource(bytes, "cover.jpg"));
        } catch (Exception e) {
            Console.error(render("@|red 封面下载失败：{}|@"), e.getMessage());
        }
        // 不设置会导致 Apple Books 无法使用苹方字体
        meta.setLanguage("zh");
        meta.setDates(List.of(new io.documentnode.epub4j.domain.Date(new Date())));
        meta.addPublisher("so-novel");
        meta.setRights(List.of("本电子书由 so-novel(https://github.com/freeok/so-novel) 制作生成。仅供交流使用，不得用于商业用途。"));

        // content.opf > manifest
        List<File> files = FileUtils.sortFilesByName(savePath);
        int len = String.valueOf(files.size()).length();
        // 添加封面页
        book.addSection("封面", new Resource(ResourceUtil.readBytes("templates/chapter_cover.html"), COVER_NAME));
        // 添加正文页
        for (int i = 0; i < files.size(); i++) {
            File file = files.get(i);
            // 截取第一个 _ 后的字符串，即章节名
            String title = StrUtil.subAfter(FileUtil.mainName(file), "_", false);
            String id = StrUtil.padPre(String.valueOf(i + 1), len, '0');
            book.addSection(title, new Resource(id, FileUtil.readBytes(file), id + ".html", MediaTypes.XHTML));
        }

        // 设置 guide，用于指定封面
        book.getGuide().addReference(new GuideReference(new Resource(ResourceUtil.readBytes("templates/chapter_cover.html"), COVER_NAME), "封面", COVER_NAME));
        EpubWriter epubWriter = new EpubWriter();
        epubWriter.write(book, new FileOutputStream(StrUtil.format("{}/{}.epub", savePath.getParent(), b.getBookName())));
        FileUtil.del(savePath);
    }

}