/* 刁近猴 细瓶颈 共哀宗 SB包子 习皇帝 战“疫”金句 我是一个足球迷 中国的新皇帝 新影帝 屎禁评 叼斤干 “习泽东”和“洪宪”（袁世凯的帝号） 戴口赵 习是春竹 枪毙名单 维尼连任 包子露宪 花花公子 人民领袖 韦来书记 儿童习典 习厉王 维持会长 灭共助推器 纳翠党 Criminal##Xi##"Xitler"##Jinping 狙击手待命 冠子兵法 阿平 习猪下台 黄俄 XDD 二百五大帝 “登机”（与登基同音） 迈克尔·索伊 䒒(tiáo)菦(qín)苹(píng) 乳透社##小反旗 耀眼黄红黄 习像章 习包子 习尿瓶 习侯 小学博士 习二胖 公车上书 冲塔 领袖习澡水 习“甩锅” 阳台上的哨兵 习习蛤蛤 截颈平 慨撒大帝 倒车帝 御板泽民 最后领导人 北红尾鸲 nmslman（习主席） 卡近菲 Corona##Xi（习病毒） 现任匪首 习时代 任志强 維尼頌 维尼熊 当皇帝的小丑 习大乞 习兵法 习屎黄 清华毕业 疫情蔓延 祈翠語言包 野心习 太祖兔 戏博士 官僚主义 习武帝 十日文革 瘟疫降生习近平 维尼之声 邪大大 形式主义防疫 影子末帝 习家军 玉习大帝 学包率 习教父 庆丰帝的千秋梦 习二二（二零二零年五月二十二日开二会） 人民战争 世界最强乞丐 习废帝 中国离岸隐匿资产管理工作领导小组组组长 庆丰称帝 刁远山 劝进 禁评大帝 Voice##of##Pooh 孤独的毒王 第22条军规 习公奭 智商不重要 一带一路 vop CoronaXi 相信有神论的物理学博士 川普的朋友or敌人 人均接近八千万 “梦回大清” 刁人13 习大帝 没有网络安全就没有国家安全 WHO的君王 普近 人民领袖 核平全世界 大撒幣 动森 央视姓党 习进棺 习尔布特 洗尽贫 裹嘎举吸钢闸门 毛二 386系统驱动游戏 bingbang帝 战疫国 亲自封号 刁近乎 清单帝 十一郎习近平 九大诉求 悉包皮 闹得欢 武当七侠的政治斗争 主席贺词 支那毒王 号屎洞 习低能儿 任大炮 2020全面小康 野兽主席 小学居士 颐指气使 万岁 XD 第一书记王沪宁 重地之战 万岁来武汉 爱新觉罗·近平 亲自指挥疫情 总加速师 叩谢习恩 禁评封号 习近平光辉形象 大锅瞻遗 習敗北 法外狂徒Lucy（德国） 习禁评 习殡法 普习金 专治各种不服 习三拍 赵家家仆 红二代 发皇帝梦 Cicada##3301##XD 假.."~bang！卒 系包皮 习远凸 皇帝的新衣 中国离岸隐匿资产管理工作领导小组组组长 親自蒞臨 世宗 近言 读书单 习老八 感恩教育 游泳一千米 吃赵弹 通商宽衣 疯狂宇宙大帝 每日祈翠 嘻包皮 维尼带货 shit##hole##bing##fa 支那精神野爹 习孢子 皇帝梦 习包子的Fa 不同意的举手##没有##没有 巴拿马文件 终身领导人 灰习牛 维尼梗有害 包惠帝 动物庄园 天安门合法继承人 通商宽衣 習敗敗 金科律玉 坡涛汹涌 习king 厕所革命 糟糕皇帝 东瘟疫之地统治者暨全境守护者 东方project 习二坐船 墙内人 包禁评 尼哥 Chairman##Xi 神明论 格萨尔 A##Big##Deal 宽衣帝 口罩外交 民进党 恩重如删 刁斤二 维尼·屎(Winnie##the##Poo) 习猪头 4中组长 毛二习 习瘟猪 这个年很静 夶 贬词包用 颐使气指 习躲躲 The##Xi##Factor（习近平因素） 习总输记 亲自删评 送礼平 孙笑川 皇帝亲临忠诚的武汉 亲自考察 平平 习语录 国贼习近平 宰相 人尽皆知的体育迷 猪禁评 刁二将 习太孑 習大佬 彩色熊 狙击手布阵 shuu##kinn##pei 习梦死 独彩者 毛孙 崇祯帝 粪坑兵法 没规划的葬礼 习正日 习是春绿 包大人 糖尿维尼 恐惊天上人 拉清单 嬉包皮 初二圣君 万岁来武汉了 视频看望 亲自指挥 捐麦子 习##卡##巴##卡 大撒币 习歪嘴 老街 野蛮其体魄 倒车 习和谐 “登基” 黑白翠 习大 惜包皮 中国拉清单工作领导小组组长 足球外交 背书单 喷粪帝 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 修宪连任 家业论 习病法 恩维尔·霍习 尊蛤讨包 virus##king 撒币宝 崇祯 习驴 维尼快乐组织（Winnie##Happy##Organization）简称WHO 墨索里习 洗包皮 习二卒 大兔 维尼熊给跳跳虎黄牌 添宪宝宝 习索里尼 大撒币 shit侯 仲夏夜之中国梦 国王 满脸喷粪 赵付 学包积极分子 习梦撕 帝皇頌 总书记来过我的家 朝令夕改 xdd 瘟疫领主习近平 富平学霸刁斤干 梁家河贵族 习呆呆 包子宪法 习张三丰 日子像蜜甜 讨习檄文 超邓赶毛 习大犬 西朝鲜人民自治岛 翡翠娘娘 习猪席 乳包文化 五毛主席 头上三尺有神明 称帝修宪 习奥塞斯库 不知名氏 NMSL 毛魔转世 赛禁评 法习斯 武统时代 裸宽包子劾心 秦城监狱 亲自脱贫 平话 那翠化 读稿机 狙击手待命 外交习语 连专家也为之叹服的电脑天才 头号球迷 维尼写史 赵王 乳制品 大国造疫 毛进平 当代秦二世 信女愿一生吃素 刁槑夶尛 基拉大和习近平 shit禁评 近日成 冤大头 习澳塞斯库 沼气专家 维尼挂彩 习思想 习三点 中国爱非洲 甩锅侠 Heil##Xitler 哲欣 集金币 孢 习包子 细颈瓶 末代皇帝 Mr##Shithole 刁斤山 总统包子习 习奥赛斯库 塔西佗陷阱 一天游泳一千米 中字头组长 赵弹 习背书 “黄袍加身” 红旗下的蛋 疯狂宇宙 习蛤 习犬犬 不强自息 刁后主 次级乳包 习近砰 维尼DISCO 习后主 蔡英文最强助选 袁世凯第二 腊肉馅儿包子 武汉委托李克强 “无罩”现身 包子病毒 习得梁家书卷 中国首席造梦大师 彭主席（习主席走了太太接班） 包包大人 氼兲嫑炛 隔离”的金葫芦 习包皮 骑巨龙 席近平 九评 扛麦帝 习大郎 共哀宗 习核心 白猪 冰棒外交 坟头蹦迪 疯狂宇宙包 包经 平&强 动物森友会 包子兵法 electron8964 主席+终身制 食腐虫 戏包皮 无限连任 习总 维尼史 习大林 习皇的新装 习特勒 禁评的理由 修宪 爱新觉罗近平 庆丰包·勃列日涅夫 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 习博士 叩谢习恩 吸包皮 时间控制 你是反贼吗 彩色哥 匪酋习维尼 口罩大会 祈翠 习狍 坡涛汹涌 习匪 包帝巡游 “复辟” 习梦思 维稳警察（O） 梁家河 蹄防 习达姆 习式病毒 屎進瓶 总书记来我家 200吨 两会期间+隐瞒 错误执行者 毛二世 nmslese##dream 人类命运共同体首席架构师 毛近平 岿然不动 刁人13 习包子 习语 习二世胡亥 习卒习 粪坑先生 习付 习一尊 维尼大帝 习夶 傻大头 中国特色射秽煮疫制度 皇帝亲临忠诚的武汉 习流氓 电脑世代586 习二蛋 当代秦始皇 半羽习近平 包皇 V尼哥 吸精瓶 昆明湖涨潮 不敢高声语 鞋哥 文明其精神 断崖式下跌 云视察 习卒 习条英机 庆丰废物 大大品牌 小习微信 书单吟诵者 野兽先辈 喜包皮 梦帝 腊肉包 集近闭 倒车斯基 字共狗 20000T麦子 独裁者 追思焦裕禄 学包分子 羽日帝 《生物安全法》 动物之森 习下台 集金pay 毛装 胡志平 役民五术 親自視頻 “皇帝梦” 包包侠 号尿壶公 屎侯 青年大学包 梦回大清 720事件 大大招牌 习匪帝 Adolf##Xitler 近身平A 习Core 习王的田野上 习言乱语 刁大犬 阿道夫-习 晚共昏君 10号跳跳虎被维尼拉清单 维尼警察（X） 退党 百万雄师事件 64岁 ChinaXi 习贼 赵人13 北京中南海支部书记 做N届的主席 袭包皮 席子兵法 刁二婚 指定接班人 包子金刚腿 老歪脖子树 大海掀翻小池塘 扛麦郎 习emperor 抗麦套装 习宽衣 */
package com.pcdd.sonovel.handle;

import cn.hutool.core.io.FileUtil;
import cn.hutool.core.io.file.FileAppender;
import cn.hutool.core.lang.Console;
import cn.hutool.core.util.StrUtil;
import cn.hutool.http.HtmlUtil;
import cn.hutool.http.HttpUtil;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Book;
import com.pcdd.sonovel.util.FileUtils;
import lombok.AllArgsConstructor;

import java.io.File;
import java.util.List;

/**
 * @author pcdd
 * Created at 2024/12/4
 */
@AllArgsConstructor
public class TxtMergeHandler implements PostProcessingHandler {

    private final AppConfig config;

    @Override
    public void handle(Book book, File savePath) {
        String outputPath = StrUtil.format("{}{}（{}）.txt",
                config.getDownloadPath() + File.separator, book.getBookName(), book.getAuthor());
        File outputFile = FileUtil.touch(outputPath);
        FileAppender appender = new FileAppender(outputFile, 16, true);

        List<String> info = List.of(
                StrUtil.format("书名：{}", book.getBookName()),
                StrUtil.format("作者：{}", book.getAuthor()),
                StrUtil.format("简介：{}\n", StrUtil.isEmpty(book.getIntro()) ? "暂无" : HtmlUtil.cleanHtmlTag(book.getIntro()))
        );
        // 首页添加书籍信息
        info.forEach(appender::append);

        for (File f : FileUtils.sortFilesByName(savePath)) {
            appender.append(FileUtil.readUtf8String(f));
        }
        appender.flush();

        Console.log("<== 正在下载封面：{}", book.getCoverUrl());
        File coverFile = HttpUtil.downloadFileFromUrl(book.getCoverUrl(), savePath);
        FileUtil.rename(coverFile, "0_封面." + FileUtil.getType(coverFile), true);
    }

}