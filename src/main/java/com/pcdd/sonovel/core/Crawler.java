/* 习匪 游泳一千米 习尔布特 崇祯 习二蛋 哲欣 满脸喷粪 抗麦套装 赵家家仆 包大人 习包子 颐指气使 习正日 毛近平 昆明湖涨潮 口罩大会 CoronaXi 习瘟猪 头号球迷 刁远山 包子宪法 中国特色射秽煮疫制度 习达姆 神明论 大撒幣 玉习大帝 维尼梗有害 彩色熊 老歪脖子树 习歪嘴 维尼带货 仲夏夜之中国梦 没规划的葬礼 冠子兵法 习皇帝 包帝巡游 大锅瞻遗 修宪连任 庆丰废物 “复辟” 習敗敗 世界最强乞丐 倒车 沼气专家 包经 习总 中字头组长 主席+终身制 岿然不动 习和谐 裸宽包子劾心 腊肉包 疯狂宇宙大帝 我是一个足球迷 倒车帝 包子兵法 灰习牛 nmslman（习主席） 习奥赛斯库 讨习檄文 袁世凯第二 喷粪帝 阿道夫-习 东方project 维尼·屎(Winnie##the##Poo) 近言 小习微信 习流氓 习家军 视频看望 习梦思 称帝修宪 九大诉求 习二胖 习二坐船 习后主 野心习 习emperor 劝进 疯狂宇宙包 赵弹 匪酋习维尼 人民领袖 习近砰 青年大学包 梁家河 红旗下的蛋 习包子的Fa 平&强 大国造疫 习是春绿 庆丰帝的千秋梦 头上三尺有神明 崇祯帝 黄俄 习废帝 一天游泳一千米 习大乞 习时代 次级乳包 添宪宝宝 中国首席造梦大师 刁近乎 彭主席（习主席走了太太接班） 恩重如删 东瘟疫之地统治者暨全境守护者 维稳警察（O） shit禁评 动森 习公奭 “登基” 刁斤山 儿童习典 隔离”的金葫芦 号尿壶公 洗尽贫 大大招牌 追思焦裕禄 细颈瓶 捐麦子 二百五大帝 猪禁评 影子末帝 国王 连专家也为之叹服的电脑天才 任大炮 习澳塞斯库 赛禁评 不知名氏 不同意的举手##没有##没有 习king 太祖兔 A##Big##Deal 刁槑夶尛 孢 大大品牌 包惠帝 不强自息 足球外交 習敗北 习下台 洗包皮 法习斯 坡涛汹涌 梁家河贵族 集近闭 习侯 灭共助推器 支那精神野爹 瘟疫领主习近平 包包大人 你是反贼吗 爱新觉罗·近平 中国爱非洲 习猪席 清华毕业 集金pay 小学居士 10号跳跳虎被维尼拉清单 胡志平 习三点 卡近菲 总书记来过我的家 维持会长 习驴 富平学霸刁斤干 惜包皮 武汉委托李克强 习殡法 迈克尔·索伊 翡翠娘娘 粪坑先生 20000T麦子 习像章 野兽主席 假.."~bang！卒 颐使气指 学包积极分子 墨索里习 彩色哥 狙击手待命 北红尾鸲 毛孙 独裁者 习卒 耀眼黄红黄 习夶 信女愿一生吃素 万岁 扛麦帝 支那毒王 字共狗 云视察 大海掀翻小池塘 “黄袍加身” 梦帝 720事件 习进棺 学包分子 Cicada##3301##XD 读稿机 习核心 宰相 毛装 䒒(tiáo)菦(qín)苹(píng) 冰棒外交 无限连任 当代秦二世 万岁来武汉了 鞋哥 朝令夕改 战疫国 亲自指挥 人类命运共同体首席架构师 习##卡##巴##卡 习一尊 Adolf##Xitler Criminal##Xi##"Xitler"##Jinping 习厉王 动物之森 毛魔转世 刁人13 尊蛤讨包 nmslese##dream 动物森友会 共哀宗 200吨 吸包皮 Heil##Xitler 习奥塞斯库 平话 祈翠 梦回大清 贬词包用 习索里尼 习二二（二零二零年五月二十二日开二会） 亲自删评 书单吟诵者 集金币 习王的田野上 乳包文化 花花公子 virus##king 甩锅侠 维尼连任 习背书 习大 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 习言乱语 狙击手布阵 狙击手待命 第22条军规 习近平光辉形象 吃赵弹 央视姓党 习匪帝 shit##hole##bing##fa 九评 禁评大帝 习大帝 习思想 最后领导人 不敢高声语 中国的新皇帝 中国离岸隐匿资产管理工作领导小组组组长 蔡英文最强助选 糟糕皇帝 习二卒 习呆呆 错误执行者 维尼熊给跳跳虎黄牌 习付 大撒币 口罩外交 民进党 习语录 断崖式下跌 喜包皮 修宪 食腐虫 红二代 终身领导人 国贼习近平 席子兵法 晚共昏君 五毛主席 维尼DISCO 学包率 慨撒大帝 新影帝 SB包子 普习金 形式主义防疫 公车上书 孤独的毒王 屎侯 NMSL 《生物安全法》 刁二将 毛二世 裹嘎举吸钢闸门 Corona##Xi（习病毒） 刁人13 人尽皆知的体育迷 WHO的君王 习猪头 “习泽东”和“洪宪”（袁世凯的帝号） 中国离岸隐匿资产管理工作领导小组组组长 送礼平 大撒币 文明其精神 赵王 智商不重要 帝皇頌 小学博士 赵人13 习猪下台 习禁评 平平 “无罩”现身 基拉大和习近平 刁近猴 拉清单 习式病毒 坟头蹦迪 武当七侠的政治斗争 西朝鲜人民自治岛 叩谢习恩 叼斤干 领袖习澡水 中国拉清单工作领导小组组长 独彩者 总书记来我家 习孢子 野蛮其体魄 枪毙名单 蹄防 习教父 习狍 “梦回大清” 习“甩锅” 巴拿马文件 习Core 阿平 “皇帝梦” 习包皮 近身平A 维尼警察（X） 背书单 大兔 electron8964 包禁评 ChinaXi vop 武统时代 赵付 习大林 官僚主义 撒币宝 恐惊天上人 核平全世界 百万雄师事件 人民领袖 毛二 维尼熊 阳台上的哨兵 氼兲嫑炛 习低能儿 习梦撕 邪大大 初二圣君 亲自考察 包子金刚腿 习是春竹 没有网络安全就没有国家安全 现任匪首 截颈平 习梦死 刁斤二 普近 做N届的主席 亲自脱贫 共哀宗 习包子 指定接班人 白猪 总统包子习 宽衣帝 塔西佗陷阱 Chairman##Xi 役民五术 乳制品 袭包皮 腊肉馅儿包子 恩维尔·霍习 shuu##kinn##pei 羽日帝 习武帝 号屎洞 人民战争 野兽先辈 禁评封号 习总输记 “登机”（与登基同音） 习老八 清单帝 天安门合法继承人 动物庄园 毛进平 扛麦郎 时间控制 通商宽衣 倒车斯基 维尼之声 老街 两会期间+隐瞒 叩谢习恩 糖尿维尼 包包侠 习贼 維尼頌 傻大头 疫情蔓延 習大佬 毛二习 The##Xi##Factor（习近平因素） 嘻包皮 维尼史 V尼哥 人均接近八千万 墙内人 疯狂宇宙 当皇帝的小丑 冲塔 亲自指挥疫情 粪坑兵法 嬉包皮 习大犬 任志强 亲自封号 皇帝亲临忠诚的武汉 包子病毒 孙笑川 厕所革命 习包子 親自視頻 戴口赵 戏博士 日子像蜜甜 纳翠党 习远凸 Mr##Shithole 发皇帝梦 戏包皮 习尿瓶 庆丰称帝 法外狂徒Lucy（德国） XD 祈翠語言包 386系统驱动游戏 维尼写史 一带一路 末代皇帝 親自蒞臨 xdd 瘟疫降生习近平 北京中南海支部书记 世宗 悉包皮 格萨尔 皇帝的新衣 习躲躲 相信有神论的物理学博士 外交习语 习蛤 半羽习近平 包皇 习病法 重地之战 禁评的理由 主席贺词 御板泽民 维尼快乐组织（Winnie##Happy##Organization）简称WHO 十日文革 吸精瓶 爱新觉罗近平 刁后主 2020全面小康 读书单 Voice##of##Pooh 习特勒 习卒习 近日成 习兵法 包子露宪 bingbang帝 屎禁评 shit侯 十一郎习近平 黑白翠 战“疫”金句 习太孑 每日祈翠 习宽衣 那翠化 夶 庆丰包·勃列日涅夫 系包皮 习得梁家书卷 细瓶颈 万岁来武汉 习张三丰 维尼挂彩 64岁 坡涛汹涌 刁大犬 习三拍 刁二婚 第一书记王沪宁 习条英机 皇帝梦 冤大头 总加速师 维尼大帝 超邓赶毛 川普的朋友or敌人 乳透社##小反旗 秦城监狱 这个年很静 习犬犬 韦来书记 XDD 习大郎 骑巨龙 金科律玉 家业论 专治各种不服 习二世胡亥 4中组长 电脑世代586 当代秦始皇 习语 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 皇帝亲临忠诚的武汉 感恩教育 尼哥 退党 席近平 通商宽衣 习博士 习习蛤蛤 闹得欢 屎進瓶 习皇的新装 习屎黄 */
package com.pcdd.sonovel.core;

import cn.hutool.core.collection.CollUtil;
import cn.hutool.core.date.StopWatch;
import cn.hutool.core.io.FileUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.core.util.NumberUtil;
import cn.hutool.core.util.StrUtil;
import com.pcdd.sonovel.handle.CrawlerPostHandler;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Book;
import com.pcdd.sonovel.model.Chapter;
import com.pcdd.sonovel.model.SearchResult;
import com.pcdd.sonovel.parse.*;
import lombok.SneakyThrows;

import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.OutputStream;
import java.nio.charset.StandardCharsets;
import java.util.List;
import java.util.Objects;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

import static org.fusesource.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2021/6/10
 */
public class Crawler {

    private final AppConfig config;
    private String bookDir;

    public Crawler(AppConfig config) {
        this.config = config;
    }

    /**
     * 搜索小说
     *
     * @param keyword 关键字
     * @return 匹配的小说列表
     */
    public List<SearchResult> search(String keyword) {
        Console.log("<== 正在搜索...");
        StopWatch stopWatch = new StopWatch();
        stopWatch.start();

        List<SearchResult> searchResults;

        if (config.getSourceId() == 6) {
            searchResults = new SearchResultParser6(config).parse(keyword);
        } else {
            searchResults = new SearchResultParser(config).parse(keyword);
        }

        stopWatch.stop();
        Console.log("<== 搜索到 {} 条记录，耗时 {} s", searchResults.size(), NumberUtil.round(stopWatch.getTotalTimeSeconds(), 2));

        return searchResults;
    }

    /**
     * 爬取小说
     *
     * @param sr  小说详情
     * @param toc 小说目录
     */
    @SneakyThrows
    public double crawl(SearchResult sr, List<Chapter> toc) {
        // 小说详情页url
        String url = sr.getUrl();
        String bookName = sr.getBookName();
        String author = sr.getAuthor();
        Book book;

        // 根据 css selector 解析
        if (config.getSourceId() == 6) {
            book = new BookParser6(config).parse(url);
        } else { // 根据 meta 解析
            book = new BookParser(config).parse(url);
        }

        // 小说目录名格式：书名(作者)
        bookDir = String.format("%s (%s)", bookName, author);
        // 必须 new File()，否则无法使用 . 和 ..
        File dir = FileUtil.mkdir(new File(config.getDownloadPath() + File.separator + bookDir));
        if (!dir.exists()) {
            // C:\Program Files 下创建需要管理员权限
            Console.log(render("@|red 创建下载目录失败\n1. 检查下载路径是否合法\n2. 尝试以管理员身份运行（C 盘部分目录需要管理员权限）|@"));
            return 0;
        }

        // 防止 start、end 超出范围
        if (CollUtil.isEmpty(toc)) {
            Console.log(render(StrUtil.format("@|yellow 超出章节范围，该小说共 {} 章|@", toc.size())));
            return 0;
        }

        int autoThreads = config.getThreads() == -1 ? Runtime.getRuntime().availableProcessors() * 2 : config.getThreads();
        // 创建线程池
        ExecutorService executor = Executors.newFixedThreadPool(autoThreads);
        // 阻塞主线程，用于计时
        CountDownLatch latch = new CountDownLatch(toc.size());

        Console.log("<== 开始下载《{}》（{}） 共计 {} 章 | 线程数：{}", bookName, author, toc.size(), autoThreads);
        StopWatch stopWatch = new StopWatch();
        stopWatch.start();
        ChapterParser chapterParser = new ChapterParser(config);
        // 下载章节
        toc.forEach(item -> executor.execute(() -> {
            createChapterFile(chapterParser.parse(item, latch, sr));
            Console.log("<== 待下载章节数：{}", latch.getCount());
        }));

        // 阻塞主线程，等待章节全部下载完毕
        latch.await();
        executor.shutdown();
        new CrawlerPostHandler(config).handle(book, dir);
        stopWatch.stop();

        return stopWatch.getTotalTimeSeconds();
    }

    /**
     * 保存章节
     */
    private void createChapterFile(Chapter chapter) {
        if (chapter == null) return;

        try (OutputStream fos = new BufferedOutputStream(new FileOutputStream(generatePath(chapter)))) {
            fos.write(chapter.getContent().getBytes(StandardCharsets.UTF_8));
        } catch (Exception e) {
            Console.error(e, e.getMessage());
        }
    }

    private String generatePath(Chapter chapter) {
        // epub 格式转换前的格式为 html
        String extName = Objects.equals("epub", config.getExtName()) ? "html" : config.getExtName();
        String parentPath = config.getDownloadPath() + File.separator + bookDir + File.separator;
        return switch (config.getExtName()) {
            case "html" -> parentPath + chapter.getOrder() + "_." + extName;
            case "epub", "txt" -> parentPath + chapter.getOrder()
                    // Windows 文件名非法字符替换
                    + "_" + chapter.getTitle().replaceAll("[\\\\/:*?<>]", "") + "." + extName;
            default -> throw new IllegalStateException("暂不支持的下载格式: " + config.getExtName());
        };
    }

}