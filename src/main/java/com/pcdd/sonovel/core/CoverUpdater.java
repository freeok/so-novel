/* 蔡英文最强助选 裹嘎举吸钢闸门 习远凸 习太孑 扛麦郎 xdd 习匪帝 嘻包皮 闹得欢 shit侯 刁远山 习和谐 习瘟猪 我是一个足球迷 习躲躲 习驴 皇帝亲临忠诚的武汉 梦帝 中国的新皇帝 习后主 战“疫”金句 人民领袖 倒车斯基 习张三丰 羽日帝 大撒币 当皇帝的小丑 Criminal##Xi##"Xitler"##Jinping 骑巨龙 头上三尺有神明 支那毒王 慨撒大帝 连专家也为之叹服的电脑天才 法外狂徒Lucy（德国） 毛进平 金科律玉 习武帝 《生物安全法》 称帝修宪 习大郎 习梦撕 习皇帝 颐指气使 公车上书 包大人 惜包皮 平话 禁评的理由 吸精瓶 毛魔转世 集金币 韦来书记 习大帝 人类命运共同体首席架构师 习得梁家书卷 习包皮 SB包子 学包分子 退党 巴拿马文件 读书单 鞋哥 当代秦始皇 断崖式下跌 习大乞 习夶 主席贺词 习梦死 赵家家仆 刁二婚 毛二 外交习语 恐惊天上人 皇帝的新衣 禁评大帝 武当七侠的政治斗争 游泳一千米 北京中南海支部书记 包禁评 维尼大帝 叩谢习恩 万岁来武汉 ChinaXi 乳包文化 习匪 习核心 习二胖 清单帝 智商不重要 坡涛汹涌 习包子 耀眼黄红黄 第22条军规 刁近乎 疯狂宇宙包 人均接近八千万 习emperor 习一尊 专治各种不服 习犬犬 习思想 役民五术 electron8964 维尼连任 维尼警察（X） 包皇 The##Xi##Factor（习近平因素） 维尼梗有害 集近闭 XDD 习老八 错误执行者 吃赵弹 西朝鲜人民自治岛 假.."~bang！卒 野兽先辈 包子金刚腿 清华毕业 战疫国 习猪席 腊肉包 刁二将 世界最强乞丐 “梦回大清” 疯狂宇宙大帝 习付 集金pay 大国造疫 崇祯帝 总书记来我家 近身平A 平&强 习是春竹 习大犬 重地之战 基拉大和习近平 秦城监狱 小学博士 中国特色射秽煮疫制度 亲自指挥疫情 不强自息 阳台上的哨兵 洗尽贫 V尼哥 袁世凯第二 亲自删评 Chairman##Xi 维稳警察（O） 初二圣君 阿道夫-习 习包子 习背书 习时代 彩色熊 習大佬 悉包皮 任大炮 习二坐船 大兔 亲自指挥 习卒习 维尼熊给跳跳虎黄牌 时间控制 扛麦帝 习三拍 习二蛋 维持会长 形式主义防疫 喷粪帝 粪坑兵法 黑白翠 民进党 修宪连任 动物之森 尊蛤讨包 20000T麦子 匪酋习维尼 大大品牌 “习泽东”和“洪宪”（袁世凯的帝号） 塔西佗陷阱 吸包皮 386系统驱动游戏 天安门合法继承人 习尔布特 Heil##Xitler 日子像蜜甜 维尼熊 刁斤山 领袖习澡水 习语录 习大林 维尼快乐组织（Winnie##Happy##Organization）简称WHO 64岁 迈克尔·索伊 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 习近平光辉形象 支那精神野爹 赵人13 中国首席造梦大师 独彩者 学包率 赛禁评 习病法 乳制品 习贼 腊肉馅儿包子 岿然不动 包子病毒 昆明湖涨潮 习奥赛斯库 梦回大清 冠子兵法 二百五大帝 夶 半羽习近平 狙击手布阵 维尼DISCO 头号球迷 倒车 人民领袖 花花公子 蹄防 武汉委托李克强 virus##king 习总输记 末代皇帝 野蛮其体魄 瘟疫降生习近平 糟糕皇帝 总书记来过我的家 两会期间+隐瞒 每日祈翠 通商宽衣 大撒币 祈翠語言包 百万雄师事件 习包子的Fa “黄袍加身” 习教父 “复辟” 习屎黄 习孢子 2020全面小康 现任匪首 习二二（二零二零年五月二十二日开二会） 最后领导人 包包大人 央视姓党 大锅瞻遗 儿童习典 包经 XD 疫情蔓延 国贼习近平 孙笑川 晚共昏君 尼哥 维尼·屎(Winnie##the##Poo) “登机”（与登基同音） 習敗北 WHO的君王 恩重如删 习正日 氼兲嫑炛 中国拉清单工作领导小组组长 爱新觉罗近平 野兽主席 背书单 一带一路 梁家河 庆丰包·勃列日涅夫 大大招牌 粪坑先生 冲塔 细颈瓶 庆丰帝的千秋梦 Voice##of##Pooh 官僚主义 国王 䒒(tiáo)菦(qín)苹(píng) 系包皮 第一书记王沪宁 影子末帝 10号跳跳虎被维尼拉清单 总统包子习 书单吟诵者 小学居士 朝令夕改 崇祯 瘟疫领主习近平 习是春绿 东方project 大撒幣 十日文革 宰相 习歪嘴 无限连任 刁人13 孤独的毒王 习习蛤蛤 叩谢习恩 包子宪法 NMSL 纳翠党 红二代 屎禁评 习猪头 超邓赶毛 人尽皆知的体育迷 Corona##Xi（习病毒） 习下台 习二卒 坟头蹦迪 維尼頌 包子露宪 格萨尔 习king 猪禁评 亲自脱贫 撒币宝 抗麦套装 习低能儿 狙击手待命 那翠化 嬉包皮 恩维尔·霍习 习达姆 “登基” 文明其精神 叼斤干 习宽衣 贬词包用 玉习大帝 新影帝 习卒 拉清单 相信有神论的物理学博士 冰棒外交 傻大头 中国离岸隐匿资产管理工作领导小组组组长 维尼写史 阿平 武统时代 包惠帝 白猪 习大 云视察 习尿瓶 坡涛汹涌 冤大头 习家军 习梦思 爱新觉罗·近平 习猪下台 维尼挂彩 老街 习Core 习二世胡亥 做N届的主席 “皇帝梦” 小习微信 习呆呆 习进棺 彩色哥 习废帝 万岁来武汉了 截颈平 中字头组长 你是反贼吗 A##Big##Deal 包包侠 孢 不敢高声语 核平全世界 中国爱非洲 习兵法 胡志平 毛近平 黄俄 大海掀翻小池塘 习博士 赵王 梁家河贵族 毛装 五毛主席 送礼平 墨索里习 Adolf##Xitler vop 太祖兔 席子兵法 老歪脖子树 终身领导人 维尼带货 庆丰废物 神明论 习厉王 习##卡##巴##卡 毛二世 刁槑夶尛 庆丰称帝 讨习檄文 劝进 哲欣 世宗 维尼之声 视频看望 帝皇頌 戏包皮 祈翠 包帝巡游 nmslese##dream 共哀宗 人民战争 次级乳包 习蛤 川普的朋友or敌人 刁斤二 习包子 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 颐使气指 九评 席近平 独裁者 卡近菲 皇帝亲临忠诚的武汉 习皇的新装 东瘟疫之地统治者暨全境守护者 动物森友会 720事件 细瓶颈 包子兵法 親自視頻 狙击手待命 习特勒 习语 电脑世代586 毛孙 九大诉求 习索里尼 捐麦子 习总 发皇帝梦 这个年很静 普近 shuu##kinn##pei 习禁评 灭共助推器 墙内人 厕所革命 毛二习 家业论 习奥塞斯库 Mr##Shithole 食腐虫 富平学霸刁斤干 不知名氏 习像章 袭包皮 习式病毒 疯狂宇宙 shit禁评 野心习 万岁 动森 通商宽衣 戴口赵 普习金 维尼史 习殡法 禁评封号 法习斯 没有网络安全就没有国家安全 邪大大 习近砰 灰习牛 十一郎习近平 習敗敗 北红尾鸲 “无罩”现身 近言 隔离”的金葫芦 亲自考察 裸宽包子劾心 平平 习公奭 CoronaXi 仲夏夜之中国梦 习三点 习侯 宽衣帝 共哀宗 倒车帝 总加速师 沼气专家 红旗下的蛋 信女愿一生吃素 刁大犬 赵弹 刁近猴 御板泽民 屎侯 号尿壶公 习狍 屎進瓶 追思焦裕禄 习言乱语 添宪宝宝 戏博士 糖尿维尼 口罩外交 赵付 刁后主 200吨 亲自封号 习条英机 感恩教育 4中组长 读稿机 甩锅侠 习澳塞斯库 没规划的葬礼 皇帝梦 刁人13 口罩大会 bingbang帝 不同意的举手##没有##没有 满脸喷粪 动物庄园 近日成 洗包皮 喜包皮 修宪 任志强 习“甩锅” 青年大学包 nmslman（习主席） 枪毙名单 号屎洞 翡翠娘娘 当代秦二世 主席+终身制 親自蒞臨 shit##hole##bing##fa 指定接班人 彭主席（习主席走了太太接班） 乳透社##小反旗 一天游泳一千米 习流氓 字共狗 Cicada##3301##XD 习王的田野上 足球外交 学包积极分子 中国离岸隐匿资产管理工作领导小组组组长 */
package com.pcdd.sonovel.core;

import cn.hutool.core.lang.Console;
import cn.hutool.core.lang.Validator;
import cn.hutool.core.util.StrUtil;
import cn.hutool.core.util.URLUtil;
import cn.hutool.http.Header;
import cn.hutool.http.HtmlUtil;
import cn.hutool.http.HttpRequest;
import cn.hutool.http.HttpResponse;
import cn.hutool.json.JSONArray;
import cn.hutool.json.JSONObject;
import cn.hutool.json.JSONUtil;
import com.hankcs.hanlp.HanLP;
import com.pcdd.sonovel.model.Book;
import com.pcdd.sonovel.util.RandomUA;
import lombok.experimental.UtilityClass;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;

import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.function.Supplier;
import java.util.stream.Stream;

import static org.jline.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2025/2/6
 */
@UtilityClass
public class CoverUpdater {

    /**
     * 依次尝试不同来源获取封面
     */
    public String fetchCover(Book book, String coverUrl) {
        book.setCoverUrl(coverUrl);
        return Stream.<Supplier<String>>of(
                        () -> fetchQidian(book),
                        () -> fetchZongheng(book),
                        () -> fetchChuangshi(book)
                ).map(Supplier::get)
                .filter(CoverUpdater::isValidCover)
                .findFirst()
                .orElse(book.getCoverUrl());
    }

    /**
     * 起点中文网
     */
    public String fetchQidian(Book book) {
        Map<String, String> headers = new LinkedHashMap<>();
        headers.put(Header.USER_AGENT.getValue(), RandomUA.generate());
        headers.put(Header.COOKIE.getValue(), "w_tsfp=ltvgWVEE2utBvS0Q6KvtkkmvETw7Z2R7xFw0D+M9Os09AacnUJyD145+vdfldCyCt5Mxutrd9MVxYnGAUtAnfxcSTciYb5tH1VPHx8NlntdKRQJtA5qJW1Qbd7J2umNBLW5YI0blj2ovIoFAybBoiVtZuyJ137ZlCa8hbMFbixsAqOPFm/97DxvSliPXAHGHM3wLc+6C6rgv8LlSgXyD8FmNOVlxdr9X0kCb1T0dC3FW9BO+AexINxmkKtutXZxDuDH2tz/iaJWl0QMh5FlBpRw4d9Lh2zC7JmNGJXkaewD23+I2Z7z6ZLh6+2xIAL5FW1kVqQ8ZteI5+URPDSi9YHWPBfp6tQAARvJZ/82seSvFxIb+c1AMu4Zt0AYlsYAN6DEjYTimKd8JSWTLNnUGfotRbsq+NHlkAkBbX2RE5Qdb;");

        try {
            HttpResponse resp = HttpRequest.get(StrUtil.format("https://www.qidian.com/so/{}.html", book.getBookName()))
                    .headerMap(headers, true)
                    .execute();
            Document document = Jsoup.parse(resp.body());
            resp.close();

            for (Element e : document.select(".res-book-item")) {
                String qdName = e.select(".book-mid-info > .book-info-title > a").text();
                // 起点作家
                String qdAuthor1 = e.select(".book-mid-info > .author > .name").text();
                // 非起点作家
                String qdAuthor2 = e.select(".book-mid-info > .author > i").text();
                String qdAuthor = StrUtil.isEmpty(qdAuthor1) ? qdAuthor2 : qdAuthor1;

                if (matchBook(book, qdName, qdAuthor)) {
                    return URLUtil.normalize(e.select(".book-img-box > a > img").attr("src"))
                            .replaceAll("/150(\\.webp)?", "");
                }
            }
        } catch (Exception e) {
            Console.error(render("获取起点封面失败：{}", e.getMessage()));
        }
        return null;
    }

    /**
     * 纵横中文网
     */
    public String fetchZongheng(Book book) {
        String url = "https://search.zongheng.com/search/book";
        // 自动拼接查询字符串
        Map<String, Object> params = new HashMap<>();
        params.put("keyword", book.getBookName());
        params.put("pageNo", 1);
        params.put("pageNum", 20);
        params.put("isFromHuayu", 0);

        HttpRequest req = HttpRequest.get(url)
                .form(params)
                .header(Header.USER_AGENT, RandomUA.generate());
        HttpResponse resp = req.execute();
        String body = resp.body();
        JSONObject obj = JSONUtil.parseObj(body);
        JSONArray list = obj
                .getJSONObject("data")
                .getJSONObject("datas")
                .getJSONArray("list");

        for (Object o : list) {
            JSONObject bookObj = (JSONObject) o;
            if (matchBook(book, bookObj.getStr("name"), bookObj.getStr("authorName"))) {
                return "https://static.zongheng.com/upload" + bookObj.getStr("coverUrl");
            }
        }

        resp.close();
        return null;
    }

    /**
     * 创世中文网
     */
    public String fetchChuangshi(Book book) {
        return null;
    }

    private boolean matchBook(Book book, String name, String author) {
        String sourceName = HanLP.convertToSimplifiedChinese(book.getBookName());
        String sourceAuthor = HanLP.convertToSimplifiedChinese(book.getAuthor());
        name = HtmlUtil.cleanHtmlTag(name);
        author = HtmlUtil.cleanHtmlTag(author);
        return StrUtil.equals(sourceName, name) && StrUtil.equals(sourceAuthor, author);
    }

    private boolean isValidCover(String coverUrl) {
        return StrUtil.isNotBlank(coverUrl) && Validator.isUrl(coverUrl);
    }

}