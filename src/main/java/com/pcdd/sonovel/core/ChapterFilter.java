/* 头号球迷 主席贺词 老歪脖子树 彩色哥 Chairman##Xi 习瘟猪 修宪连任 庆丰废物 习达姆 中国爱非洲 文明其精神 恐惊天上人 维尼写史 恩重如删 崇祯 nmslman（习主席） 维尼之声 半羽习近平 习奥赛斯库 一天游泳一千米 习核心 习太孑 刁大犬 庆丰包·勃列日涅夫 不敢高声语 人尽皆知的体育迷 邪大大 刁后主 电脑世代586 平&强 叼斤干 口罩外交 清单帝 感恩教育 法外狂徒Lucy（德国） 习殡法 专治各种不服 CoronaXi 习兵法 720事件 动森 “登基” 蹄防 官僚主义 形式主义防疫 中国首席造梦大师 总加速师 北红尾鸲 最后领导人 习奥塞斯库 习梦死 包经 中字头组长 习皇的新装 集金币 shuu##kinn##pei 习语录 中国的新皇帝 毛进平 刁近乎 亲自指挥 彩色熊 字共狗 足球外交 习一尊 习习蛤蛤 小习微信 习二胖 维持会长 习流氓 瘟疫降生习近平 疯狂宇宙包 A##Big##Deal 相信有神论的物理学博士 做N届的主席 冠子兵法 武统时代 毛二世 翡翠娘娘 习言乱语 口罩大会 晚共昏君 习Core 习武帝 粪坑先生 习索里尼 NMSL 黄俄 粪坑兵法 Heil##Xitler 赵王 帝皇頌 终身领导人 习包子 万岁 习包子 颐使气指 坡涛汹涌 抗麦套装 屎進瓶 川普的朋友or敌人 习包子 毛装 维尼梗有害 独裁者 习公奭 中国特色射秽煮疫制度 重地之战 大海掀翻小池塘 shit##hole##bing##fa 不同意的举手##没有##没有 冰棒外交 Cicada##3301##XD 朝令夕改 骑巨龙 家业论 Corona##Xi（习病毒） 习##卡##巴##卡 捐麦子 叩谢习恩 習大佬 赵弹 西朝鲜人民自治岛 彭主席（习主席走了太太接班） 法习斯 裹嘎举吸钢闸门 悉包皮 视频看望 两会期间+隐瞒 习“甩锅” 十一郎习近平 virus##king 追思焦裕禄 世界最强乞丐 游泳一千米 支那精神野爹 人民领袖 一带一路 electron8964 包子金刚腿 “梦回大清” 梦回大清 “黄袍加身” 平话 梦帝 庆丰帝的千秋梦 屎禁评 小学居士 习呆呆 习澳塞斯库 你是反贼吗 坟头蹦迪 习下台 64岁 支那毒王 习是春绿 头上三尺有神明 屎侯 大国造疫 包子宪法 习尔布特 不强自息 指定接班人 阿道夫-习 习二坐船 任志强 劝进 外交习语 祈翠 习猪头 维尼史 人民战争 XD 刁远山 花花公子 包子病毒 Adolf##Xitler 蔡英文最强助选 卡近菲 糖尿维尼 集近闭 号尿壶公 习废帝 武汉委托李克强 大大招牌 习宽衣 戴口赵 386系统驱动游戏 五毛主席 领袖习澡水 毛魔转世 灰习牛 裸宽包子劾心 十日文革 习屎黄 通商宽衣 毛二 学包积极分子 xdd 发皇帝梦 东瘟疫之地统治者暨全境守护者 总书记来过我的家 灭共助推器 冲塔 习家军 习像章 仲夏夜之中国梦 习进棺 親自視頻 厕所革命 习匪 刁近猴 公车上书 嘻包皮 习二二（二零二零年五月二十二日开二会） 习病法 战“疫”金句 役民五术 讨习檄文 皇帝的新衣 习大郎 惜包皮 阳台上的哨兵 习远凸 没有网络安全就没有国家安全 习卒习 刁二将 老街 席近平 席子兵法 刁槑夶尛 秦城监狱 总书记来我家 维稳警察（O） 习三拍 “复辟” 亲自封号 习狍 刁人13 拉清单 读书单 傻大头 习时代 不知名氏 颐指气使 bingbang帝 撒币宝 普近 毛二习 狙击手布阵 刁二婚 包惠帝 疯狂宇宙大帝 习付 习大林 腊肉包 阿平 羽日帝 闹得欢 “习泽东”和“洪宪”（袁世凯的帝号） 岿然不动 皇帝亲临忠诚的武汉 习歪嘴 禁评大帝 习低能儿 shit禁评 维尼大帝 细颈瓶 爱新觉罗·近平 时间控制 V尼哥 大兔 金科律玉 习近平光辉形象 动物庄园 慨撒大帝 习思想 习匪帝 昆明湖涨潮 喜包皮 “皇帝梦” 习得梁家书卷 东方project 号屎洞 迈克尔·索伊 习三点 扛麦郎 野蛮其体魄 甩锅侠 维尼熊给跳跳虎黄牌 清华毕业 鞋哥 塔西佗陷阱 乳包文化 核平全世界 习梦撕 错误执行者 假.."~bang！卒 御板泽民 无限连任 习包子的Fa 吸精瓶 维尼DISCO 习二卒 学包分子 习大帝 赵家家仆 青年大学包 氼兲嫑炛 次级乳包 习禁评 洗尽贫 日子像蜜甜 吸包皮 习老八 庆丰称帝 疯狂宇宙 习贼 人民领袖 习条英机 书单吟诵者 初二圣君 孙笑川 新影帝 野兽先辈 SB包子 习emperor “无罩”现身 习特勒 赵付 毛孙 系包皮 习皇帝 食腐虫 20000T麦子 信女愿一生吃素 习驴 国贼习近平 连专家也为之叹服的电脑天才 《生物安全法》 疫情蔓延 习蛤 每日祈翠 习二世胡亥 “登机”（与登基同音） 包包侠 背书单 修宪 包子兵法 智商不重要 大撒币 大大品牌 红旗下的蛋 习背书 习尿瓶 包禁评 当代秦二世 央视姓党 狙击手待命 习正日 倒车帝 亲自删评 纳翠党 玉习大帝 近言 超邓赶毛 武当七侠的政治斗争 巴拿马文件 添宪宝宝 习猪下台 断崖式下跌 刁人13 白猪 九评 大锅瞻遗 习式病毒 夶 习梦思 冤大头 匪酋习维尼 退党 維尼頌 耀眼黄红黄 习厉王 包大人 禁评封号 隔离”的金葫芦 动物之森 格萨尔 倒车斯基 nmslese##dream 孤独的毒王 皇帝亲临忠诚的武汉 野兽主席 世宗 维尼快乐组织（Winnie##Happy##Organization）简称WHO 习是春竹 习大乞 包皇 人均接近八千万 孢 乳制品 习二蛋 习孢子 包帝巡游 习大 九大诉求 刁斤二 糟糕皇帝 万岁来武汉了 乳透社##小反旗 习king 习近砰 戏包皮 亲自考察 坡涛汹涌 红二代 习张三丰 扛麦帝 没规划的葬礼 那翠化 尼哥 影子末帝 Voice##of##Pooh 瘟疫领主习近平 第一书记王沪宁 习猪席 动物森友会 集金pay 二百五大帝 2020全面小康 梁家河 枪毙名单 共哀宗 喷粪帝 读稿机 XDD 习躲躲 祈翠語言包 袭包皮 习包皮 战疫国 送礼平 习语 大撒幣 包包大人 学包率 叩谢习恩 习夶 国王 習敗敗 习卒 戏博士 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 Criminal##Xi##"Xitler"##Jinping 爱新觉罗近平 vop 习王的田野上 包子露宪 沼气专家 刁斤山 赵人13 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 万岁来武汉 韦来书记 崇祯帝 赛禁评 维尼连任 总统包子习 恩维尔·霍习 现任匪首 近身平A 梁家河贵族 习后主 当皇帝的小丑 The##Xi##Factor（习近平因素） 中国离岸隐匿资产管理工作领导小组组组长 中国拉清单工作领导小组组长 维尼挂彩 习和谐 倒车 共哀宗 主席+终身制 禁评的理由 习博士 墨索里习 吃赵弹 200吨 WHO的君王 习大犬 10号跳跳虎被维尼拉清单 狙击手待命 神明论 太祖兔 中国离岸隐匿资产管理工作领导小组组组长 䒒(tiáo)菦(qín)苹(píng) 细瓶颈 哲欣 当代秦始皇 亲自指挥疫情 维尼警察（X） 胡志平 习总输记 嬉包皮 大撒币 称帝修宪 墙内人 腊肉馅儿包子 通商宽衣 ChinaXi 小学博士 习侯 shit侯 袁世凯第二 习教父 这个年很静 洗包皮 尊蛤讨包 皇帝梦 习犬犬 贬词包用 儿童习典 末代皇帝 第22条军规 习总 维尼·屎(Winnie##the##Poo) 黑白翠 猪禁评 宰相 百万雄师事件 4中组长 北京中南海支部书记 我是一个足球迷 满脸喷粪 普习金 民进党 毛近平 维尼熊 基拉大和习近平 天安门合法继承人 云视察 親自蒞臨 截颈平 近日成 習敗北 野心习 独彩者 人类命运共同体首席架构师 亲自脱贫 维尼带货 Mr##Shithole 任大炮 宽衣帝 平平 富平学霸刁斤干 */
package com.pcdd.sonovel.core;

import cn.hutool.core.util.StrUtil;
import cn.hutool.http.HtmlUtil;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Chapter;

import java.util.regex.Pattern;

/**
 * @author pcdd
 * Created at 2024/3/17
 */
public class ChapterFilter extends Source {

    public ChapterFilter(AppConfig config) {
        super(config);
    }

    /**
     * 过滤正文内容
     */
    public String filter(Chapter chapter) {
        return new FilterBuilder(chapter)
                .filterEscape(true)
                .filterAds(true)
                .filterDuplicateTitle(true)
                .build();
    }

    /**
     * 建造者类，用于动态组合过滤步骤
     */
    public class FilterBuilder {
        private final String title;
        private String content;
        private boolean applyEscapeFilter;
        private boolean applyAdsFilter;
        private boolean applyDuplicateTitleFilter;

        public FilterBuilder(Chapter chapter) {
            this.title = chapter.getTitle();
            this.content = chapter.getContent();
        }

        /**
         * 是否启用 HTML 实体字符过滤
         */
        public FilterBuilder filterEscape(boolean apply) {
            this.applyEscapeFilter = apply;
            return this;
        }

        /**
         * 是否启用广告过滤
         */
        public FilterBuilder filterAds(boolean apply) {
            this.applyAdsFilter = apply;
            return this;
        }

        /**
         * 是否启用重复标题过滤
         */
        public FilterBuilder filterDuplicateTitle(boolean apply) {
            this.applyDuplicateTitleFilter = apply;
            return this;
        }

        /**
         * 构建最终过滤内容
         */
        public String build() {
            if (applyEscapeFilter) {
                // 替换 &..; (HTML 字符实体引用)，主要是 &nbsp;，可能会导致 ibooks 章节报错
                this.content = this.content.replaceAll("&[^;]+;", "");
            }

            if (applyAdsFilter) {
                String filteredContent = this.content.replaceAll(rule.getChapter().getFilterTxt(), "");
                this.content = HtmlUtil.removeHtmlTag(filteredContent, StrUtil.splitToArray(rule.getChapter().getFilterTag(), " "));
            }

            // 确保在 EscapeFilter、AdsFilter 之后
            this.content = StrUtil.cleanBlank(this.content);

            if (applyDuplicateTitleFilter) {
                this.content = content.replaceFirst(Pattern.quote(this.title) + "|" + Pattern.quote(StrUtil.cleanBlank(this.title)), "");
            }

            // 删除全部空标签，例如 <p></p>
            return this.content.replaceAll("<(\\w+)([^>]*)>\\s*</\\1>", "");
        }
    }

}