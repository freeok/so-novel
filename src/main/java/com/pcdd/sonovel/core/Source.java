/* 习语录 口罩外交 XD XDD 送礼平 称帝修宪 中国爱非洲 NMSL 刁人13 屎進瓶 形式主义防疫 习瘟猪 人民领袖 屎禁评 习匪 720事件 抗麦套装 习下台 嘻包皮 彩色哥 宰相 截颈平 “复辟” 毛近平 视频看望 习家军 習敗敗 宽衣帝 习尔布特 哲欣 爱新觉罗近平 䒒(tiáo)菦(qín)苹(píng) 十日文革 毛二世 做N届的主席 习时代 役民五术 撒币宝 维尼熊 基拉大和习近平 Voice##of##Pooh 梁家河 九评 那翠化 青年大学包 亲自封号 习包子 主席+终身制 号尿壶公 习梦死 狙击手待命 親自蒞臨 平平 习索里尼 当代秦二世 Corona##Xi（习病毒） shit禁评 相信有神论的物理学博士 岿然不动 习皇的新装 读书单 中国离岸隐匿资产管理工作领导小组组组长 维尼大帝 十一郎习近平 初二圣君 裹嘎举吸钢闸门 戏博士 习习蛤蛤 Mr##Shithole 集金pay 习二胖 习武帝 习大郎 总加速师 习歪嘴 扛麦郎 富平学霸刁斤干 纳翠党 维尼带货 洗尽贫 迈克尔·索伊 厕所革命 刁人13 习大 卡近菲 人尽皆知的体育迷 阿平 坡涛汹涌 小学博士 细瓶颈 总书记来过我的家 慨撒大帝 御板泽民 崇祯 维尼快乐组织（Winnie##Happy##Organization）简称WHO 智商不重要 灭共助推器 习二坐船 包大人 红二代 维稳警察（O） V尼哥 崇祯帝 禁评大帝 羽日帝 终身领导人 习和谐 核平全世界 维尼·屎(Winnie##the##Poo) 习张三丰 文明其精神 红旗下的蛋 习二世胡亥 一天游泳一千米 习进棺 A##Big##Deal 习付 亲自脱贫 大撒币 维尼挂彩 包包大人 惜包皮 任大炮 包惠帝 习匪帝 嬉包皮 巴拿马文件 花花公子 闹得欢 通商宽衣 习条英机 武当七侠的政治斗争 二百五大帝 金科律玉 重地之战 赵人13 戏包皮 清单帝 习皇帝 你是反贼吗 包子露宪 中国离岸隐匿资产管理工作领导小组组组长 祈翠語言包 大锅瞻遗 席子兵法 乳透社##小反旗 刁近猴 学包率 习公奭 翡翠娘娘 毛装 习梦撕 习大帝 Heil##Xitler 中国首席造梦大师 不同意的举手##没有##没有 习屎黄 习贼 习二二（二零二零年五月二十二日开二会） 习近平光辉形象 夶 习太孑 灰习牛 氼兲嫑炛 赵付 习“甩锅” 恐惊天上人 祈翠 倒车斯基 习包子 大撒幣 习梦思 鞋哥 武汉委托李克强 中国的新皇帝 专治各种不服 庆丰废物 皇帝的新衣 习侯 狙击手待命 洗包皮 孙笑川 支那毒王 习躲躲 庆丰称帝 习二蛋 法习斯 Criminal##Xi##"Xitler"##Jinping 动森 习犬犬 感恩教育 10号跳跳虎被维尼拉清单 electron8964 习澳塞斯库 人民领袖 读稿机 家业论 shuu##kinn##pei 小习微信 普近 胡志平 倒车帝 维尼梗有害 喷粪帝 墨索里习 彩色熊 腊肉馅儿包子 匪酋习维尼 习式病毒 独裁者 信女愿一生吃素 秦城监狱 尼哥 习Core 昆明湖涨潮 ChinaXi Adolf##Xitler “梦回大清” 习三拍 習大佬 包皇 一带一路 日子像蜜甜 “习泽东”和“洪宪”（袁世凯的帝号） 刁二婚 讨习檄文 满脸喷粪 共哀宗 刁后主 任志强 刁斤二 劝进 背书单 习低能儿 刁槑夶尛 世界最强乞丐 袭包皮 不强自息 維尼頌 爱新觉罗·近平 习呆呆 坟头蹦迪 扛麦帝 东瘟疫之地统治者暨全境守护者 “登机”（与登基同音） 断崖式下跌 皇帝亲临忠诚的武汉 朝令夕改 4中组长 亲自指挥 习近砰 蹄防 习教父 孢 字共狗 “皇帝梦” 刁近乎 万岁来武汉 万岁来武汉了 包子兵法 叩谢习恩 习语 冰棒外交 动物森友会 疯狂宇宙 包禁评 习后主 习总 刁远山 习猪席 袁世凯第二 习思想 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 次级乳包 庆丰包·勃列日涅夫 200吨 新影帝 习尿瓶 裸宽包子劾心 帝皇頌 “黄袍加身” 吸精瓶 连专家也为之叹服的电脑天才 贬词包用 追思焦裕禄 格萨尔 屎侯 习孢子 两会期间+隐瞒 人均接近八千万 习博士 nmslese##dream 国王 禁评封号 毛魔转世 习大乞 晚共昏君 大国造疫 习殡法 毛二习 仲夏夜之中国梦 细颈瓶 川普的朋友or敌人 梦帝 平话 中国特色射秽煮疫制度 刁大犬 習敗北 平&强 习正日 习背书 赵王 习三点 习是春绿 甩锅侠 不知名氏 xdd 赵弹 瘟疫降生习近平 集金币 习流氓 野兽主席 粪坑先生 习包皮 不敢高声语 儿童习典 包子病毒 野心习 shit侯 bingbang帝 北京中南海支部书记 书单吟诵者 virus##king 沼气专家 席近平 习兵法 包子金刚腿 集近闭 习达姆 末代皇帝 尊蛤讨包 共哀宗 学包积极分子 野兽先辈 假.."~bang！卒 没规划的葬礼 习言乱语 添宪宝宝 赵家家仆 倒车 近言 退党 包帝巡游 小学居士 狙击手布阵 每日祈翠 习king 习驴 五毛主席 习王的田野上 神明论 彭主席（习主席走了太太接班） 号屎洞 人类命运共同体首席架构师 习emperor Cicada##3301##XD 系包皮 外交习语 vop 亲自考察 塔西佗陷阱 野蛮其体魄 武统时代 习老八 习是春竹 孤独的毒王 主席贺词 战“疫”金句 第22条军规 人民战争 《生物安全法》 官僚主义 親自視頻 维尼之声 玉习大帝 冠子兵法 老歪脖子树 Chairman##Xi 习大林 公车上书 当皇帝的小丑 恩维尔·霍习 半羽习近平 刁斤山 太祖兔 吃赵弹 耀眼黄红黄 戴口赵 叼斤干 习蛤 大大招牌 坡涛汹涌 电脑世代586 大兔 瘟疫领主习近平 维尼警察（X） 白猪 梁家河贵族 习远凸 亲自删评 支那精神野爹 九大诉求 口罩大会 总统包子习 黄俄 东方project 普习金 邪大大 通商宽衣 阿道夫-习 习特勒 天安门合法继承人 第一书记王沪宁 64岁 恩重如删 维尼DISCO 云视察 足球外交 这个年很静 The##Xi##Factor（习近平因素） 近身平A 20000T麦子 包包侠 乳包文化 “无罩”现身 中国拉清单工作领导小组组长 习病法 赛禁评 习像章 习卒 大大品牌 习狍 习奥赛斯库 习二卒 最后领导人 世宗 粪坑兵法 猪禁评 颐指气使 糟糕皇帝 大撒币 毛二 毛进平 错误执行者 修宪 骑巨龙 亲自指挥疫情 习##卡##巴##卡 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 超邓赶毛 独彩者 CoronaXi 习废帝 捐麦子 包子宪法 疯狂宇宙包 维持会长 习卒习 修宪连任 傻大头 韦来书记 动物庄园 386系统驱动游戏 时间控制 枪毙名单 习禁评 毛孙 皇帝梦 吸包皮 现任匪首 维尼连任 游泳一千米 中字头组长 老街 头号球迷 头上三尺有神明 皇帝亲临忠诚的武汉 冲塔 习奥塞斯库 法外狂徒Lucy（德国） 近日成 习一尊 梦回大清 习大犬 发皇帝梦 维尼史 糖尿维尼 指定接班人 shit##hole##bing##fa 动物之森 腊肉包 北红尾鸲 刁二将 维尼写史 疯狂宇宙大帝 战疫国 当代秦始皇 总书记来我家 阳台上的哨兵 西朝鲜人民自治岛 领袖习澡水 冤大头 央视姓党 乳制品 习核心 无限连任 禁评的理由 拉清单 疫情蔓延 习猪头 食腐虫 习夶 隔离”的金葫芦 万岁 习包子的Fa 颐使气指 “登基” 喜包皮 大海掀翻小池塘 习得梁家书卷 WHO的君王 墙内人 黑白翠 我是一个足球迷 习厉王 nmslman（习主席） 2020全面小康 包经 习包子 SB包子 百万雄师事件 习猪下台 影子末帝 维尼熊给跳跳虎黄牌 叩谢习恩 学包分子 悉包皮 庆丰帝的千秋梦 没有网络安全就没有国家安全 国贼习近平 蔡英文最强助选 习宽衣 清华毕业 民进党 习总输记 */
package com.pcdd.sonovel.core;

import cn.hutool.core.io.resource.ResourceUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.core.lang.Opt;
import cn.hutool.json.JSONUtil;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.util.ConfigUtils;
import com.pcdd.sonovel.util.CrawlUtils;
import com.pcdd.sonovel.util.RandomUA;
import org.jsoup.Connection;
import org.jsoup.Jsoup;

import static org.jline.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2024/3/27
 */
public class Source {

    public final Rule rule;
    public final AppConfig config;

    // 配置文件读取书源 id
    public Source(AppConfig config) {
        this(config.getSourceId(), config);
    }

    public Source(int id) {
        this(id, null);
    }

    // 自定义书源 id，用于测试
    public Source(int id, AppConfig config) {
        String jsonStr = null;

        try {
            // 根据 sourceId 获取对应书源规则
            jsonStr = ResourceUtil.readUtf8Str("rule/rule-" + id + ".json");
        } catch (Exception e) {
            Console.error(render("@|red 书源规则初始化失败，请检查配置项 source-id 是否正确|@"));
            Console.error(render("@|red 错误信息：{}|@"), e.getMessage());
            System.exit(1);
        }

        // 将 JSON 转换为 Rule 对象，并应用默认值
        this.rule = applyDefaultTimeouts(JSONUtil.toBean(jsonStr, Rule.class));
        // 使用配置文件中的配置，若为空则使用默认配置
        this.config = Opt.ofNullable(config).orElse(ConfigUtils.config());
    }

    private Rule applyDefaultTimeouts(Rule rule) {
        Rule.Search ruleSearch = rule.getSearch();
        Rule.Book ruleBook = rule.getBook();
        Rule.Toc ruleToc = rule.getToc();
        Rule.Chapter ruleChapter = rule.getChapter();

        if (ruleSearch != null && ruleSearch.getTimeout() == null) {
            ruleSearch.setTimeout(15_000);
        }
        if (ruleBook != null && ruleBook.getTimeout() == null) {
            ruleBook.setTimeout(10_000);
        }
        if (ruleToc != null && ruleToc.getTimeout() == null) {
            ruleToc.setTimeout(30_000);
        }
        if (ruleChapter != null && ruleChapter.getTimeout() == null) {
            ruleChapter.setTimeout(15_000);
        }

        return rule;
    }

    public Connection jsoup(String url) {
        // 除了搜索请求，其他请求基本均为 GET
        String method = rule.getSearch() != null ? rule.getSearch().getMethod() : "GET";

        Connection conn = Jsoup.connect(url)
                .method(CrawlUtils.buildMethod(method))
                .header("User-Agent", RandomUA.generate());

        // 启用配置文件的代理地址
        if (config.getProxyEnabled() == 1) {
            conn.proxy(config.getProxyHost(), config.getProxyPort());
        }

        return conn;
    }

}