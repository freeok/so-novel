/* 那翠化 当皇帝的小丑 毛装 北红尾鸲 集近闭 战“疫”金句 倒车斯基 蔡英文最强助选 屎禁评 维尼史 庆丰包·勃列日涅夫 终身领导人 红二代 电脑世代586 刁槑夶尛 支那精神野爹 electron8964 相信有神论的物理学博士 动物庄园 Cicada##3301##XD 维尼连任 你是反贼吗 “皇帝梦” 骑巨龙 Heil##Xitler 刁后主 习皇的新装 彭主席（习主席走了太太接班） 习梦思 祈翠 大撒币 恩重如删 席子兵法 中国首席造梦大师 大大品牌 老街 头上三尺有神明 墨索里习 头号球迷 通商宽衣 习三点 习背书 ChinaXi 包包大人 洗包皮 习Core 官僚主义 习二蛋 习式病毒 bingbang帝 大撒幣 “登基” 习包子 游泳一千米 末代皇帝 SB包子 断崖式下跌 386系统驱动游戏 扛麦帝 维尼警察（X） 习大郎 维尼挂彩 狙击手布阵 习兵法 无限连任 “梦回大清” 习梦撕 平平 20000T麦子 shit##hole##bing##fa 习驴 习包皮 皇帝的新衣 第22条军规 Corona##Xi（习病毒） 习大犬 坟头蹦迪 任志强 刁近猴 西朝鲜人民自治岛 维尼DISCO 习歪嘴 卡近菲 小习微信 习特勒 XDD 习奥赛斯库 富平学霸刁斤干 The##Xi##Factor（习近平因素） 耀眼黄红黄 习猪头 中国离岸隐匿资产管理工作领导小组组组长 学包分子 习大帝 满脸喷粪 人民领袖 屎侯 核平全世界 灰习牛 甩锅侠 总统包子习 习是春竹 晚共昏君 百万雄师事件 毛二世 叩谢习恩 人民领袖 习近平光辉形象 万岁来武汉 习侯 小学博士 白猪 庆丰废物 野心习 发皇帝梦 清华毕业 彩色哥 习废帝 中国离岸隐匿资产管理工作领导小组组组长 CoronaXi 世宗 近言 动物森友会 狙击手待命 大大招牌 现任匪首 不强自息 席近平 亲自脱贫 字共狗 “无罩”现身 喜包皮 初二圣君 崇祯帝 毛二习 九评 假.."~bang！卒 尼哥 冤大头 习二坐船 老歪脖子树 《生物安全法》 习猪下台 习时代 庆丰帝的千秋梦 颐使气指 细颈瓶 悉包皮 神明论 岿然不动 习流氓 毛近平 惜包皮 皇帝亲临忠诚的武汉 集金币 人尽皆知的体育迷 维尼熊给跳跳虎黄牌 鞋哥 庆丰称帝 帝皇頌 习病法 二百五大帝 阿道夫-习 讨习檄文 一带一路 平话 习躲躲 包惠帝 万岁 领袖习澡水 Chairman##Xi nmslman（习主席） 形式主义防疫 习##卡##巴##卡 亲自指挥疫情 瘟疫降生习近平 大撒币 纳翠党 裹嘎举吸钢闸门 中国拉清单工作领导小组组长 儿童习典 习蛤 刁人13 维尼·屎(Winnie##the##Poo) 包大人 习尿瓶 习匪 10号跳跳虎被维尼拉清单 皇帝梦 总加速师 青年大学包 大兔 这个年很静 十一郎习近平 冲塔 virus##king 迈克尔·索伊 我是一个足球迷 习屎黄 习王的田野上 习正日 毛二 疯狂宇宙大帝 喷粪帝 腊肉馅儿包子 袭包皮 “习泽东”和“洪宪”（袁世凯的帝号） 云视察 外交习语 习武帝 皇帝亲临忠诚的武汉 御板泽民 夶 习包子 当代秦二世 戏包皮 狙击手待命 共哀宗 梦回大清 习二卒 习语录 仲夏夜之中国梦 孙笑川 倒车帝 维尼梗有害 最后领导人 习家军 金科律玉 基拉大和习近平 人均接近八千万 中国特色射秽煮疫制度 傻大头 野兽先辈 吸包皮 世界最强乞丐 昆明湖涨潮 習敗敗 Adolf##Xitler 200吨 共哀宗 习近砰 习下台 包皇 包子病毒 习总 习后主 爱新觉罗·近平 袁世凯第二 川普的朋友or敌人 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 做N届的主席 吃赵弹 截颈平 人民战争 孤独的毒王 大国造疫 习太孑 梁家河贵族 粪坑先生 NMSL 维持会长 巴拿马文件 读稿机 习总输记 邪大大 万岁来武汉了 习张三丰 䒒(tiáo)菦(qín)苹(píng) 黄俄 刁近乎 两会期间+隐瞒 没有网络安全就没有国家安全 尊蛤讨包 亲自指挥 包帝巡游 习一尊 抗麦套装 习禁评 猪禁评 刁远山 恐惊天上人 野兽主席 习公奭 刁二将 习核心 新影帝 Voice##of##Pooh 包子兵法 2020全面小康 近身平A “登机”（与登基同音） nmslese##dream 支那毒王 彩色熊 叼斤干 东方project 读书单 赵付 习殡法 错误执行者 习“甩锅” 习习蛤蛤 太祖兔 V尼哥 武当七侠的政治斗争 独彩者 禁评的理由 灭共助推器 人类命运共同体首席架构师 XD 习大林 清单帝 大海掀翻小池塘 氼兲嫑炛 习卒习 习条英机 习付 细瓶颈 孢 中国爱非洲 羽日帝 文明其精神 第一书记王沪宁 吸精瓶 国王 专治各种不服 坡涛汹涌 格萨尔 乳制品 親自蒞臨 包经 枪毙名单 習敗北 劝进 平&强 半羽习近平 赛禁评 食腐虫 超邓赶毛 习远凸 天安门合法继承人 习犬犬 乳包文化 糟糕皇帝 梦帝 小学居士 习包子 习皇帝 包禁评 维尼带货 习贼 720事件 总书记来过我的家 中字头组长 疯狂宇宙包 公车上书 添宪宝宝 习二胖 习厉王 当代秦始皇 号尿壶公 时间控制 阳台上的哨兵 信女愿一生吃素 习二世胡亥 腊肉包 集金pay 普习金 独裁者 花花公子 总书记来我家 亲自封号 瘟疫领主习近平 朝令夕改 隔离”的金葫芦 习宽衣 恩维尔·霍习 影子末帝 学包率 通商宽衣 毛进平 野蛮其体魄 习老八 习卒 习夶 刁二婚 疯狂宇宙 习博士 家业论 贬词包用 习瘟猪 秦城监狱 习大乞 冠子兵法 习emperor 梁家河 普近 习教父 习言乱语 国贼习近平 禁评大帝 动物之森 学包积极分子 毛孙 维尼大帝 刁斤山 法外狂徒Lucy（德国） 宰相 退党 口罩外交 疫情蔓延 64岁 东瘟疫之地统治者暨全境守护者 匪酋习维尼 塔西佗陷阱 包子金刚腿 shuu##kinn##pei shit禁评 蹄防 习二二（二零二零年五月二十二日开二会） 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 维稳警察（O） 倒车 习是春绿 颐指气使 shit侯 粪坑兵法 包子宪法 维尼快乐组织（Winnie##Happy##Organization）简称WHO 亲自删评 屎進瓶 任大炮 口罩大会 赵家家仆 不敢高声语 戴口赵 习像章 法习斯 武汉委托李克强 书单吟诵者 包子露宪 翡翠娘娘 “复辟” 武统时代 十日文革 大锅瞻遗 習大佬 爱新觉罗近平 役民五术 崇祯 玉习大帝 重地之战 习语 习和谐 习思想 感恩教育 视频看望 习大 墙内人 撒币宝 九大诉求 4中组长 刁人13 毛魔转世 親自視頻 央视姓党 裸宽包子劾心 近日成 沼气专家 习索里尼 智商不重要 习狍 次级乳包 习三拍 洗尽贫 送礼平 vop 冰棒外交 日子像蜜甜 不同意的举手##没有##没有 戏博士 胡志平 习孢子 足球外交 北京中南海支部书记 民进党 糖尿维尼 闹得欢 赵弹 红旗下的蛋 修宪连任 没规划的葬礼 习低能儿 习呆呆 不知名氏 宽衣帝 指定接班人 維尼頌 连专家也为之叹服的电脑天才 战疫国 A##Big##Deal 习匪帝 阿平 一天游泳一千米 习尔布特 习包子的Fa 习king 亲自考察 刁斤二 习达姆 称帝修宪 拉清单 xdd 习澳塞斯库 刁大犬 主席贺词 修宪 习奥塞斯库 追思焦裕禄 WHO的君王 黑白翠 动森 哲欣 叩谢习恩 赵人13 系包皮 包包侠 厕所革命 嘻包皮 慨撒大帝 每日祈翠 赵王 习猪席 习得梁家书卷 维尼熊 祈翠語言包 号屎洞 维尼之声 背书单 五毛主席 中国的新皇帝 禁评封号 捐麦子 韦来书记 “黄袍加身” 维尼写史 乳透社##小反旗 嬉包皮 习进棺 Mr##Shithole 主席+终身制 习梦死 Criminal##Xi##"Xitler"##Jinping 扛麦郎 坡涛汹涌 */
package com.pcdd.sonovel.convert;

import cn.hutool.core.util.StrUtil;
import cn.hutool.extra.template.Template;
import cn.hutool.extra.template.TemplateConfig;
import cn.hutool.extra.template.TemplateEngine;
import cn.hutool.extra.template.TemplateUtil;
import com.pcdd.sonovel.core.ChapterFilter;
import com.pcdd.sonovel.core.ChapterFormatter;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Chapter;
import lombok.AllArgsConstructor;

import java.util.HashMap;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;


/**
 * @author pcdd
 * Created at 2024/3/17
 */
@AllArgsConstructor
public class ChapterConverter {

    private final AppConfig config;
    private final TemplateEngine engine = TemplateUtil.createEngine(new TemplateConfig("templates", TemplateConfig.ResourceMode.CLASSPATH));

    public Chapter convert(Chapter chapter) {
        String extName = config.getExtName();
        String filteredContent = new ChapterFilter(config).filter(chapter);
        String content = new ChapterFormatter(config).format(filteredContent);

        if ("txt".equals(extName)) {
            // 全角空格，用于首行缩进
            String ident = "\u3000".repeat(2);
            Matcher matcher = Pattern.compile("<p>(.*?)</p>").matcher(content);
            StringBuilder result = new StringBuilder();

            while (matcher.find()) {
                result.append(ident)
                        .append(matcher.group(1))
                        .append("\n");
            }

            content = chapter.getTitle() + "\n".repeat(2) + result;
        }
        if ("epub".equals(extName) || "html".equals(extName)) {
            chapter.setContent(content);
            content = templateRender(chapter, extName);
        }

        chapter.setContent(content);
        return chapter;
    }

    /**
     * 根据扩展名渲染对应模板
     */
    private String templateRender(Chapter chapter, String extName) {
        // epub 或 html 模板
        Template template = engine.getTemplate(StrUtil.format("chapter_{}.flt", extName));
        Map<String, String> map = new HashMap<>();
        map.put("title", chapter.getTitle());
        map.put("content", chapter.getContent());

        return template.render(map);
    }

}