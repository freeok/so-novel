/* 习总 习付 武当七侠的政治斗争 北京中南海支部书记 共哀宗 䒒(tiáo)菦(qín)苹(píng) 世宗 习流氓 习兵法 做N届的主席 习皇帝 习远凸 习包皮 梦帝 习驴 彩色熊 人尽皆知的体育迷 核平全世界 包子金刚腿 金科律玉 习猪席 习大帝 花花公子 截颈平 习索里尼 世界最强乞丐 近身平A 习三点 SB包子 包皇 习屎黄 习病法 包子病毒 大撒幣 不敢高声语 二百五大帝 维尼之声 习包子的Fa 宰相 信女愿一生吃素 “习泽东”和“洪宪”（袁世凯的帝号） 赵付 当代秦始皇 初二圣君 倒车 书单吟诵者 习梦死 腊肉馅儿包子 家业论 猪禁评 普习金 习孢子 习“甩锅” 禁评的理由 倒车斯基 冤大头 坡涛汹涌 200吨 維尼頌 集金币 疯狂宇宙大帝 10号跳跳虎被维尼拉清单 现任匪首 红旗下的蛋 粪坑兵法 蹄防 386系统驱动游戏 动物森友会 习二世胡亥 “复辟” 习语录 鞋哥 禁评封号 食腐虫 游泳一千米 赵家家仆 小学居士 抗麦套装 720事件 头上三尺有神明 亲自指挥疫情 爱新觉罗近平 nmslman（习主席） 孤独的毒王 习条英机 糟糕皇帝 白猪 毛二世 亲自考察 习呆呆 云视察 习Core 坟头蹦迪 领袖习澡水 不同意的举手##没有##没有 不强自息 大大品牌 疫情蔓延 智商不重要 习家军 恩维尔·霍习 The##Xi##Factor（习近平因素） 总统包子习 禁评大帝 习老八 撒币宝 一带一路 席近平 庆丰废物 习奥塞斯库 讨习檄文 习卒习 法习斯 次级乳包 集近闭 送礼平 习二胖 包惠帝 中国离岸隐匿资产管理工作领导小组组组长 亲自脱贫 两会期间+隐瞒 耀眼黄红黄 号屎洞 恩重如删 哲欣 动物庄园 人均接近八千万 维尼连任 V尼哥 习猪头 学包积极分子 毛孙 Cicada##3301##XD 习犬犬 习像章 动森 裸宽包子劾心 赵人13 中国的新皇帝 習大佬 字共狗 近日成 断崖式下跌 头号球迷 嘻包皮 专治各种不服 习语 親自視頻 席子兵法 习奥赛斯库 野心习 普近 连专家也为之叹服的电脑天才 “登机”（与登基同音） 亲自指挥 维尼快乐组织（Winnie##Happy##Organization）简称WHO 重地之战 指定接班人 孙笑川 袁世凯第二 主席贺词 共哀宗 悉包皮 习匪 总加速师 扛麦帝 习后主 最后领导人 无限连任 20000T麦子 戏博士 维稳警察（O） 野兽主席 民进党 virus##king 维尼熊给跳跳虎黄牌 塔西佗陷阱 维尼DISCO 习废帝 视频看望 翡翠娘娘 青年大学包 孢 近言 九大诉求 夶 晚共昏君 羽日帝 那翠化 通商宽衣 邪大大 XDD 神明论 习近砰 Criminal##Xi##"Xitler"##Jinping 屎進瓶 相信有神论的物理学博士 超邓赶毛 戏包皮 刁二婚 瘟疫降生习近平 胡志平 末代皇帝 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 扛麦郎 shuu##kinn##pei “无罩”现身 维尼带货 平平 习匪帝 xdd 皇帝的新衣 WHO的君王 粪坑先生 号尿壶公 大撒币 习梦撕 毛近平 太祖兔 习背书 Mr##Shithole 十日文革 Heil##Xitler 基拉大和习近平 吃赵弹 任志强 岿然不动 64岁 修宪 满脸喷粪 惜包皮 日子像蜜甜 包子露宪 北红尾鸲 国贼习近平 半羽习近平 习宽衣 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 灰习牛 狙击手待命 shit禁评 学包率 《生物安全法》 枪毙名单 习二坐船 役民五术 野兽先辈 毛二 黄俄 川普的朋友or敌人 喷粪帝 习二卒 狙击手布阵 叼斤干 人类命运共同体首席架构师 “黄袍加身” 冠子兵法 韦来书记 巴拿马文件 细瓶颈 习大犬 你是反贼吗 CoronaXi 倒车帝 爱新觉罗·近平 赵弹 崇祯帝 糖尿维尼 独裁者 九评 刁槑夶尛 袭包皮 屎禁评 包子宪法 新影帝 喜包皮 亲自删评 闹得欢 氼兲嫑炛 崇祯 战疫国 习得梁家书卷 西朝鲜人民自治岛 动物之森 劝进 吸包皮 中国特色射秽煮疫制度 大撒币 毛进平 维尼写史 习king 没有网络安全就没有国家安全 狙击手待命 玉习大帝 洗包皮 瘟疫领主习近平 梁家河 维尼大帝 习式病毒 习和谐 读稿机 包大人 包经 灭共助推器 不知名氏 添宪宝宝 文明其精神 叩谢习恩 Corona##Xi（习病毒） 系包皮 包包大人 大锅瞻遗 “梦回大清” 战“疫”金句 厕所革命 仲夏夜之中国梦 阿道夫-习 尊蛤讨包 A##Big##Deal 红二代 梦回大清 迈克尔·索伊 ChinaXi 刁人13 维尼挂彩 我是一个足球迷 总书记来我家 习张三丰 小习微信 习思想 习皇的新装 习尔布特 习包子 习教父 习禁评 包包侠 赛禁评 万岁 梁家河贵族 洗尽贫 错误执行者 人民领袖 疯狂宇宙 大兔 庆丰帝的千秋梦 形式主义防疫 足球外交 外交习语 颐使气指 假.."~bang！卒 大大招牌 乳制品 武汉委托李克强 纳翠党 蔡英文最强助选 裹嘎举吸钢闸门 习梦思 口罩大会 匪酋习维尼 主席+终身制 这个年很静 总书记来过我的家 人民领袖 当皇帝的小丑 亲自封号 大国造疫 “皇帝梦” 包禁评 electron8964 学包分子 甩锅侠 天安门合法继承人 颐指气使 习总输记 武统时代 富平学霸刁斤干 中国爱非洲 东方project 习一尊 XD 庆丰包·勃列日涅夫 拉清单 习言乱语 NMSL 老歪脖子树 彩色哥 赵王 墙内人 口罩外交 习下台 习大林 傻大头 习习蛤蛤 乳透社##小反旗 习夶 腊肉包 通商宽衣 刁近乎 东瘟疫之地统治者暨全境守护者 支那毒王 影子末帝 毛二习 刁大犬 shit##hole##bing##fa 疯狂宇宙包 朝令夕改 一天游泳一千米 格萨尔 秦城监狱 央视姓党 习特勒 习卒 shit侯 维持会长 官僚主义 习包子 百万雄师事件 习蛤 法外狂徒Lucy（德国） 刁人13 沼气专家 毛装 背书单 清华毕业 习包子 习歪嘴 习王的田野上 中国拉清单工作领导小组组长 儿童习典 习正日 习emperor 恐惊天上人 包帝巡游 维尼熊 nmslese##dream 清单帝 习大乞 叩谢习恩 感恩教育 维尼·屎(Winnie##the##Poo) 习三拍 阳台上的哨兵 发皇帝梦 野蛮其体魄 习时代 皇帝亲临忠诚的武汉 刁斤二 习二蛋 刁近猴 卡近菲 Chairman##Xi 公车上书 2020全面小康 御板泽民 坡涛汹涌 小学博士 习低能儿 习是春绿 习尿瓶 习狍 習敗敗 第22条军规 骑巨龙 电脑世代586 习核心 习殡法 親自蒞臨 终身领导人 习进棺 国王 中国离岸隐匿资产管理工作领导小组组组长 五毛主席 戴口赵 习贼 维尼史 每日祈翠 vop 庆丰称帝 当代秦二世 Voice##of##Pooh 维尼警察（X） 包子兵法 十一郎习近平 嬉包皮 刁后主 人民战争 维尼梗有害 宽衣帝 慨撒大帝 平&强 万岁来武汉了 捐麦子 没规划的葬礼 时间控制 吸精瓶 刁斤山 支那精神野爹 万岁来武汉 bingbang帝 读书单 刁二将 习近平光辉形象 隔离”的金葫芦 习瘟猪 黑白翠 昆明湖涨潮 习大 老街 冰棒外交 集金pay 习猪下台 追思焦裕禄 第一书记王沪宁 “登基” 任大炮 习二二（二零二零年五月二十二日开二会） 祈翠語言包 习博士 习公奭 習敗北 称帝修宪 皇帝亲临忠诚的武汉 中国首席造梦大师 独彩者 乳包文化 习躲躲 祈翠 毛魔转世 习武帝 彭主席（习主席走了太太接班） 习达姆 习大郎 习侯 Adolf##Xitler 大海掀翻小池塘 习厉王 中字头组长 细颈瓶 尼哥 习澳塞斯库 修宪连任 冲塔 墨索里习 退党 4中组长 帝皇頌 贬词包用 平话 习是春竹 阿平 皇帝梦 习##卡##巴##卡 屎侯 习太孑 刁远山 */
package com.pcdd.sonovel.util;

import cn.hutool.core.lang.Validator;
import cn.hutool.core.util.URLUtil;
import cn.hutool.json.JSONUtil;
import com.pcdd.sonovel.model.AppConfig;
import lombok.experimental.UtilityClass;
import org.jsoup.Connection;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.ThreadLocalRandom;
import java.util.concurrent.atomic.AtomicInteger;


/**
 * @author pcdd
 * Created at 2024/11/28
 */
@UtilityClass
public class CrawlUtils {

    // 有的 href 是相对路径，需要拼接为完整路径
    public String normalizeUrl(String s, String host) {
        if (s.matches("^http(s)?://.*")) {
            return s;
        }
        return URLUtil.normalize(Validator.isUrl(s) ? s : host + s, true, true);
    }

    // POST 构建 Body，GET 构建 Query Parameters
    public Map<String, String> buildData(String jsonStr, String... args) {
        Map<String, String> params = new HashMap<>();
        AtomicInteger i = new AtomicInteger(0);

        JSONUtil.parseObj(jsonStr)
                .forEach((key, value) -> {
                    if ("%s".equals(value)) {
                        if (i.get() < args.length) {
                            params.put(key, args[i.getAndIncrement()]);
                        }
                    } else {
                        params.put(key, value.toString());
                    }
                });

        return params;
    }

    public Map<String, String> buildCookies(String cookies) {
        Map<String, String> map = new HashMap<>();

        JSONUtil.parseObj(cookies)
                .forEach((key, value) -> map.put(key, value.toString()));

        return map;
    }

    public Connection.Method buildMethod(String method) {
        return switch (method.toLowerCase()) {
            case "get" -> Connection.Method.GET;
            case "post" -> Connection.Method.POST;
            case "put" -> Connection.Method.PUT;
            case "delete" -> Connection.Method.DELETE;
            case "patch" -> Connection.Method.PATCH;
            case "head" -> Connection.Method.HEAD;
            case "options" -> Connection.Method.OPTIONS;
            case "trace" -> Connection.Method.TRACE;
            default -> throw new IllegalArgumentException("Unsupported request method: " + method);
        };
    }

    public long randomInterval(AppConfig config) {
        return randomInterval(config, false);
    }

    public long randomInterval(AppConfig config, boolean isRetry) {
        return ThreadLocalRandom.current().nextLong(
                isRetry ? config.getRetryMinInterval() : config.getMinInterval(),
                isRetry ? config.getRetryMaxInterval() : config.getMaxInterval());
    }

}