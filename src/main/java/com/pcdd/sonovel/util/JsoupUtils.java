/* 学包分子 shuu##kinn##pei 习总输记 习卒习 䒒(tiáo)菦(qín)苹(píng) 庆丰废物 专治各种不服 疯狂宇宙大帝 习大帝 万岁来武汉了 彩色哥 electron8964 发皇帝梦 大撒币 庆丰帝的千秋梦 足球外交 习澳塞斯库 白猪 裸宽包子劾心 包大人 大撒幣 指定接班人 枪毙名单 庆丰包·勃列日涅夫 祈翠 书单吟诵者 刁大犬 终身领导人 末代皇帝 小习微信 野心习 普近 这个年很静 习包子 秦城监狱 大撒币 智商不重要 刁远山 叼斤干 中国拉清单工作领导小组组长 武统时代 习语 川普的朋友or敌人 小学居士 “皇帝梦” 习卒 第一书记王沪宁 习奥塞斯库 习是春竹 《生物安全法》 习躲躲 64岁 主席贺词 习教父 猪禁评 近言 腊肉包 包惠帝 学包积极分子 仲夏夜之中国梦 颐使气指 WHO的君王 维尼梗有害 习付 墙内人 屎禁评 习Core 梦帝 蹄防 灭共助推器 恐惊天上人 外交习语 不同意的举手##没有##没有 卡近菲 习二坐船 当代秦二世 清华毕业 习大犬 庆丰称帝 官僚主义 夶 颐指气使 国王 習敗敗 习大郎 支那毒王 狙击手待命 习像章 喜包皮 習敗北 吸精瓶 鞋哥 毛进平 A##Big##Deal 十日文革 一带一路 彩色熊 劝进 ChinaXi 总书记来我家 不强自息 次级乳包 形式主义防疫 “登机”（与登基同音） 人均接近八千万 Heil##Xitler 读稿机 戏博士 大兔 习猪下台 疫情蔓延 包子病毒 影子末帝 习张三丰 九大诉求 信女愿一生吃素 习公奭 維尼頌 维尼写史 晚共昏君 读书单 习是春绿 送礼平 动物森友会 岿然不动 10号跳跳虎被维尼拉清单 骑巨龙 尼哥 习尿瓶 习二胖 迈克尔·索伊 坡涛汹涌 朝令夕改 动物之森 超邓赶毛 习低能儿 刁近乎 毛二 习厉王 百万雄师事件 东瘟疫之地统治者暨全境守护者 习emperor 习思想 Voice##of##Pooh 二百五大帝 厕所革命 习条英机 维尼熊给跳跳虎黄牌 口罩大会 感恩教育 赵人13 习夶 维尼警察（X） 武汉委托李克强 洗包皮 包包侠 当皇帝的小丑 阿道夫-习 习宽衣 习兵法 闹得欢 花花公子 那翠化 “习泽东”和“洪宪”（袁世凯的帝号） 包帝巡游 截颈平 毛孙 习犬犬 粪坑兵法 习家军 头号球迷 习驴 黑白翠 倒车斯基 386系统驱动游戏 习武帝 人民战争 核平全世界 习屎黄 毛近平 没规划的葬礼 习远凸 青年大学包 五毛主席 称帝修宪 电脑世代586 世宗 断崖式下跌 家业论 习大林 习歪嘴 袭包皮 不知名氏 宰相 冰棒外交 糟糕皇帝 习索里尼 万岁 平平 爱新觉罗·近平 洗尽贫 维尼DISCO 墨索里习 尊蛤讨包 维稳警察（O） 习猪头 翡翠娘娘 刁近猴 习语录 文明其精神 习近砰 蔡英文最强助选 维持会长 时间控制 习言乱语 满脸喷粪 神明论 毛魔转世 刁二将 动物庄园 乳包文化 无限连任 大国造疫 习正日 nmslman（习主席） 红二代 腊肉馅儿包子 共哀宗 野兽主席 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 没有网络安全就没有国家安全 习废帝 哲欣 号屎洞 习梦撕 西朝鲜人民自治岛 刁斤山 禁评的理由 习狍 xdd 习贼 习##卡##巴##卡 嘻包皮 宽衣帝 倒车帝 习大 习包皮 格萨尔 习下台 喷粪帝 野兽先辈 4中组长 云视察 维尼·屎(Winnie##the##Poo) 惜包皮 Criminal##Xi##"Xitler"##Jinping 亲自脱贫 刁斤二 习大乞 人尽皆知的体育迷 视频看望 独彩者 维尼带货 nmslese##dream 梁家河 毛装 连专家也为之叹服的电脑天才 法习斯 习皇的新装 日子像蜜甜 扛麦帝 武当七侠的政治斗争 孤独的毒王 vop 甩锅侠 皇帝亲临忠诚的武汉 近身平A 野蛮其体魄 裹嘎举吸钢闸门 人民领袖 第22条军规 九评 维尼史 梦回大清 两会期间+隐瞒 糖尿维尼 倒车 习博士 玉习大帝 金科律玉 不敢高声语 亲自封号 习近平光辉形象 习后主 集金币 习核心 平&强 初二圣君 瘟疫领主习近平 禁评封号 儿童习典 富平学霸刁斤干 吸包皮 修宪连任 黄俄 禁评大帝 万岁来武汉 最后领导人 SB包子 习二卒 “黄袍加身” 戏包皮 亲自删评 习习蛤蛤 狙击手待命 刁后主 赵弹 通商宽衣 系包皮 通商宽衣 动森 韦来书记 习瘟猪 细瓶颈 包子兵法 叩谢习恩 习老八 习二二（二零二零年五月二十二日开二会） 大大品牌 席子兵法 V尼哥 习和谐 Adolf##Xitler 公车上书 法外狂徒Lucy（德国） 沼气专家 中字头组长 太祖兔 皇帝梦 氼兲嫑炛 头上三尺有神明 习殡法 御板泽民 中国爱非洲 冤大头 习二蛋 梁家河贵族 叩谢习恩 习式病毒 席近平 习“甩锅” 中国离岸隐匿资产管理工作领导小组组组长 中国的新皇帝 Corona##Xi（习病毒） 习呆呆 退党 维尼大帝 刁人13 亲自指挥疫情 XDD 粪坑先生 shit侯 习皇帝 胡志平 中国特色射秽煮疫制度 冲塔 XD 习梦死 包子宪法 中国离岸隐匿资产管理工作领导小组组组长 隔离”的金葫芦 贬词包用 主席+终身制 习病法 游泳一千米 皇帝的新衣 习禁评 世界最强乞丐 NMSL 习包子的Fa bingbang帝 赵王 习时代 人类命运共同体首席架构师 孢 每日祈翠 习孢子 昆明湖涨潮 塔西佗陷阱 习侯 错误执行者 当代秦始皇 老街 乳制品 纳翠党 习得梁家书卷 添宪宝宝 支那精神野爹 独裁者 屎進瓶 相信有神论的物理学博士 习特勒 大大招牌 役民五术 悉包皮 老歪脖子树 扛麦郎 习进棺 习总 巴拿马文件 邪大大 半羽习近平 重地之战 习流氓 习猪席 习三点 親自蒞臨 戴口赵 包子露宪 shit禁评 红旗下的蛋 字共狗 习尔布特 “梦回大清” “登基” 耀眼黄红黄 崇祯帝 shit##hole##bing##fa 新影帝 清单帝 乳透社##小反旗 捐麦子 “复辟” 疯狂宇宙 号尿壶公 背书单 720事件 2020全面小康 Chairman##Xi 共哀宗 习匪帝 赵付 维尼快乐组织（Winnie##Happy##Organization）简称WHO 习一尊 食腐虫 我是一个足球迷 现任匪首 战“疫”金句 亲自指挥 20000T麦子 一天游泳一千米 领袖习澡水 吃赵弹 爱新觉罗近平 恩维尔·霍习 习达姆 习包子 习太孑 习三拍 “无罩”现身 刁二婚 嬉包皮 民进党 普习金 平话 匪酋习维尼 崇祯 战疫国 任大炮 virus##king Mr##Shithole 习背书 習大佬 冠子兵法 帝皇頌 拉清单 抗麦套装 习奥赛斯库 习梦思 习king 亲自考察 假.."~bang！卒 北红尾鸲 赵家家仆 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 恩重如删 灰习牛 讨习檄文 总书记来过我的家 Cicada##3301##XD 人民领袖 大锅瞻遗 习蛤 你是反贼吗 包皇 天安门合法继承人 集金pay The##Xi##Factor（习近平因素） 包禁评 维尼熊 200吨 疯狂宇宙包 总加速师 親自視頻 傻大头 刁槑夶尛 小学博士 口罩外交 赛禁评 集近闭 CoronaXi 十一郎习近平 彭主席（习主席走了太太接班） 任志强 学包率 基拉大和习近平 阳台上的哨兵 包经 中国首席造梦大师 屎侯 细颈瓶 阿平 大海掀翻小池塘 祈翠語言包 习王的田野上 央视姓党 皇帝亲临忠诚的武汉 习包子 总统包子习 修宪 羽日帝 慨撒大帝 坟头蹦迪 维尼挂彩 东方project 坡涛汹涌 刁人13 习二世胡亥 撒币宝 孙笑川 毛二习 维尼之声 狙击手布阵 包子金刚腿 追思焦裕禄 瘟疫降生习近平 近日成 北京中南海支部书记 袁世凯第二 维尼连任 习匪 毛二世 做N届的主席 包包大人 国贼习近平 */
package com.pcdd.sonovel.util;

import cn.hutool.core.util.StrUtil;
import cn.hutool.script.ScriptUtil;
import com.pcdd.sonovel.model.ContentType;
import lombok.experimental.UtilityClass;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import static com.pcdd.sonovel.model.ContentType.*;

@UtilityClass
public class JsoupUtils {

    // JS 分隔符
    private static final String JS_SEPARATOR = "@js:";

    /**
     * 使用查询条件选择元素
     * <p>
     * 等价于 document.select(query) | document.selectXpath(query)
     */
    public Elements select(Element e, String query) {
        // 分割查询条件以提取 XPath 或 CSS 查询
        String actualQuery = StrUtil.subBefore(query, JS_SEPARATOR, false);
        // 根据查询条件选择元素
        return actualQuery.matches("^(/|//|\\(/).*") ? e.selectXpath(actualQuery) : e.select(actualQuery);
    }

    /**
     * 执行 JS 脚本并返回处理结果
     * <p>
     * 等价于 func(input)
     */
    public String invokeJs(String query, String input) {
        if (StrUtil.isEmpty(query)) return input;
        // @js:
        String[] split = query.split(JS_SEPARATOR);
        if (split.length == 1) {
            return input;
        }
        return (String) ScriptUtil.invoke("""
                function func(r) {
                    %s
                    return r;
                }
                """.formatted(split[1]), "func", input);
    }

    public String selectAndInvokeJs(Element e, String query) {
        return selectAndInvokeJs(e, query, ContentType.TEXT);
    }

    /**
     * 根据查询条件选择元素并执行可能的 JS 脚本
     * <p>
     * 等价于 func(document.select(query).(text|html|attr)())
     */
    public String selectAndInvokeJs(Element e, String query, ContentType contentType) {
        if (StrUtil.isEmpty(query) || contentType == null) {
            return null;
        }

        String[] split = query.split(JS_SEPARATOR);
        String actualQuery = split[0];

        // 根据查询条件选择元素
        Elements elements = select(e, actualQuery);
        if (elements.isEmpty()) return "";

        // 获取选中元素的内容
        String result = getContents(elements, contentType);

        // 如果查询条件包含 JS，调用它
        return split.length == 2 ? invokeJs(query, result) : result;
    }

    /**
     * 获取元素的内容并执行可能的 JS
     * <p>
     * 等价于 func(element.(text|html|attr)())
     */
    public String getStrAndInvokeJs(Element e, String js, ContentType contentType) {
        // 先获取元素的内容
        String result = getContent(e, contentType);
        // 如果查询条件包含 JS，调用它
        return StrUtil.isNotEmpty(js) ? invokeJs(js, result) : result;
    }

    /**
     * 获取单个元素的内容
     */
    public String getContent(Element el, ContentType contentType) {
        return getContentByType(el, contentType);
    }

    /**
     * 获取多个元素的内容
     */
    private String getContents(Elements els, ContentType contentType) {
        return getContentByType(els, contentType);
    }

    /**
     * 提取内容的公共方法
     */
    private String getContentByType(Object obj, ContentType contentType) {
        if (obj instanceof Element el) {
            return switch (contentType) {
                case TEXT -> el.text();
                case HTML -> el.html();
                case ATTR_SRC -> el.attr(ATTR_SRC.getValue());
                case ATTR_HREF -> el.attr(ATTR_HREF.getValue());
                case ATTR_CONTENT -> el.attr(ATTR_CONTENT.getValue());
                case ATTR_VALUE -> el.attr(ATTR_VALUE.getValue());
            };
        } else if (obj instanceof Elements els) {
            return switch (contentType) {
                case TEXT -> els.text();
                case HTML -> els.html();
                case ATTR_SRC -> els.attr(ATTR_SRC.getValue());
                case ATTR_HREF -> els.attr(ATTR_HREF.getValue());
                case ATTR_CONTENT -> els.attr(ATTR_CONTENT.getValue());
                case ATTR_VALUE -> els.attr(ATTR_VALUE.getValue());
            };
        }
        return "";
    }

}