/* 狙击手待命 号尿壶公 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 大国造疫 头号球迷 文明其精神 皇帝梦 粪坑兵法 普习金 习狍 习王的田野上 “皇帝梦” 喷粪帝 视频看望 維尼頌 习猪头 刁大犬 袁世凯第二 野兽先辈 读书单 崇祯 包禁评 富平学霸刁斤干 屎禁评 习Core 大大招牌 “梦回大清” 习近平光辉形象 习犬犬 习得梁家书卷 习侯 习兵法 维尼警察（X） 无限连任 习付 平&强 习式病毒 集金币 毛孙 中国爱非洲 彩色熊 习流氓 口罩大会 天安门合法继承人 巴拿马文件 习皇帝 电脑世代586 亲自考察 维尼大帝 主席+终身制 野心习 习包子 维持会长 大兔 追思焦裕禄 送礼平 庆丰包·勃列日涅夫 习包子 彩色哥 民进党 万岁 翡翠娘娘 人尽皆知的体育迷 拉清单 黑白翠 阿平 “登机”（与登基同音） 习大 闹得欢 迈克尔·索伊 塔西佗陷阱 孢 号屎洞 集金pay 习公奭 猪禁评 邪大大 习呆呆 洗尽贫 尊蛤讨包 习语 vop 维尼连任 shit##hole##bing##fa 坟头蹦迪 添宪宝宝 超邓赶毛 支那毒王 小习微信 官僚主义 庆丰废物 满脸喷粪 厕所革命 乳包文化 错误执行者 乳透社##小反旗 清单帝 习废帝 包子宪法 发皇帝梦 九大诉求 疯狂宇宙包 习##卡##巴##卡 形式主义防疫 习进棺 nmslese##dream 习二二（二零二零年五月二十二日开二会） 截颈平 习大犬 2020全面小康 糟糕皇帝 习二胖 白猪 墨索里习 终身领导人 习索里尼 包子兵法 骑巨龙 袭包皮 大锅瞻遗 慨撒大帝 不知名氏 任大炮 亲自脱贫 恩重如删 基拉大和习近平 现任匪首 鞋哥 宽衣帝 200吨 通商宽衣 V尼哥 习语录 恐惊天上人 刁后主 枪毙名单 习条英机 西朝鲜人民自治岛 赵王 通商宽衣 第一书记王沪宁 习孢子 习达姆 普近 包皇 秦城监狱 老歪脖子树 扛麦郎 维尼熊 狙击手布阵 野兽主席 百万雄师事件 习宽衣 一带一路 毛进平 法外狂徒Lucy（德国） 扛麦帝 武统时代 断崖式下跌 彭主席（习主席走了太太接班） 中国离岸隐匿资产管理工作领导小组组组长 皇帝的新衣 学包分子 青年大学包 哲欣 毛二 洗包皮 小学居士 战“疫”金句 刁斤二 习尔布特 吸包皮 太祖兔 习近砰 役民五术 Criminal##Xi##"Xitler"##Jinping 食腐虫 平话 习夶 共哀宗 头上三尺有神明 宰相 习一尊 禁评封号 习梦撕 次级乳包 習敗敗 十一郎习近平 疫情蔓延 䒒(tiáo)菦(qín)苹(píng) 狙击手待命 “复辟” 习三拍 习瘟猪 恩维尔·霍习 习包子 习病法 习厉王 中国特色射秽煮疫制度 “无罩”现身 戏包皮 修宪 专治各种不服 “黄袍加身” 动物森友会 独彩者 御板泽民 国贼习近平 领袖习澡水 疯狂宇宙 纳翠党 嬉包皮 足球外交 昆明湖涨潮 粪坑先生 墙内人 习二蛋 近日成 贬词包用 维尼DISCO 习驴 习正日 九评 Cicada##3301##XD 万岁来武汉 独裁者 书单吟诵者 金科律玉 劝进 亲自删评 瘟疫领主习近平 东方project 人民领袖 总加速师 没规划的葬礼 万岁来武汉了 一天游泳一千米 晚共昏君 中国拉清单工作领导小组组长 习言乱语 庆丰帝的千秋梦 学包积极分子 习大帝 习是春竹 习躲躲 习教父 A##Big##Deal 红旗下的蛋 CoronaXi 惜包皮 720事件 两会期间+隐瞒 相信有神论的物理学博士 卡近菲 儿童习典 喜包皮 梁家河贵族 格萨尔 习思想 Chairman##Xi 维尼挂彩 智商不重要 习背书 刁人13 WHO的君王 20000T麦子 赛禁评 总书记来过我的家 习奥赛斯库 shuu##kinn##pei 隔离”的金葫芦 习习蛤蛤 感恩教育 川普的朋友or敌人 当皇帝的小丑 公车上书 习king 习卒 Mr##Shithole 祈翠 裸宽包子劾心 蹄防 习匪帝 毛魔转世 禁评的理由 冠子兵法 支那精神野爹 Voice##of##Pooh virus##king 习梦思 平平 习和谐 习二卒 毛二习 武当七侠的政治斗争 倒车斯基 XD 坡涛汹涌 戴口赵 习特勒 神明论 习贼 阿道夫-习 影子末帝 冲塔 北京中南海支部书记 皇帝亲临忠诚的武汉 清华毕业 云视察 武汉委托李克强 耀眼黄红黄 细瓶颈 4中组长 Adolf##Xitler 称帝修宪 包子病毒 包经 习核心 Corona##Xi（习病毒） 习总输记 冰棒外交 战疫国 习时代 假.."~bang！卒 核平全世界 习是春绿 爱新觉罗·近平 亲自指挥疫情 世界最强乞丐 任志强 冤大头 electron8964 红二代 朝令夕改 梦帝 撒币宝 SB包子 维尼写史 习梦死 讨习檄文 不强自息 家业论 習敗北 人均接近八千万 维尼史 系包皮 刁槑夶尛 毛近平 灭共助推器 新影帝 习下台 夶 xdd 十日文革 习大林 最后领导人 尼哥 央视姓党 这个年很静 维尼·屎(Winnie##the##Poo) 抗麦套装 做N届的主席 親自蒞臨 背书单 近言 赵弹 蔡英文最强助选 大撒币 刁近乎 糖尿维尼 ChinaXi 习奥塞斯库 親自視頻 退党 瘟疫降生习近平 包惠帝 维尼梗有害 动物之森 XDD 习emperor 时间控制 习匪 当代秦始皇 黄俄 韦来书记 小学博士 维尼快乐组织（Winnie##Happy##Organization）简称WHO 维尼之声 东瘟疫之地统治者暨全境守护者 口罩外交 Heil##Xitler 连专家也为之叹服的电脑天才 刁人13 中国离岸隐匿资产管理工作领导小组组组长 刁二将 刁二婚 我是一个足球迷 悉包皮 习二世胡亥 仲夏夜之中国梦 亲自封号 包帝巡游 中字头组长 读稿机 shit禁评 主席贺词 习包子的Fa 世宗 指定接班人 梦回大清 颐指气使 祈翠語言包 屎進瓶 刁远山 不敢高声语 赵人13 毛装 亲自指挥 習大佬 nmslman（习主席） 疯狂宇宙大帝 习大乞 习澳塞斯库 那翠化 习歪嘴 动森 习张三丰 习包皮 叩谢习恩 bingbang帝 大海掀翻小池塘 胡志平 共哀宗 人民战争 刁近猴 习禁评 倒车帝 中国首席造梦大师 包子金刚腿 席近平 习像章 颐使气指 64岁 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 孙笑川 《生物安全法》 没有网络安全就没有国家安全 老街 日子像蜜甜 大大品牌 屎侯 当代秦二世 NMSL 爱新觉罗近平 习殡法 习皇的新装 腊肉馅儿包子 乳制品 习太孑 不同意的举手##没有##没有 叼斤干 10号跳跳虎被维尼拉清单 “登基” 习低能儿 赵付 甩锅侠 花花公子 岿然不动 梁家河 习家军 戏博士 吸精瓶 包包大人 习远凸 羽日帝 匪酋习维尼 习屎黄 包包侠 包子露宪 北红尾鸲 习老八 裹嘎举吸钢闸门 叩谢习恩 习猪席 阳台上的哨兵 人类命运共同体首席架构师 腊肉包 法习斯 集近闭 习后主 包大人 游泳一千米 毛二世 “习泽东”和“洪宪”（袁世凯的帝号） 氼兲嫑炛 皇帝亲临忠诚的武汉 半羽习近平 信女愿一生吃素 庆丰称帝 席子兵法 每日祈翠 坡涛汹涌 维尼带货 傻大头 重地之战 沼气专家 修宪连任 灰习牛 习武帝 细颈瓶 习猪下台 赵家家仆 习卒习 倒车 近身平A 习总 国王 386系统驱动游戏 帝皇頌 大撒幣 习博士 外交习语 学包率 中国的新皇帝 维稳警察（O） The##Xi##Factor（习近平因素） 习“甩锅” 动物庄园 第22条军规 孤独的毒王 嘻包皮 末代皇帝 你是反贼吗 字共狗 刁斤山 习蛤 二百五大帝 习二坐船 崇祯帝 禁评大帝 人民领袖 捐麦子 五毛主席 shit侯 习大郎 野蛮其体魄 维尼熊给跳跳虎黄牌 总书记来我家 初二圣君 习尿瓶 吃赵弹 习三点 大撒币 总统包子习 玉习大帝 */
package com.pcdd.sonovel;

import cn.hutool.core.lang.Console;
import cn.hutool.core.lang.ConsoleTable;
import cn.hutool.core.util.StrUtil;
import cn.hutool.json.JSONUtil;
import cn.hutool.log.dialect.console.ConsoleLog;
import cn.hutool.log.level.Level;
import cn.hutool.setting.Setting;
import com.pcdd.sonovel.action.BatchDownloadAction;
import com.pcdd.sonovel.action.CheckUpdateAction;
import com.pcdd.sonovel.action.SearchAndDownloadAction;
import com.pcdd.sonovel.action.ShowSourcesAction;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.util.ConfigUtils;
import lombok.SneakyThrows;
import org.jline.reader.LineReader;
import org.jline.reader.LineReaderBuilder;
import org.jline.reader.impl.completer.StringsCompleter;
import org.jline.terminal.Terminal;
import org.jline.terminal.TerminalBuilder;

import java.io.File;
import java.util.List;
import java.util.Scanner;

import static org.fusesource.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2021/6/10
 * <p>
 * {@code mvnd clean compile && mvn exec:java}
 * <p>
 * {@code mvnd clean compile; mvn exec:java}
 */
public class Main {

    public static final List<String> options = List.of(
            "0.结束程序",
            "1.搜索下载",
            "2.检查更新",
            "3.书源一览",
            "4.使用须知",
            "5.查看配置文件",
            "6.批量下载"
    );

    static {
        // release 前改为 Level.OFF
        ConsoleLog.setLevel(Level.OFF);
    }

    private static AppConfig config = ConfigUtils.config();

    public static void main(String[] args) {
        watchConfig();
        if (config.getAutoUpdate() == 1) {
            new CheckUpdateAction(5000).execute();
        }
        if (config.getInteractiveMode() == 1) {
            inputMode();
        } else if (config.getInteractiveMode() == 2) {
            selectMode();
        } else {
            inputMode();
        }
    }

    @SneakyThrows
    private static void inputMode() {
        Terminal terminal = TerminalBuilder.builder()
                .system(true)
                .build();
        Scanner sc = Console.scanner();
        printHint();

        while (true) {
            Console.log("\n" + StrUtil.join(" ", options));
            Console.print("==> 请输入功能序号: ");
            String cmd = sc.nextLine();

            if ("0".equals(cmd)) {
                Console.log("<== Bye :)");
                System.exit(0);
                break;
            } else if ("1".equals(cmd)) {
                new SearchAndDownloadAction(config).execute(terminal);
            } else if ("2".equals(cmd)) {
                new CheckUpdateAction().execute();
            } else if ("3".equals(cmd)) {
                new ShowSourcesAction().execute();
            } else if ("4".equals(cmd)) {
                printHint();
            } else if ("5".equals(cmd)) {
                Console.log(JSONUtil.toJsonPrettyStr(config));
            } else if ("6".equals(cmd)) {
                new BatchDownloadAction(config).execute();
            } else {
                Console.error("无效的选项，请重新输入");
            }
        }
    }

    @SneakyThrows
    private static void selectMode() {
        Terminal terminal = TerminalBuilder.builder()
                .system(true)
                .build();
        LineReader reader = LineReaderBuilder.builder()
                .terminal(terminal)
                .completer(new StringsCompleter(options))
                .build();

        printHint();

        while (true) {
            String cmd = reader.readLine("按 Tab 键选择功能: ").strip();

            if (!options.contains(cmd)) {
                Console.error("无效的选项，请重新选择");
            }
            if (options.get(0).equals(cmd)) {
                Console.log("<== Bye :)");
                System.exit(0);
                break;
            }
            if (options.get(1).equals(cmd)) {
                new SearchAndDownloadAction(config).execute(terminal);
            }
            if (options.get(2).equals(cmd)) {
                new CheckUpdateAction().execute();
            }
            if (options.get(3).equals(cmd)) {
                new ShowSourcesAction().execute();
            }
            if (options.get(4).equals(cmd)) {
                printHint();
            }
            if (options.get(5).equals(cmd)) {
                Console.log(JSONUtil.toJsonPrettyStr(config));
            }
            if (options.get(6).equals(cmd)) {
                new BatchDownloadAction(config).execute();
            }
        }

        terminal.close();
    }

    private static void printHint() {
        Rule r = new Source(config).rule;
        Console.table(ConsoleTable.create()
                // 是否转为全角
                .setSBCMode(false)
                .addHeader(render(StrUtil.format("@|BG_blue,ITALIC,BOLD  so-novel v{} |@", config.getVersion())) + "（本项目开源且免费）")
                .addHeader("官方地址：https://github.com/freeok/so-novel")
                .addHeader(StrUtil.format("当前书源：{} ({} ID: {})", r.getUrl(), r.getName(), r.getId()))
                .addHeader(render("导出格式：@|blue " + config.getExtName() + "|@"))
                .addBody(render("@|yellow 使用前请务必阅读 readme.txt|@"))
        );
    }

    private static void watchConfig() {
        String path = System.getProperty("user.dir") + File.separator + "config.ini";
        Setting setting = new Setting(path);
        // 监听配置文件
        setting.autoLoad(true, aBoolean -> {
            config = ConfigUtils.config();
            Console.log("<== 配置文件修改成功！");
            printHint();
        });
    }

}