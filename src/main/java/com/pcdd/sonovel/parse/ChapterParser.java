/* 习包皮 包大人 习武帝 没有网络安全就没有国家安全 “无罩”现身 人民领袖 shit##hole##bing##fa 近身平A 中国离岸隐匿资产管理工作领导小组组组长 系包皮 4中组长 大兔 猪禁评 禁评大帝 集金币 塔西佗陷阱 次级乳包 习太孑 青年大学包 我是一个足球迷 “皇帝梦” 䒒(tiáo)菦(qín)苹(píng) 万岁来武汉 包子露宪 普近 当代秦始皇 每日祈翠 腊肉馅儿包子 扛麦郎 XD 裸宽包子劾心 一带一路 贬词包用 二百五大帝 梦帝 习总 儿童习典 大海掀翻小池塘 头上三尺有神明 刁二将 包包侠 2020全面小康 重地之战 亲自指挥疫情 禁评封号 小习微信 闹得欢 习厉王 习下台 维尼梗有害 武统时代 百万雄师事件 总书记来过我的家 习病法 格萨尔 习近平光辉形象 最后领导人 习教父 通商宽衣 骑巨龙 晚共昏君 维尼挂彩 韦来书记 傻大头 10号跳跳虎被维尼拉清单 屎進瓶 相信有神论的物理学博士 洗包皮 颐使气指 习张三丰 维尼之声 专治各种不服 叼斤干 吸包皮 習敗敗 “梦回大清” 西朝鲜人民自治岛 新影帝 习流氓 人民领袖 翡翠娘娘 习进棺 Cicada##3301##XD 国王 习二卒 习贼 中国离岸隐匿资产管理工作领导小组组组长 毛装 刁大犬 倒车帝 包包大人 xdd 黄俄 近日成 習大佬 野心习 满脸喷粪 任大炮 袭包皮 瘟疫降生习近平 vop 截颈平 Criminal##Xi##"Xitler"##Jinping 疯狂宇宙包 毛二 赵付 红二代 背书单 官僚主义 民进党 彩色哥 乳包文化 习奥赛斯库 习呆呆 200吨 习猪头 bingbang帝 乳制品 习卒习 维尼快乐组织（Winnie##Happy##Organization）简称WHO 影子末帝 五毛主席 维尼带货 总加速师 读稿机 粪坑兵法 半羽习近平 厕所革命 发皇帝梦 耀眼黄红黄 维尼熊 动物森友会 当代秦二世 习三点 维尼史 纳翠党 叩谢习恩 捐麦子 恐惊天上人 习驴 习蛤 赵人13 Adolf##Xitler 祈翠 毛进平 万岁 不敢高声语 大大招牌 Corona##Xi（习病毒） 世宗 习大乞 习得梁家书卷 “复辟” 视频看望 维持会长 20000T麦子 习核心 学包分子 武汉委托李克强 64岁 习皇的新装 墨索里习 昆明湖涨潮 初二圣君 平话 坡涛汹涌 糟糕皇帝 习包子 习时代 拉清单 亲自指挥 shit侯 胡志平 读书单 世界最强乞丐 阿平 习低能儿 错误执行者 大撒币 习式病毒 你是反贼吗 A##Big##Deal 乳透社##小反旗 习思想 席子兵法 习大郎 仲夏夜之中国梦 毛二世 吃赵弹 习习蛤蛤 号屎洞 刁人13 386系统驱动游戏 央视姓党 灭共助推器 习背书 刁二婚 玉习大帝 扛麦帝 墙内人 慨撒大帝 腊肉包 习大犬 习梦思 “登机”（与登基同音） 庆丰废物 国贼习近平 疯狂宇宙大帝 皇帝亲临忠诚的武汉 抗麦套装 修宪 主席贺词 习犬犬 刁斤山 现任匪首 席近平 朝令夕改 中字头组长 皇帝亲临忠诚的武汉 惜包皮 哲欣 习是春绿 习包子的Fa 瘟疫领主习近平 公车上书 小学博士 北京中南海支部书记 法习斯 习三拍 感恩教育 习是春竹 习包子 毛魔转世 细颈瓶 共哀宗 独彩者 中国特色射秽煮疫制度 一天游泳一千米 爱新觉罗·近平 习二世胡亥 NMSL “黄袍加身” 这个年很静 吸精瓶 战疫国 红旗下的蛋 孙笑川 WHO的君王 彩色熊 习二二（二零二零年五月二十二日开二会） 刁人13 甩锅侠 号尿壶公 帝皇頌 东瘟疫之地统治者暨全境守护者 基拉大和习近平 尼哥 学包积极分子 习狍 习二坐船 庆丰帝的千秋梦 疫情蔓延 送礼平 十一郎习近平 裹嘎举吸钢闸门 习宽衣 劝进 恩维尔·霍习 糖尿维尼 超邓赶毛 崇祯帝 独裁者 electron8964 维尼DISCO 人均接近八千万 习兵法 习近砰 宽衣帝 习大 祈翠語言包 大国造疫 习条英机 nmslese##dream 中国爱非洲 人类命运共同体首席架构师 习匪 戴口赵 时间控制 shuu##kinn##pei 习孢子 邪大大 白猪 头号球迷 习语录 狙击手待命 役民五术 袁世凯第二 粪坑先生 习付 氼兲嫑炛 游泳一千米 ChinaXi 亲自考察 形式主义防疫 “登基” 足球外交 刁斤二 岿然不动 刁近乎 沼气专家 习瘟猪 刁后主 细瓶颈 赵王 川普的朋友or敌人 退党 巴拿马文件 virus##king 习老八 家业论 动物庄园 喷粪帝 第一书记王沪宁 习梦死 断崖式下跌 习正日 維尼頌 The##Xi##Factor（习近平因素） 神明论 阳台上的哨兵 包子病毒 孢 中国首席造梦大师 通商宽衣 日子像蜜甜 屎侯 大锅瞻遗 亲自脱贫 核平全世界 习言乱语 习家军 习猪席 小学居士 平&强 习##卡##巴##卡 称帝修宪 习尔布特 包皇 字共狗 嘻包皮 习emperor 北红尾鸲 灰习牛 冰棒外交 御板泽民 鞋哥 蔡英文最强助选 终身领导人 梁家河 大撒幣 集金pay 冲塔 习总输记 没规划的葬礼 习和谐 万岁来武汉了 禁评的理由 那翠化 修宪连任 親自視頻 倒车斯基 习一尊 习侯 野蛮其体魄 共哀宗 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 支那毒王 习像章 崇祯 梦回大清 刁远山 法外狂徒Lucy（德国） XDD 隔离”的金葫芦 人民战争 动物之森 屎禁评 親自蒞臨 720事件 Mr##Shithole “习泽东”和“洪宪”（袁世凯的帝号） 习博士 习Core 添宪宝宝 毛孙 总统包子习 野兽先辈 冤大头 花花公子 口罩外交 维尼警察（X） 习尿瓶 撒币宝 坟头蹦迪 习澳塞斯库 习二胖 两会期间+隐瞒 疯狂宇宙 《生物安全法》 赵弹 武当七侠的政治斗争 维尼连任 庆丰称帝 羽日帝 习禁评 习废帝 赛禁评 老歪脖子树 冠子兵法 中国拉清单工作领导小组组长 九大诉求 习夶 习特勒 外交习语 富平学霸刁斤干 彭主席（习主席走了太太接班） 枪毙名单 清华毕业 Voice##of##Pooh Chairman##Xi 毛近平 大大品牌 习索里尼 shit禁评 習敗北 信女愿一生吃素 任志强 战“疫”金句 SB包子 秦城监狱 包经 戏博士 习king nmslman（习主席） 习屎黄 老街 习“甩锅” 第22条军规 领袖习澡水 习语 习包子 皇帝的新衣 平平 追思焦裕禄 夶 习猪下台 庆丰包·勃列日涅夫 颐指气使 迈克尔·索伊 维尼熊给跳跳虎黄牌 不知名氏 东方project CoronaXi 习皇帝 习躲躲 喜包皮 书单吟诵者 坡涛汹涌 维尼大帝 习大帝 太祖兔 V尼哥 亲自删评 天安门合法继承人 电脑世代586 不同意的举手##没有##没有 集近闭 赵家家仆 习二蛋 习殡法 智商不重要 指定接班人 爱新觉罗近平 洗尽贫 嬉包皮 口罩大会 大撒币 习远凸 包子金刚腿 习奥塞斯库 近言 不强自息 云视察 阿道夫-习 刁近猴 包禁评 维尼写史 习梦撕 连专家也为之叹服的电脑天才 孤独的毒王 黑白翠 九评 Heil##Xitler 维尼·屎(Winnie##the##Poo) 清单帝 叩谢习恩 包子宪法 习达姆 支那精神野爹 当皇帝的小丑 卡近菲 习卒 习公奭 食腐虫 做N届的主席 野兽主席 动森 亲自封号 包子兵法 尊蛤讨包 匪酋习维尼 习歪嘴 人尽皆知的体育迷 文明其精神 包帝巡游 包惠帝 讨习檄文 主席+终身制 学包率 中国的新皇帝 总书记来我家 狙击手布阵 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 金科律玉 戏包皮 梁家河贵族 狙击手待命 末代皇帝 假.."~bang！卒 恩重如删 习王的田野上 习匪帝 无限连任 悉包皮 普习金 习后主 倒车 皇帝梦 宰相 习大林 毛二习 蹄防 维稳警察（O） 刁槑夶尛 十日文革 */
package com.pcdd.sonovel.parse;

import cn.hutool.core.lang.Console;
import cn.hutool.core.util.StrUtil;
import com.pcdd.sonovel.convert.ChapterConverter;
import com.pcdd.sonovel.convert.ChineseConverter;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Chapter;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.model.SearchResult;
import com.pcdd.sonovel.util.CrawlUtils;
import com.pcdd.sonovel.util.JsoupUtils;
import lombok.SneakyThrows;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.nio.charset.StandardCharsets;
import java.util.concurrent.CountDownLatch;

/**
 * @author pcdd
 * Created at 2024/3/27
 */
public class ChapterParser extends Source {

    private final ChapterConverter chapterConverter;

    public ChapterParser(AppConfig config) {
        super(config);
        this.chapterConverter = new ChapterConverter(config);
    }

    // 用于测试
    @SneakyThrows
    public Chapter parse(Chapter chapter) {
        Document document = jsoup(chapter.getUrl())
                .timeout(this.rule.getChapter().getTimeout())
                .get();
        chapter.setTitle(document.select(this.rule.getChapter().getTitle()).text());
        chapter.setContent(crawl(chapter.getUrl(), 0));
        return chapter;
    }

    public Chapter parse(Chapter chapter, CountDownLatch latch, SearchResult sr) {
        try {
            long interval = CrawlUtils.randomInterval(config, false);
            Console.log("<== 正在下载: 【{}】 间隔 {} ms", chapter.getTitle(), interval);
            // ExceptionUtils.randomThrow();
            chapter.setContent(crawl(chapter.getUrl(), interval));
            latch.countDown();
            // 确保简繁互转最后调用
            return ChineseConverter.convert(chapterConverter.convert(chapter),
                    this.rule.getLanguage(), config.getLanguage());

        } catch (Exception e) {
            Chapter retryChapter = retry(chapter, latch, sr);
            if (retryChapter == null) {
                return null;
            }
            return ChineseConverter.convert(retryChapter, this.rule.getLanguage(), config.getLanguage());
        }
    }

    private Chapter retry(Chapter chapter, CountDownLatch latch, SearchResult sr) {
        for (int attempt = 1; attempt <= config.getMaxRetryAttempts(); attempt++) {
            try {
                long interval = CrawlUtils.randomInterval(config, true);
                Console.log("==> 章节下载失败，正在重试: 【{}】，尝试次数: {}/{}，重试间隔：{} ms",
                        chapter.getTitle(), attempt, config.getMaxRetryAttempts(), interval);
                chapter.setContent(crawl(chapter.getUrl(), interval));
                Console.log("<== 重试成功: 【{}】", chapter.getTitle());
                latch.countDown();
                return chapterConverter.convert(chapter);

            } catch (Exception e) {
                Console.error(e, "==> 第 {} 次重试失败: 【{}】，原因: {}", attempt, chapter.getTitle());
                if (attempt == config.getMaxRetryAttempts()) {
                    latch.countDown();
                    // 最终失败时记录日志
                    saveErrorLog(chapter, sr, e.getMessage());
                }
            }
        }

        return null;
    }

    /**
     * 爬取正文内容
     *
     * @param interval 爬取间隔
     */
    @SneakyThrows
    private String crawl(String url, long interval) {
        Rule.Chapter ruleChapter = this.rule.getChapter();
        Document document;
        Thread.sleep(interval);
        // 章节不分页，只请求一次
        if (!ruleChapter.isPagination()) {
            document = jsoup(url)
                    .timeout(ruleChapter.getTimeout())
                    .get();
            Elements contentEl = JsoupUtils.select(document, ruleChapter.getContent());

            // 删除每个元素的所有属性，防止标签和属性间的空格被后续清理，导致标签错误
            for (Element el : contentEl.select("*")) {
                el.clearAttributes();
            }

            return JsoupUtils.invokeJs(ruleChapter.getContent(), contentEl.html());
        }

        String nextUrl = url;
        StringBuilder sb = new StringBuilder();
        // 章节分页
        while (true) {
            document = jsoup(JsoupUtils.invokeJs(ruleChapter.getNextPage(), nextUrl))
                    .timeout(ruleChapter.getTimeout())
                    .get();
            sb.append(document.select(ruleChapter.getContent()).html());

            Elements elNextPage = JsoupUtils.select(document, ruleChapter.getNextPage());
            // 章节最后一页 TODO 针对书源 2，此处容易出错
            if (elNextPage.text().contains("下一章")) break;
            nextUrl = CrawlUtils.normalizeUrl(elNextPage.attr("href"), this.rule.getUrl());

            Thread.sleep(interval);
        }

        return sb.toString();
    }

    private void saveErrorLog(Chapter chapter, SearchResult sr, String errMsg) {
        String line = StrUtil.format("下载失败章节：【{}】({})，原因：{}", chapter.getTitle(), chapter.getUrl(), errMsg);
        String path = StrUtil.format("{}{}《{}》（{}）下载失败章节.log", config.getDownloadPath(), File.separator, sr.getBookName(), sr.getAuthor());

        try (PrintWriter pw = new PrintWriter(new FileWriter(path, StandardCharsets.UTF_8, true))) {
            // 自带换行符
            pw.println(line);

        } catch (IOException e) {
            Console.error(e);
        }
    }

}