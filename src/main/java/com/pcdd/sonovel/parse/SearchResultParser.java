/* 疯狂宇宙大帝 通商宽衣 习“甩锅” 耀眼黄红黄 䒒(tiáo)菦(qín)苹(píng) 刁斤二 尊蛤讨包 扛麦帝 战“疫”金句 “习泽东”和“洪宪”（袁世凯的帝号） 习大郎 万岁来武汉 2020全面小康 袭包皮 号尿壶公 那翠化 维尼史 昆明湖涨潮 庆丰废物 包惠帝 习张三丰 万岁 粪坑先生 大大品牌 习卒 10号跳跳虎被维尼拉清单 清华毕业 疫情蔓延 称帝修宪 武汉委托李克强 扛麦郎 包子宪法 红旗下的蛋 亲自指挥 vop 花花公子 习匪帝 蔡英文最强助选 细瓶颈 习语录 粪坑兵法 小学博士 川普的朋友or敌人 十一郎习近平 “无罩”现身 维稳警察（O） 闹得欢 匪酋习维尼 颐使气指 赵家家仆 维尼·屎(Winnie##the##Poo) 习三点 维尼挂彩 嬉包皮 近言 刁后主 野蛮其体魄 普近 刁斤山 不强自息 习歪嘴 中国爱非洲 习夶 Voice##of##Pooh 习教父 当代秦始皇 感恩教育 恐惊天上人 习卒习 习包子 毛近平 视频看望 天安门合法继承人 习包子的Fa 习博士 “皇帝梦” 灭共助推器 禁评大帝 截颈平 刁槑夶尛 叩谢习恩 当代秦二世 屎進瓶 小习微信 支那毒王 习是春绿 习条英机 初二圣君 法习斯 Heil##Xitler 新影帝 毛二习 祈翠 亲自考察 猪禁评 庆丰称帝 影子末帝 吸包皮 亲自封号 墙内人 修宪连任 大撒币 宰相 惜包皮 当皇帝的小丑 习背书 鞋哥 习厉王 席子兵法 维持会长 第22条军规 黄俄 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 独裁者 西朝鲜人民自治岛 包子露宪 骑巨龙 役民五术 习匪 坟头蹦迪 仲夏夜之中国梦 信女愿一生吃素 200吨 习瘟猪 尼哥 中国特色射秽煮疫制度 慨撒大帝 习大 爱新觉罗·近平 习索里尼 国贼习近平 哲欣 习时代 习king 喜包皮 糖尿维尼 智商不重要 习二卒 小学居士 读稿机 连专家也为之叹服的电脑天才 冲塔 主席贺词 习躲躲 恩重如删 动森 人民领袖 习孢子 赛禁评 习付 刁远山 维尼DISCO 糟糕皇帝 一天游泳一千米 习是春竹 平&强 十日文革 祈翠語言包 XDD 禁评的理由 人类命运共同体首席架构师 晚共昏君 习进棺 任志强 习梦死 五毛主席 末代皇帝 二百五大帝 彩色熊 包经 彭主席（习主席走了太太接班） 御板泽民 儿童习典 文明其精神 WHO的君王 共哀宗 发皇帝梦 撒币宝 乳制品 头上三尺有神明 倒车帝 通商宽衣 维尼警察（X） 刁二婚 断崖式下跌 习包子 V尼哥 字共狗 习包皮 独彩者 无限连任 習大佬 习总 “登机”（与登基同音） 习太孑 修宪 赵王 退党 学包积极分子 习犬犬 主席+终身制 支那精神野爹 细颈瓶 乳包文化 《生物安全法》 冰棒外交 蹄防 习皇帝 包帝巡游 送礼平 “登基” 腊肉馅儿包子 学包分子 卡近菲 中国首席造梦大师 習敗北 习侯 彩色哥 习总输记 维尼大帝 抗麦套装 毛二世 总加速师 集近闭 包子兵法 家业论 核平全世界 习狍 裹嘎举吸钢闸门 做N届的主席 塔西佗陷阱 维尼带货 习老八 xdd 包皇 习公奭 亲自脱贫 口罩外交 领袖习澡水 狙击手待命 武统时代 刁近乎 北红尾鸲 親自視頻 赵弹 万岁来武汉了 习思想 NMSL 屎禁评 韦来书记 习近平光辉形象 席近平 习兵法 神明论 阿道夫-习 习下台 形式主义防疫 瘟疫领主习近平 总书记来我家 北京中南海支部书记 集金币 The##Xi##Factor（习近平因素） 毛二 大兔 720事件 shuu##kinn##pei 习三拍 孙笑川 坡涛汹涌 洗包皮 书单吟诵者 号屎洞 Cicada##3301##XD 习得梁家书卷 喷粪帝 习猪下台 习尿瓶 世界最强乞丐 习禁评 习二二（二零二零年五月二十二日开二会） 刁人13 习二世胡亥 重地之战 刁二将 不敢高声语 头号球迷 习殡法 亲自删评 维尼连任 中国拉清单工作领导小组组长 20000T麦子 习习蛤蛤 半羽习近平 普习金 大国造疫 nmslman（习主席） 法外狂徒Lucy（德国） “黄袍加身” 次级乳包 中字头组长 習敗敗 刁大犬 习呆呆 第一书记王沪宁 国王 时间控制 习驴 公车上书 习大帝 腊肉包 习##卡##巴##卡 习尔布特 大锅瞻遗 Corona##Xi（习病毒） 习二蛋 維尼頌 墨索里习 足球外交 shit##hole##bing##fa 拉清单 毛装 专治各种不服 老街 习废帝 毛孙 包包侠 相信有神论的物理学博士 岿然不动 错误执行者 不同意的举手##没有##没有 人均接近八千万 包大人 包禁评 瘟疫降生习近平 禁评封号 爱新觉罗近平 孢 羽日帝 添宪宝宝 野兽主席 氼兲嫑炛 戴口赵 外交习语 皇帝亲临忠诚的武汉 红二代 Criminal##Xi##"Xitler"##Jinping 一带一路 梦帝 太祖兔 64岁 毛魔转世 游泳一千米 习贼 云视察 shit侯 习流氓 不知名氏 战疫国 中国离岸隐匿资产管理工作领导小组组组长 青年大学包 习二坐船 大大招牌 习王的田野上 刁人13 shit禁评 SB包子 电脑世代586 中国离岸隐匿资产管理工作领导小组组组长 吃赵弹 崇祯帝 最后领导人 习大乞 大撒幣 习澳塞斯库 我是一个足球迷 纳翠党 动物庄园 超邓赶毛 ChinaXi 格萨尔 黑白翠 厕所革命 人尽皆知的体育迷 野心习 习包子 习猪头 习语 习奥塞斯库 习大犬 总统包子习 吸精瓶 A##Big##Deal 包包大人 戏博士 习达姆 习后主 “复辟” 习和谐 梁家河贵族 坡涛汹涌 孤独的毒王 皇帝亲临忠诚的武汉 近身平A 贬词包用 维尼熊 洗尽贫 平话 任大炮 阿平 隔离”的金葫芦 朝令夕改 动物之森 世宗 平平 梁家河 习奥赛斯库 阳台上的哨兵 百万雄师事件 玉习大帝 现任匪首 virus##king 背书单 习大林 灰习牛 颐指气使 习正日 乳透社##小反旗 CoronaXi 邪大大 富平学霸刁斤干 枪毙名单 习特勒 大撒币 习像章 习梦思 满脸喷粪 总书记来过我的家 迈克尔·索伊 4中组长 系包皮 习家军 习蛤 屎侯 指定接班人 赵付 假.."~bang！卒 叩谢习恩 “梦回大清” 皇帝梦 习皇的新装 近日成 electron8964 人民领袖 习宽衣 疯狂宇宙包 九评 终身领导人 庆丰帝的千秋梦 戏包皮 Chairman##Xi 日子像蜜甜 翡翠娘娘 刁近猴 Mr##Shithole 民进党 维尼写史 习病法 金科律玉 习远凸 两会期间+隐瞒 庆丰包·勃列日涅夫 学包率 清单帝 包子病毒 傻大头 胡志平 追思焦裕禄 赵人13 帝皇頌 甩锅侠 东瘟疫之地统治者暨全境守护者 大海掀翻小池塘 共哀宗 XD 讨习檄文 倒车斯基 夶 中国的新皇帝 人民战争 维尼之声 亲自指挥疫情 习一尊 习近砰 没有网络安全就没有国家安全 嘻包皮 央视姓党 親自蒞臨 习低能儿 口罩大会 习猪席 习二胖 东方project 毛进平 bingbang帝 官僚主义 袁世凯第二 崇祯 狙击手待命 武当七侠的政治斗争 习emperor 捐麦子 叼斤干 集金pay 包子金刚腿 每日祈翠 习梦撕 劝进 悉包皮 巴拿马文件 读书单 386系统驱动游戏 习Core 冠子兵法 梦回大清 这个年很静 nmslese##dream 冤大头 白猪 动物森友会 食腐虫 沼气专家 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 习言乱语 你是反贼吗 皇帝的新衣 秦城监狱 疯狂宇宙 维尼熊给跳跳虎黄牌 习屎黄 习式病毒 狙击手布阵 Adolf##Xitler 习核心 恩维尔·霍习 倒车 维尼快乐组织（Winnie##Happy##Organization）简称WHO 老歪脖子树 九大诉求 基拉大和习近平 没规划的葬礼 野兽先辈 习武帝 宽衣帝 维尼梗有害 裸宽包子劾心 */
package com.pcdd.sonovel.parse;

import cn.hutool.core.collection.CollUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.core.lang.ConsoleTable;
import cn.hutool.core.util.StrUtil;
import cn.hutool.core.util.URLUtil;
import com.pcdd.sonovel.convert.ChineseConverter;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.handle.SearchResultsHandler;
import com.pcdd.sonovel.model.*;
import com.pcdd.sonovel.util.CrawlUtils;
import com.pcdd.sonovel.util.JsoupUtils;
import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.util.*;

/**
 * @author pcdd
 * Created at 2024/3/23
 */
public class SearchResultParser extends Source {

    public SearchResultParser(AppConfig config) {
        super(config);
    }

    public List<SearchResult> parse(String keyword) {
        // 模拟搜索请求
        Document document;
        Connection.Response resp;
        Rule.Search r = this.rule.getSearch();
        if (r == null) {
            Console.log("书源 {} 不支持搜索", config.getSourceId());
            return Collections.emptyList();
        }

        try {
            resp = jsoup(r.getUrl().formatted(keyword))
                    .timeout(r.getTimeout())
                    .data(CrawlUtils.buildData(r.getData(), keyword))
                    .cookies(CrawlUtils.buildCookies(r.getCookies()))
                    .execute();
            document = Jsoup.parse(resp.body());
        } catch (Exception e) {
            Console.error(e.getMessage());
            return Collections.emptyList();
        }

        List<SearchResult> firstPageResults = getSearchResults(null, resp);
        if (!r.isPagination()) return SearchResultsHandler.handle(firstPageResults);

        // 搜索结果的分页 URL
        Set<String> urls = new LinkedHashSet<>();
        Elements searchPages = JsoupUtils.select(document, r.getNextPage());
        for (Element e : CollUtil.sub(searchPages, 0, r.getLimitPage() - 1)) {
            String href = CrawlUtils.normalizeUrl(e.attr("href"), this.rule.getUrl());
            // 中文解码，针对69書吧
            urls.add(URLUtil.decode(href));
        }

        // 使用并行流处理分页 URL
        List<SearchResult> additionalResults = urls.parallelStream()
                .flatMap(url -> getSearchResults(url, null).stream())
                .toList();
        // 合并，不去重（去重用 union）
        List<SearchResult> unionAll = CollUtil.unionAll(firstPageResults, additionalResults);

        return SearchResultsHandler.handle(unionAll);
    }

    private List<SearchResult> getSearchResults(String url, Connection.Response resp) {
        Rule.Search r = this.rule.getSearch();
        List<SearchResult> list = new ArrayList<>();
        try {
            // 搜索结果页 DOM
            Document document = resp == null
                    ? jsoup(url).timeout(r.getTimeout()).get()
                    : Jsoup.parse(resp.body());

            // 部分书源完全匹配时会直接跳转到详情页（搜索结果为空 && 书名不为空），故需要构造搜索结果
            if (document.select(r.getResult()).isEmpty() && !document.select(this.rule.getBook().getBookName()).isEmpty()) {
                String bookUrl = resp.url().toString();
                BookParser bookParser = new BookParser(config);
                Book book = bookParser.parse(bookUrl);

                if (StrUtil.isBlank(book.getBookName())) {
                    return Collections.emptyList();
                }

                SearchResult build = SearchResult.builder()
                        .url(bookUrl)
                        .bookName(book.getBookName())
                        .author(book.getAuthor())
                        .latestChapter(book.getLatestChapter())
                        .latestUpdate(book.getLatestUpdate())
                        .build();
                list.add(build);
                Thread.sleep(CrawlUtils.randomInterval(config, false));

                return list;
            }

            Elements elements = document.select(r.getResult());
            for (Element element : elements) {
                // jsoup 不支持一次性获取属性的值
                String href = JsoupUtils.selectAndInvokeJs(element, r.getBookName(), ContentType.ATTR_HREF);
                String bookName = JsoupUtils.selectAndInvokeJs(element, r.getBookName());
                // 以下为非必须属性
                String author = JsoupUtils.selectAndInvokeJs(element, r.getAuthor());
                String latestChapter = JsoupUtils.selectAndInvokeJs(element, r.getLatestChapter());
                String update = JsoupUtils.selectAndInvokeJs(element, r.getUpdate());

                if (bookName.isEmpty()) continue;

                SearchResult sr = SearchResult.builder()
                        .url(CrawlUtils.normalizeUrl(href, this.rule.getUrl()))
                        .bookName(bookName)
                        .author(author)
                        .latestChapter(latestChapter)
                        .latestUpdate(update)
                        .build();

                list.add(ChineseConverter.convert(sr, this.rule.getLanguage(), config.getLanguage()));
            }
        } catch (Exception e) {
            Console.error(e);
            return Collections.emptyList();
        }

        return list;
    }

    public static void printSearchResult(List<SearchResult> results) {
        ConsoleTable consoleTable = ConsoleTable.create().addHeader("序号", "书名", "作者", "最新章节", "最后更新时间");
        for (int i = 1; i <= results.size(); i++) {
            SearchResult r = results.get(i - 1);
            consoleTable.addBody(String.valueOf(i),
                    r.getBookName(),
                    r.getAuthor(),
                    r.getLatestChapter(),
                    r.getLatestUpdate());
        }
        Console.table(consoleTable);
    }

}