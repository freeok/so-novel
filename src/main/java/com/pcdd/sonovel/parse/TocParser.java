/* 习包子 维尼熊给跳跳虎黄牌 文明其精神 习夶 Mr##Shithole 岿然不动 动物之森 洗包皮 习Core 腊肉包 梁家河 枪毙名单 我是一个足球迷 儿童习典 习式病毒 第22条军规 称帝修宪 隔离”的金葫芦 习厉王 习皇帝 重地之战 习屎黄 当代秦始皇 不强自息 习是春竹 维尼写史 习大郎 初二圣君 乳包文化 不敢高声语 口罩外交 习近平光辉形象 人类命运共同体首席架构师 习猪头 习奥赛斯库 退党 习梦思 “梦回大清” 颐使气指 习二蛋 包经 䒒(tiáo)菦(qín)苹(píng) 阿道夫-习 白猪 20000T麦子 现任匪首 nmslman（习主席） “登基” 裸宽包子劾心 习一尊 维尼带货 晚共昏君 维尼连任 shit##hole##bing##fa 习大林 发皇帝梦 普习金 习王的田野上 CoronaXi 习兵法 学包率 修宪连任 东瘟疫之地统治者暨全境守护者 親自蒞臨 万岁来武汉了 习包皮 Chairman##Xi 清华毕业 专治各种不服 终身领导人 战“疫”金句 庆丰包·勃列日涅夫 一带一路 主席+终身制 核平全世界 朝令夕改 系包皮 刁远山 习二世胡亥 习正日 那翠化 北红尾鸲 学包积极分子 假.."~bang！卒 習敗北 中国爱非洲 傻大头 nmslese##dream 日子像蜜甜 昆明湖涨潮 倒车 屎進瓶 墨索里习 大兔 红旗下的蛋 大国造疫 赵家家仆 孢 毛近平 亲自封号 世宗 毛二习 乳透社##小反旗 包惠帝 冤大头 习大 习远凸 叩谢习恩 截颈平 卡近菲 习是春绿 平话 鞋哥 electron8964 中国首席造梦大师 习三拍 讨习檄文 包禁评 xdd 任大炮 习梦撕 通商宽衣 视频看望 冠子兵法 外交习语 崇祯 刁斤二 习思想 习病法 东方project 独彩者 野兽先辈 梦帝 习老八 大海掀翻小池塘 共哀宗 親自視頻 惜包皮 席子兵法 灭共助推器 习公奭 习大帝 “复辟” 帝皇頌 习太孑 骑巨龙 习犬犬 大大招牌 你是反贼吗 Voice##of##Pooh 赵人13 狙击手布阵 人民战争 习付 食腐虫 当代秦二世 习瘟猪 刁槑夶尛 主席贺词 中国特色射秽煮疫制度 黑白翠 爱新觉罗近平 书单吟诵者 韦来书记 人民领袖 習敗敗 人均接近八千万 通商宽衣 青年大学包 半羽习近平 习奥塞斯库 影子末帝 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 戏包皮 包子宪法 习大乞 连专家也为之叹服的电脑天才 撒币宝 腊肉馅儿包子 刁斤山 北京中南海支部书记 普近 习匪 刁近猴 信女愿一生吃素 大撒币 九大诉求 包帝巡游 中国的新皇帝 shit侯 追思焦裕禄 羽日帝 二百五大帝 习尿瓶 黄俄 武当七侠的政治斗争 习达姆 洗尽贫 习二胖 劝进 习总 官僚主义 人尽皆知的体育迷 赵王 闹得欢 氼兲嫑炛 任志强 毛进平 包子病毒 中国离岸隐匿资产管理工作领导小组组组长 世界最强乞丐 嘻包皮 ChinaXi 习猪席 富平学霸刁斤干 头号球迷 基拉大和习近平 神明论 恩重如删 Cicada##3301##XD 习宽衣 御板泽民 央视姓党 百万雄师事件 民进党 庆丰废物 维稳警察（O） 阳台上的哨兵 总加速师 战疫国 The##Xi##Factor（习近平因素） “无罩”现身 毛二世 维尼梗有害 皇帝亲临忠诚的武汉 第一书记王沪宁 皇帝梦 拉清单 习king 小学居士 喷粪帝 亲自指挥 倒车斯基 皇帝的新衣 包包大人 支那精神野爹 习教父 十日文革 刁后主 形式主义防疫 习得梁家书卷 大锅瞻遗 近日成 独裁者 习澳塞斯库 包子金刚腿 “登机”（与登基同音） 习呆呆 慨撒大帝 2020全面小康 习侯 叼斤干 糟糕皇帝 386系统驱动游戏 迈克尔·索伊 秦城监狱 近言 virus##king 习包子的Fa 公车上书 大撒幣 XD 支那毒王 Corona##Xi（习病毒） 习禁评 vop 悉包皮 做N届的主席 冰棒外交 彭主席（习主席走了太太接班） 抗麦套装 习贼 耀眼黄红黄 无限连任 玉习大帝 指定接班人 老街 宰相 习尔布特 蔡英文最强助选 狙击手待命 错误执行者 没规划的葬礼 五毛主席 瘟疫降生习近平 孤独的毒王 习卒习 习狍 读书单 维尼史 习核心 习##卡##巴##卡 “黄袍加身” 学包分子 习卒 总书记来我家 NMSL 蹄防 习匪帝 叩谢习恩 共哀宗 红二代 最后领导人 万岁来武汉 吸包皮 习语 满脸喷粪 野蛮其体魄 背书单 近身平A 不知名氏 禁评封号 习躲躲 不同意的举手##没有##没有 习二卒 维持会长 巴拿马文件 裹嘎举吸钢闸门 习条英机 云视察 赛禁评 习包子 习皇的新装 金科律玉 格萨尔 邪大大 平平 集金币 包大人 清单帝 bingbang帝 习像章 习驴 禁评的理由 《生物安全法》 SB包子 倒车帝 坟头蹦迪 翡翠娘娘 万岁 崇祯帝 恩维尔·霍习 平&强 末代皇帝 包皇 刁大犬 习“甩锅” 沼气专家 彩色熊 没有网络安全就没有国家安全 细瓶颈 习背书 西朝鲜人民自治岛 恐惊天上人 大大品牌 号屎洞 添宪宝宝 猪禁评 相信有神论的物理学博士 习三点 维尼大帝 时间控制 修宪 A##Big##Deal 習大佬 习总输记 习下台 集金pay 一天游泳一千米 屎侯 禁评大帝 法外狂徒Lucy（德国） 号尿壶公 嬉包皮 刁近乎 200吨 动森 小习微信 刁二婚 习习蛤蛤 头上三尺有神明 毛二 皇帝亲临忠诚的武汉 集近闭 墙内人 维尼DISCO 糖尿维尼 亲自删评 扛麦郎 武汉委托李克强 习大犬 刁二将 “习泽东”和“洪宪”（袁世凯的帝号） 当皇帝的小丑 Criminal##Xi##"Xitler"##Jinping 习张三丰 乳制品 习二二（二零二零年五月二十二日开二会） 刁人13 野兽主席 中国拉清单工作领导小组组长 彩色哥 总统包子习 习低能儿 爱新觉罗·近平 电脑世代586 V尼哥 总书记来过我的家 shuu##kinn##pei 法习斯 这个年很静 习和谐 袁世凯第二 坡涛汹涌 纳翠党 老歪脖子树 庆丰帝的千秋梦 匪酋习维尼 “皇帝梦” 习猪下台 川普的朋友or敌人 习语录 字共狗 仲夏夜之中国梦 读稿机 维尼之声 动物森友会 游泳一千米 习家军 习歪嘴 扛麦帝 习殡法 中国离岸隐匿资产管理工作领导小组组组长 孙笑川 国贼习近平 习武帝 习包子 梦回大清 冲塔 小学博士 亲自脱贫 亲自考察 疫情蔓延 役民五术 阿平 领袖习澡水 坡涛汹涌 祈翠 夶 维尼警察（X） 720事件 家业论 花花公子 习博士 瘟疫领主习近平 袭包皮 十一郎习近平 刁人13 毛孙 塔西佗陷阱 64岁 智商不重要 甩锅侠 习言乱语 包子兵法 两会期间+隐瞒 吃赵弹 习孢子 WHO的君王 包子露宪 尊蛤讨包 野心习 习梦死 宽衣帝 国王 赵付 疯狂宇宙 戴口赵 包包侠 习蛤 屎禁评 戏博士 XDD 习二坐船 送礼平 10号跳跳虎被维尼拉清单 动物庄园 席近平 疯狂宇宙包 人民领袖 捐麦子 祈翠語言包 赵弹 维尼·屎(Winnie##the##Poo) 习近砰 习后主 毛魔转世 超邓赶毛 武统时代 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 尼哥 习废帝 次级乳包 习流氓 庆丰称帝 哲欣 天安门合法继承人 习进棺 维尼熊 狙击手待命 粪坑兵法 Heil##Xitler 喜包皮 感恩教育 贬词包用 吸精瓶 习emperor 維尼頌 4中组长 大撒币 毛装 疯狂宇宙大帝 足球外交 中字头组长 习时代 细颈瓶 维尼快乐组织（Winnie##Happy##Organization）简称WHO 九评 习特勒 断崖式下跌 颐指气使 shit禁评 口罩大会 Adolf##Xitler 太祖兔 新影帝 梁家河贵族 每日祈翠 习索里尼 粪坑先生 亲自指挥疫情 厕所革命 胡志平 灰习牛 维尼挂彩 */
package com.pcdd.sonovel.parse;

import cn.hutool.core.collection.CollUtil;
import cn.hutool.core.lang.Opt;
import cn.hutool.core.lang.Validator;
import cn.hutool.core.util.ReUtil;
import cn.hutool.core.util.StrUtil;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Chapter;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.util.CrawlUtils;
import com.pcdd.sonovel.util.JsoupUtils;
import lombok.SneakyThrows;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.util.ArrayList;
import java.util.List;
import java.util.Set;

import static com.pcdd.sonovel.model.ContentType.ATTR_HREF;
import static com.pcdd.sonovel.model.ContentType.ATTR_VALUE;

public class TocParser extends Source {

    public TocParser(AppConfig config) {
        super(config);
    }

    /**
     * 解析全章
     */
    public List<Chapter> parse(String url) {
        return parse(url, 1, Integer.MAX_VALUE);
    }

    /**
     * 解析指定范围章节
     *
     * @param url 详情页
     */
    @SneakyThrows
    public List<Chapter> parse(String url, int start, int end) {
        Rule.Book ruleBook = this.rule.getBook();
        Rule.Toc ruleToc = this.rule.getToc();

        // 目录和详情不在同一页面
        if (StrUtil.isNotEmpty(ruleToc.getUrl())) {
            String id = ReUtil.getGroup1(StrUtil.subBefore(ruleBook.getUrl(), "@js:", false), url);
            url = ruleToc.getUrl().formatted(id);
        }

        Set<String> urls = CollUtil.set(true, url);
        Document document = jsoup(url)
                .timeout(ruleToc.getTimeout())
                .get();

        if (ruleToc.isPagination()) {
            extractPaginationUrls(urls, document, ruleToc);
        }

        return parseToc(urls, start, end, ruleToc);
    }

    @SneakyThrows
    private void extractPaginationUrls(Set<String> urls, Document document, Rule.Toc r) {
        Elements elements = JsoupUtils.select(document, r.getNextPage());
        // 一次性获取分页 URL（下拉菜单）
        if (CollUtil.isNotEmpty(elements) && elements.hasAttr(ATTR_VALUE.getValue())) {
            List<String> list = elements.eachAttr(ATTR_HREF.getValue()).isEmpty()
                    ? elements.eachAttr(ATTR_VALUE.getValue())
                    : elements.eachAttr(ATTR_HREF.getValue());
            list.forEach(s -> urls.add(CrawlUtils.normalizeUrl(s, this.rule.getUrl())));
            return;
        }
        // 以下代码覆盖率可能为 0，因为分页的目录基本全都是通过下拉菜单一次性获取的
        // 递归获取分页 URL（模拟点击下一页）
        while (true) {
            String nextUrl = Opt.ofNullable(JsoupUtils.selectAndInvokeJs(document, r.getNextPage(), ATTR_HREF))
                    .filter(StrUtil::isNotEmpty)
                    .orElse(JsoupUtils.selectAndInvokeJs(document, r.getNextPage(), ATTR_VALUE));

            if (!(Validator.isUrl(nextUrl) || StrUtil.startWith(nextUrl, "/"))) break;
            nextUrl = CrawlUtils.normalizeUrl(nextUrl, this.rule.getUrl());
            urls.add(nextUrl);
            document = jsoup(nextUrl)
                    .timeout(r.getTimeout())
                    .get();
            Thread.sleep(CrawlUtils.randomInterval(config));
        }
    }

    // TODO 优化，改为多线程
    @SneakyThrows
    private List<Chapter> parseToc(Set<String> urls, int start, int end, Rule.Toc r) {
        List<Chapter> toc = new ArrayList<>();
        boolean isDesc = r.isDesc();
        int orderNumber = 1;
        int offset = r.getOffset() != null ? r.getOffset() : 0;

        for (String s : urls) {
            Document document = jsoup(s)
                    .timeout(r.getTimeout())
                    .get();
            // TODO rule.toc.result 实现 JS 语法，在此调用比 addChapter 更省性能
            List<Element> elements = JsoupUtils.select(document, r.getResult());
            if (offset != 0) {
                elements = adjustElementsByOffset(elements, offset);
            }
            int minIndex = Math.min(end, elements.size());
            if (isDesc) {
                for (int i = minIndex - 1; i >= start - 1; i--) {
                    addChapter(elements.get(i), toc, orderNumber++, r);
                }
            } else {
                for (int i = start - 1; i < minIndex; i++) {
                    addChapter(elements.get(i), toc, orderNumber++, r);
                }
            }
        }

        return toc;
    }

    private List<Element> adjustElementsByOffset(List<Element> elements, int offset) {
        if (elements.size() < offset) {
            return elements;
        }
        if (offset > 0) {
            return elements.subList(offset, elements.size());
        }
        if (offset < 0) {
            return elements.subList(0, elements.size() + offset);
        }
        return elements;
    }

    private void addChapter(Element el, List<Chapter> toc, int order, Rule.Toc r) {
        String url = JsoupUtils.getStrAndInvokeJs(el, r.getNextPage(), ATTR_HREF);
        toc.add(Chapter.builder()
                .title(el.text())
                .url(CrawlUtils.normalizeUrl(url, this.rule.getUrl()))
                .order(order)
                .build());
    }

}