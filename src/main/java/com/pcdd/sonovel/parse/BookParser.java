/* 匪酋习维尼 沼气专家 习大乞 世界最强乞丐 习大郎 大撒币 腊肉包 格萨尔 包子兵法 乳透社##小反旗 习三点 疫情蔓延 中国拉清单工作领导小组组长 哲欣 截颈平 瘟疫领主习近平 猪禁评 习下台 十日文革 称帝修宪 习侯 包皇 嘻包皮 闹得欢 刁人13 赛禁评 nmslman（习主席） 习梦思 庆丰称帝 不知名氏 中国的新皇帝 亲自指挥 习二坐船 人民领袖 仲夏夜之中国梦 毛魔转世 裹嘎举吸钢闸门 习武帝 东方project 习总输记 相信有神论的物理学博士 习式病毒 720事件 大海掀翻小池塘 黄俄 习卒 亲自删评 The##Xi##Factor（习近平因素） 习猪下台 刁槑夶尛 超邓赶毛 习后主 没有网络安全就没有国家安全 指定接班人 小习微信 《生物安全法》 尊蛤讨包 五毛主席 习张三丰 喷粪帝 喜包皮 贬词包用 vop 習敗北 两会期间+隐瞒 食腐虫 口罩外交 Voice##of##Pooh 不敢高声语 老街 战疫国 国王 人民战争 electron8964 64岁 刁远山 文明其精神 野兽先辈 北京中南海支部书记 万岁来武汉了 刁人13 耀眼黄红黄 亲自指挥疫情 共哀宗 維尼頌 皇帝的新衣 倒车帝 基拉大和习近平 第22条军规 bingbang帝 屎侯 维稳警察（O） 独彩者 扛麦帝 shit禁评 小学博士 习条英机 习时代 专治各种不服 卡近菲 当皇帝的小丑 疯狂宇宙包 岿然不动 次级乳包 无限连任 习匪 家业论 習敗敗 毛装 习匪帝 習大佬 主席+终身制 悉包皮 刁斤山 昆明湖涨潮 鞋哥 刁二婚 颐使气指 普习金 习尔布特 庆丰包·勃列日涅夫 洗包皮 习猪席 坡涛汹涌 䒒(tiáo)菦(qín)苹(píng) 通商宽衣 刁大犬 国贼习近平 维尼之声 习皇帝 花花公子 糖尿维尼 阿平 XD 假.."~bang！卒 习语 shuu##kinn##pei 西朝鲜人民自治岛 近日成 世宗 赵家家仆 习博士 习言乱语 末代皇帝 包禁评 时间控制 习孢子 公车上书 梁家河 庆丰废物 新影帝 习二卒 半羽习近平 冠子兵法 央视姓党 “习泽东”和“洪宪”（袁世凯的帝号） 武汉委托李克强 不同意的举手##没有##没有 动森 叩谢习恩 宰相 撒币宝 不强自息 粪坑先生 抗麦套装 阿道夫-习 翡翠娘娘 大撒幣 最后领导人 习和谐 天安门合法继承人 电脑世代586 shit侯 恩维尔·霍习 领袖习澡水 宽衣帝 xdd 赵弹 枪毙名单 夶 黑白翠 野兽主席 乳制品 日子像蜜甜 第一书记王沪宁 习习蛤蛤 习包子 戴口赵 习思想 人类命运共同体首席架构师 拉清单 维持会长 万岁 终身领导人 习king 捐麦子 习大犬 瘟疫降生习近平 头号球迷 腊肉馅儿包子 慨撒大帝 学包分子 玉习大帝 隔离”的金葫芦 习大 添宪宝宝 那翠化 韦来书记 动物之森 错误执行者 习澳塞斯库 Chairman##Xi 席子兵法 习得梁家书卷 维尼史 毛进平 屎禁评 神明论 习二世胡亥 Heil##Xitler 维尼带货 总书记来过我的家 习包子的Fa 大大品牌 蔡英文最强助选 平&强 金科律玉 禁评大帝 民进党 “复辟” 一天游泳一千米 傻大头 核平全世界 戏包皮 親自蒞臨 当代秦二世 习卒习 习像章 习包子 中字头组长 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 糟糕皇帝 彩色熊 大锅瞻遗 帝皇頌 老歪脖子树 爱新觉罗·近平 动物森友会 云视察 细颈瓶 习宽衣 禁评封号 红旗下的蛋 习兵法 号屎洞 足球外交 习二胖 吃赵弹 习一尊 习梦撕 狙击手待命 nmslese##dream 背书单 习核心 大大招牌 疯狂宇宙大帝 近言 中国离岸隐匿资产管理工作领导小组组组长 习进棺 习废帝 亲自脱贫 习病法 二百五大帝 赵人13 孢 习尿瓶 巴拿马文件 野蛮其体魄 颐指气使 习躲躲 小学居士 支那毒王 NMSL 口罩大会 氼兲嫑炛 清华毕业 孙笑川 墙内人 役民五术 习特勒 恩重如删 皇帝亲临忠诚的武汉 维尼挂彩 武统时代 维尼·屎(Winnie##the##Poo) 习公奭 劝进 4中组长 细瓶颈 白猪 Cicada##3301##XD 读书单 动物庄园 坟头蹦迪 习贼 “皇帝梦” 包子宪法 习流氓 习屎黄 系包皮 习是春竹 甩锅侠 冤大头 墨索里习 大撒币 刁二将 亲自考察 习皇的新装 恐惊天上人 塔西佗陷阱 习索里尼 智商不重要 习夶 狙击手布阵 独裁者 大兔 退党 维尼梗有害 中国特色射秽煮疫制度 包子金刚腿 九大诉求 人均接近八千万 游泳一千米 屎進瓶 一带一路 任大炮 梁家河贵族 习大帝 初二圣君 崇祯 习驴 太祖兔 学包积极分子 人民领袖 裸宽包子劾心 纳翠党 集金pay 维尼熊给跳跳虎黄牌 九评 XDD SB包子 坡涛汹涌 当代秦始皇 书单吟诵者 祈翠 习付 庆丰帝的千秋梦 通商宽衣 红二代 刁近猴 修宪 皇帝亲临忠诚的武汉 嬉包皮 习王的田野上 洗尽贫 修宪连任 主席贺词 习低能儿 字共狗 总加速师 刁斤二 习猪头 叼斤干 Corona##Xi（习病毒） 维尼快乐组织（Winnie##Happy##Organization）简称WHO 爱新觉罗近平 平平 席近平 习瘟猪 吸精瓶 骑巨龙 刁后主 法习斯 迈克尔·索伊 共哀宗 儿童习典 习犬犬 习二蛋 中国爱非洲 彭主席（习主席走了太太接班） 支那精神野爹 疯狂宇宙 习梦死 彩色哥 维尼警察（X） 200吨 厕所革命 Criminal##Xi##"Xitler"##Jinping 习正日 习奥赛斯库 习是春绿 羽日帝 连专家也为之叹服的电脑天才 习家军 感恩教育 “登机”（与登基同音） ChinaXi 赵王 WHO的君王 东瘟疫之地统治者暨全境守护者 习老八 习总 习Core 禁评的理由 习奥塞斯库 毛近平 V尼哥 习呆呆 读稿机 追思焦裕禄 毛二世 每日祈翠 包子露宪 习教父 戏博士 梦帝 “无罩”现身 袭包皮 冰棒外交 亲自封号 你是反贼吗 普近 晚共昏君 2020全面小康 20000T麦子 吸包皮 习蛤 Mr##Shithole 习emperor 阳台上的哨兵 习达姆 祈翠語言包 包帝巡游 头上三尺有神明 毛孙 重地之战 习三拍 武当七侠的政治斗争 包惠帝 万岁来武汉 北红尾鸲 叩谢习恩 尼哥 习包子 386系统驱动游戏 维尼大帝 习禁评 讨习檄文 中国离岸隐匿资产管理工作领导小组组组长 习近平光辉形象 粪坑兵法 影子末帝 包子病毒 习厉王 外交习语 梦回大清 习背书 冲塔 我是一个足球迷 邪大大 野心习 御板泽民 “登基” 现任匪首 没规划的葬礼 灭共助推器 富平学霸刁斤干 親自視頻 中国首席造梦大师 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 包大人 发皇帝梦 倒车 维尼熊 倒车斯基 习大林 狙击手待命 清单帝 战“疫”金句 崇祯帝 送礼平 总统包子习 习远凸 信女愿一生吃素 习“甩锅” 青年大学包 这个年很静 号尿壶公 赵付 扛麦郎 断崖式下跌 A##Big##Deal shit##hole##bing##fa 大国造疫 包包侠 CoronaXi 法外狂徒Lucy（德国） 人尽皆知的体育迷 维尼DISCO 包包大人 集近闭 “黄袍加身” 满脸喷粪 视频看望 包经 百万雄师事件 学包率 乳包文化 胡志平 惜包皮 平话 灰习牛 袁世凯第二 做N届的主席 习##卡##巴##卡 总书记来我家 朝令夕改 十一郎习近平 形式主义防疫 习狍 习二二（二零二零年五月二十二日开二会） Adolf##Xitler 维尼连任 秦城监狱 孤独的毒王 毛二习 习太孑 10号跳跳虎被维尼拉清单 习近砰 习包皮 virus##king 毛二 川普的朋友or敌人 刁近乎 习歪嘴 维尼写史 官僚主义 集金币 “梦回大清” 任志强 蹄防 习殡法 近身平A 皇帝梦 习语录 */
package com.pcdd.sonovel.parse;

import cn.hutool.core.util.StrUtil;
import com.pcdd.sonovel.convert.ChineseConverter;
import com.pcdd.sonovel.core.CoverUpdater;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Book;
import com.pcdd.sonovel.model.ContentType;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.util.CrawlUtils;
import com.pcdd.sonovel.util.JsoupUtils;
import lombok.SneakyThrows;
import org.jsoup.nodes.Document;

/**
 * @author pcdd
 * Created at 2024/3/17
 */
public class BookParser extends Source {

    public static final String CONTENT = "content";

    public BookParser(AppConfig config) {
        super(config);
    }

    @SneakyThrows
    public Book parse(String url) {
        Rule.Book r = this.rule.getBook();
        Document document = jsoup(url)
                .timeout(r.getTimeout())
                .get();

        String bookName = JsoupUtils.selectAndInvokeJs(document, r.getBookName(), getContentType(r.getBookName()));
        String author = JsoupUtils.selectAndInvokeJs(document, r.getAuthor(), getContentType(r.getAuthor()));
        String intro = StrUtil.cleanBlank(JsoupUtils.selectAndInvokeJs(document, r.getIntro(), getContentType(r.getIntro())));
        String coverUrl = JsoupUtils.selectAndInvokeJs(document, r.getCoverUrl(),
                r.getCoverUrl().startsWith("meta[") ? ContentType.ATTR_CONTENT : ContentType.ATTR_SRC);
        // 以下为非必须属性
        String latestChapter = JsoupUtils.selectAndInvokeJs(document, r.getLatestChapter(), getContentType(r.getLatestChapter()));
        String latestUpdate = JsoupUtils.selectAndInvokeJs(document, r.getLatestUpdate(), getContentType(r.getLatestUpdate()));

        Book book = new Book();
        book.setUrl(url);
        book.setBookName(bookName);
        book.setAuthor(author);
        book.setIntro(intro);
        book.setCoverUrl(CoverUpdater.fetchCover(book, CrawlUtils.normalizeUrl(coverUrl, this.rule.getUrl())));
        book.setLatestChapter(latestChapter);
        book.setLatestUpdate(latestUpdate);

        return ChineseConverter.convert(book, this.rule.getLanguage(), config.getLanguage());
    }

    private ContentType getContentType(String query) {
        return query.startsWith("meta[") ? ContentType.ATTR_CONTENT : ContentType.TEXT;
    }

}