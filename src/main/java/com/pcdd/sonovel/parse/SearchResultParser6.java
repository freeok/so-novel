/* 骑巨龙 没规划的葬礼 “梦回大清” 儿童习典 庆丰废物 V尼哥 习特勒 二百五大帝 太祖兔 戏博士 塔西佗陷阱 习达姆 nmslman（习主席） 贬词包用 支那毒王 劝进 阿道夫-习 任志强 大撒币 每日祈翠 晚共昏君 老街 vop 中字头组长 维尼快乐组织（Winnie##Happy##Organization）简称WHO 习废帝 超邓赶毛 卡近菲 平平 国王 包皇 习背书 糖尿维尼 中国首席造梦大师 毛孙 大撒幣 刁斤二 哲欣 习皇的新装 维尼之声 习付 习禁评 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 习宽衣 习躲躲 裹嘎举吸钢闸门 赛禁评 总书记来过我的家 冲塔 迈克尔·索伊 大国造疫 毛进平 食腐虫 国贼习近平 亲自删评 人类命运共同体首席架构师 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 维稳警察（O） Adolf##Xitler 親自蒞臨 人民战争 维尼连任 坟头蹦迪 当代秦二世 习是春绿 親自視頻 读书单 独裁者 翡翠娘娘 颐指气使 包子宪法 习一尊 习公奭 习近砰 信女愿一生吃素 胡志平 习太孑 习贼 百万雄师事件 追思焦裕禄 习包子 戏包皮 习二胖 集金币 外交习语 習敗敗 “习泽东”和“洪宪”（袁世凯的帝号） 习夶 袁世凯第二 枪毙名单 狙击手待命 武统时代 習敗北 末代皇帝 WHO的君王 沼气专家 两会期间+隐瞒 厕所革命 习总输记 总书记来我家 Corona##Xi（习病毒） 200吨 习犬犬 习匪 386系统驱动游戏 禁评大帝 蹄防 甩锅侠 世界最强乞丐 夶 刁二婚 慨撒大帝 十日文革 冠子兵法 习二世胡亥 孢 普习金 维尼警察（X） 梁家河贵族 瘟疫降生习近平 总加速师 梁家河 吃赵弹 终身领导人 冤大头 拉清单 Heil##Xitler 猪禁评 维尼挂彩 “无罩”现身 包子露宪 北京中南海支部书记 那翠化 腊肉馅儿包子 隔离”的金葫芦 习包子 感恩教育 细瓶颈 习包子 习流氓 刁槑夶尛 核平全世界 习卒 virus##king 纳翠党 10号跳跳虎被维尼拉清单 川普的朋友or敌人 shuu##kinn##pei 不知名氏 北红尾鸲 毛二 习猪头 习得梁家书卷 刁远山 刁人13 富平学霸刁斤干 大撒币 坡涛汹涌 爱新觉罗·近平 刁近乎 720事件 恐惊天上人 号尿壶公 戴口赵 习二二（二零二零年五月二十二日开二会） 习##卡##巴##卡 新影帝 公车上书 “登基” 你是反贼吗 颐使气指 专治各种不服 乳透社##小反旗 背书单 动物森友会 屎侯 野心习 亲自指挥疫情 东瘟疫之地统治者暨全境守护者 包经 秦城监狱 习三拍 截颈平 捐麦子 习思想 假.."~bang！卒 习emperor 蔡英文最强助选 最后领导人 黑白翠 习瘟猪 集金pay 读稿机 习大 现任匪首 狙击手布阵 NMSL 习近平光辉形象 The##Xi##Factor（习近平因素） 庆丰帝的千秋梦 孤独的毒王 宽衣帝 万岁来武汉了 裸宽包子劾心 习歪嘴 巴拿马文件 包子金刚腿 扛麦郎 20000T麦子 维尼熊 包子兵法 习尿瓶 鞋哥 亲自脱贫 A##Big##Deal 中国特色射秽煮疫制度 红旗下的蛋 习侯 维尼带货 红二代 万岁 维尼熊给跳跳虎黄牌 金科律玉 瘟疫领主习近平 xdd 集近闭 维尼DISCO 乳制品 送礼平 发皇帝梦 4中组长 小学博士 细颈瓶 断崖式下跌 “登机”（与登基同音） 习“甩锅” 央视姓党 亲自考察 嬉包皮 习狍 皇帝的新衣 西朝鲜人民自治岛 匪酋习维尼 席子兵法 崇祯帝 毛魔转世 习猪席 字共狗 不同意的举手##没有##没有 战疫国 乳包文化 修宪 黄俄 2020全面小康 庆丰包·勃列日涅夫 独彩者 小习微信 习总 第一书记王沪宁 包包大人 毛近平 《生物安全法》 十一郎习近平 习大乞 共哀宗 爱新觉罗近平 抗麦套装 习大犬 习王的田野上 䒒(tiáo)菦(qín)苹(píng) 习低能儿 维尼写史 当代秦始皇 电脑世代586 吸精瓶 没有网络安全就没有国家安全 禁评封号 动物之森 习二蛋 尊蛤讨包 称帝修宪 习包子的Fa 维尼·屎(Winnie##the##Poo) 主席+终身制 吸包皮 悉包皮 形式主义防疫 武当七侠的政治斗争 半羽习近平 任大炮 青年大学包 习病法 彩色哥 动物庄园 习下台 头上三尺有神明 nmslese##dream 连专家也为之叹服的电脑天才 毛装 尼哥 习言乱语 学包分子 中国拉清单工作领导小组组长 初二圣君 习梦撕 视频看望 习语 屎禁评 次级乳包 粪坑先生 大海掀翻小池塘 习时代 文明其精神 彩色熊 近言 一天游泳一千米 屎進瓶 中国的新皇帝 习屎黄 习尔布特 习Core 官僚主义 人民领袖 祈翠語言包 添宪宝宝 武汉委托李克强 玉习大帝 人民领袖 赵弹 中国爱非洲 游泳一千米 做N届的主席 氼兲嫑炛 赵王 叼斤干 疯狂宇宙大帝 习语录 亲自封号 习核心 倒车斯基 叩谢习恩 野兽先辈 总统包子习 扛麦帝 神明论 重地之战 bingbang帝 冰棒外交 叩谢习恩 羽日帝 仲夏夜之中国梦 腊肉包 包惠帝 头号球迷 通商宽衣 大大招牌 CoronaXi 阿平 帝皇頌 习包皮 喷粪帝 灰习牛 时间控制 毛二习 粪坑兵法 书单吟诵者 影子末帝 皇帝亲临忠诚的武汉 昆明湖涨潮 学包积极分子 “黄袍加身” 习匪帝 习驴 包大人 洗尽贫 御板泽民 嘻包皮 清单帝 习教父 糟糕皇帝 毛二世 64岁 主席贺词 阳台上的哨兵 习梦思 支那精神野爹 孙笑川 修宪连任 东方project “皇帝梦” 中国离岸隐匿资产管理工作领导小组组组长 习武帝 Mr##Shithole 退党 习大帝 Chairman##Xi Voice##of##Pooh 役民五术 九评 韦来书记 口罩外交 口罩大会 墙内人 小学居士 野蛮其体魄 维尼大帝 战“疫”金句 五毛主席 倒车 习厉王 法外狂徒Lucy（德国） 习博士 习进棺 习呆呆 狙击手待命 格萨尔 智商不重要 大锅瞻遗 习老八 疯狂宇宙 习条英机 法习斯 刁人13 刁二将 万岁来武汉 中国离岸隐匿资产管理工作领导小组组组长 老歪脖子树 不强自息 野兽主席 维尼梗有害 人尽皆知的体育迷 皇帝亲临忠诚的武汉 习三点 基拉大和习近平 习蛤 系包皮 ChinaXi 习奥赛斯库 Cicada##3301##XD 习家军 Criminal##Xi##"Xitler"##Jinping 习像章 习二卒 习卒习 近身平A 傻大头 日子像蜜甜 平&强 維尼頌 习猪下台 习大郎 习梦死 号屎洞 足球外交 習大佬 天安门合法继承人 恩重如删 袭包皮 赵付 世宗 习大林 包帝巡游 XDD 墨索里习 习二坐船 满脸喷粪 shit禁评 共哀宗 相信有神论的物理学博士 崇祯 赵家家仆 习孢子 民进党 这个年很静 领袖习澡水 邪大大 刁后主 洗包皮 我是一个足球迷 倒车帝 动森 云视察 shit##hole##bing##fa 耀眼黄红黄 席近平 习殡法 九大诉求 普近 “复辟” 习澳塞斯库 习远凸 XD 刁大犬 梦回大清 通商宽衣 习king 指定接班人 喜包皮 清华毕业 第22条军规 讨习檄文 electron8964 包包侠 无限连任 赵人13 shit侯 平话 当皇帝的小丑 亲自指挥 习兵法 不敢高声语 坡涛汹涌 祈翠 维持会长 恩维尔·霍习 家业论 梦帝 包子病毒 习习蛤蛤 近日成 惜包皮 撒币宝 岿然不动 宰相 习索里尼 一带一路 习奥塞斯库 习是春竹 疯狂宇宙包 闹得欢 人均接近八千万 SB包子 彭主席（习主席走了太太接班） 白猪 刁斤山 大大品牌 大兔 习皇帝 学包率 庆丰称帝 习正日 疫情蔓延 习后主 皇帝梦 朝令夕改 花花公子 习式病毒 习张三丰 错误执行者 灭共助推器 维尼史 刁近猴 禁评的理由 习和谐 包禁评 */
package com.pcdd.sonovel.parse;

import cn.hutool.core.io.resource.ResourceUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.core.lang.TypeReference;
import cn.hutool.core.text.UnicodeUtil;
import cn.hutool.core.util.ReUtil;
import cn.hutool.http.HtmlUtil;
import cn.hutool.http.HttpRequest;
import cn.hutool.http.HttpResponse;
import cn.hutool.json.JSONUtil;
import cn.hutool.script.ScriptUtil;
import com.pcdd.sonovel.convert.ChineseConverter;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.handle.SearchResultsHandler;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.ContentType;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.model.SearchResult;
import com.pcdd.sonovel.util.CrawlUtils;
import com.pcdd.sonovel.util.JsoupUtils;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Map;

/**
 * 书源 6 搜索特殊处理
 *
 * @author pcdd
 * Created at 2024/3/23
 */
public class SearchResultParser6 extends Source {

    public SearchResultParser6(AppConfig config) {
        super(config);
    }

    public List<SearchResult> parse(String keyword) {
        Rule.Search r = this.rule.getSearch();
        String js = ResourceUtil.readUtf8Str("js/rule-6.js");
        Object key = ScriptUtil.invoke(js, "getParamB", keyword);
        String param = r.getData().formatted(keyword, key.toString());
        Map<String, String> map = JSONUtil.toBean(param, new TypeReference<>() {
        }, true);

        HttpRequest req = HttpRequest
                .get(this.rule.getUrl())
                .timeout(r.getTimeout())
                .header("Referer", r.getUrl())
                .formStr(map);
        if (config.getProxyEnabled() == 1)
            req.setHttpProxy(config.getProxyHost(), config.getProxyPort());

        try (HttpResponse resp = req.execute()) {
            String body = resp.body();
            String s = UnicodeUtil.toString(body);
            String s2 = HtmlUtil.unescape(s)
                    .replace("\\r", "")
                    .replace("\\n", "")
                    .replace("\\t", "")
                    .replace("\\/", "/")
                    .replace("\\\"", "'");
            String s3 = ReUtil.getGroup0("\\{(.*?)\\}", s2);
            String beginIndex = "\"content\":";
            String ans = s3.substring(s3.indexOf(beginIndex) + beginIndex.length(), s3.lastIndexOf("}"));
            List<SearchResult> firstPageResults = getSearchResults(Jsoup.parse(ans));
            return SearchResultsHandler.handle(firstPageResults);

        } catch (Exception e) {
            Console.error(e.getMessage());
            return Collections.emptyList();
        }
    }

    private List<SearchResult> getSearchResults(Document document) {
        Rule.Search r = this.rule.getSearch();
        List<SearchResult> list = new ArrayList<>();
        Elements elements = document.select(r.getResult());

        for (Element element : elements) {
            String href = JsoupUtils.selectAndInvokeJs(element, r.getBookName(), ContentType.ATTR_HREF);
            String bookName = JsoupUtils.selectAndInvokeJs(element, r.getBookName());
            String author = JsoupUtils.selectAndInvokeJs(element, r.getAuthor());

            SearchResult sr = SearchResult.builder()
                    .url(CrawlUtils.normalizeUrl(href, this.rule.getUrl()))
                    .bookName(bookName)
                    .author(author)
                    .build();

            list.add(ChineseConverter.convert(sr, this.rule.getLanguage(), config.getLanguage()));
        }

        return list;
    }

}