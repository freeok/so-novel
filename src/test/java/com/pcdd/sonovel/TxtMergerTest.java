/* 人尽皆知的体育迷 叼斤干 瘟疫降生习近平 习总输记 没有网络安全就没有国家安全 一带一路 习张三丰 人类命运共同体首席架构师 ChinaXi 中国特色射秽煮疫制度 野兽先辈 野蛮其体魄 亲自考察 动物庄园 追思焦裕禄 民进党 主席贺词 战“疫”金句 疯狂宇宙 shit侯 粪坑兵法 尼哥 习兵法 老街 公车上书 通商宽衣 足球外交 习梦撕 习猪下台 末代皇帝 新影帝 親自蒞臨 云视察 闹得欢 纳翠党 灭共助推器 家业论 粪坑先生 维尼挂彩 蹄防 独裁者 匪酋习维尼 习宽衣 背书单 红二代 总书记来我家 头上三尺有神明 大大品牌 相信有神论的物理学博士 shit##hole##bing##fa 黑白翠 任大炮 习得梁家书卷 维尼·屎(Winnie##the##Poo) 西朝鲜人民自治岛 维尼连任 送礼平 倒车斯基 傻大头 包皇 庆丰包·勃列日涅夫 裹嘎举吸钢闸门 信女愿一生吃素 退党 孢 刁槑夶尛 习##卡##巴##卡 习是春绿 维尼大帝 狙击手布阵 毛近平 习猪席 包帝巡游 习索里尼 疫情蔓延 习蛤 仲夏夜之中国梦 那翠化 吃赵弹 习是春竹 20000T麦子 惜包皮 外交习语 祈翠語言包 习尔布特 习武帝 V尼哥 卡近菲 习后主 毛魔转世 64岁 洗尽贫 习背书 疯狂宇宙大帝 国贼习近平 总加速师 祈翠 习澳塞斯库 嬉包皮 习大乞 修宪 习大犬 讨习檄文 习二蛋 200吨 戏博士 习禁评 习二世胡亥 毛进平 视频看望 食腐虫 连专家也为之叹服的电脑天才 韦来书记 䒒(tiáo)菦(qín)苹(píng) 亲自删评 不强自息 席近平 维尼警察（X） 习匪帝 习king 悉包皮 习皇帝 耀眼黄红黄 岿然不动 崇祯 普习金 北红尾鸲 习家军 习付 厕所革命 总书记来过我的家 时间控制 万岁 狙击手待命 中国爱非洲 维尼熊 屎進瓶 习下台 当皇帝的小丑 袭包皮 习驴 习太孑 集金币 无限连任 The##Xi##Factor（习近平因素） 喜包皮 赵弹 文明其精神 细颈瓶 皇帝的新衣 刁斤山 九大诉求 720事件 恩重如删 “习泽东”和“洪宪”（袁世凯的帝号） 恩维尔·霍习 习“甩锅” 戏包皮 鞋哥 坡涛汹涌 刁近猴 超邓赶毛 习像章 动森 親自視頻 习言乱语 习废帝 宰相 做N届的主席 维尼史 习核心 乳制品 野心习 大国造疫 这个年很静 毛二世 大锅瞻遗 XD 小习微信 错误执行者 裸宽包子劾心 习屎黄 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 巴拿马文件 动物之森 役民五术 习远凸 糖尿维尼 赵王 彩色哥 刁远山 人均接近八千万 捐麦子 帝皇頌 NMSL Criminal##Xi##"Xitler"##Jinping 人民领袖 墙内人 任志强 支那精神野爹 添宪宝宝 小学博士 中国首席造梦大师 习包子 习和谐 专治各种不服 灰习牛 五毛主席 彭主席（习主席走了太太接班） 第22条军规 A##Big##Deal 习流氓 集金pay 发皇帝梦 习大郎 习语 神明论 近言 包子露宪 集近闭 “梦回大清” 每日祈翠 独彩者 庆丰帝的千秋梦 “登机”（与登基同音） 重地之战 形式主义防疫 我是一个足球迷 刁大犬 智商不重要 疯狂宇宙包 Corona##Xi（习病毒） 刁近乎 口罩大会 御板泽民 毛二 领袖习澡水 日子像蜜甜 游泳一千米 维尼梗有害 习三拍 WHO的君王 塔西佗陷阱 2020全面小康 习emperor 习侯 倒车 赵人13 4中组长 颐指气使 阳台上的哨兵 386系统驱动游戏 花花公子 习殡法 倒车帝 皇帝亲临忠诚的武汉 法习斯 习贼 东方project Chairman##Xi 习思想 习夶 维尼写史 北京中南海支部书记 习进棺 枪毙名单 书单吟诵者 糟糕皇帝 习达姆 習敗北 赛禁评 XDD 习总 习正日 习包皮 virus##king 读书单 中国的新皇帝 共哀宗 梁家河 叩谢习恩 秦城监狱 慨撒大帝 习病法 小学居士 学包积极分子 习式病毒 清单帝 拉清单 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 撒币宝 平平 叩谢习恩 氼兲嫑炛 百万雄师事件 冰棒外交 毛孙 人民领袖 包子兵法 皇帝亲临忠诚的武汉 习卒习 红旗下的蛋 扛麦帝 习二坐船 刁后主 主席+终身制 习奥塞斯库 蔡英文最强助选 吸包皮 玉习大帝 太祖兔 爱新觉罗近平 习躲躲 Mr##Shithole 庆丰废物 中国离岸隐匿资产管理工作领导小组组组长 维持会长 冤大头 习呆呆 禁评大帝 SB包子 习瘟猪 骑巨龙 国王 习厉王 中字头组长 梦回大清 习教父 九评 十一郎习近平 翡翠娘娘 甩锅侠 包大人 习三点 字共狗 毛装 官僚主义 shuu##kinn##pei 彩色熊 亲自封号 梦帝 大撒幣 邪大大 胡志平 习尿瓶 格萨尔 近日成 习梦思 维尼带货 bingbang帝 富平学霸刁斤干 习皇的新装 学包率 习二二（二零二零年五月二十二日开二会） 青年大学包 “无罩”现身 乳包文化 electron8964 习条英机 习包子的Fa 坡涛汹涌 爱新觉罗·近平 平&强 口罩外交 儿童习典 习低能儿 Adolf##Xitler 大撒币 总统包子习 中国拉清单工作领导小组组长 习大帝 感恩教育 维尼DISCO 习王的田野上 习犬犬 指定接班人 维尼熊给跳跳虎黄牌 金科律玉 吸精瓶 习孢子 Voice##of##Pooh 习卒 习大 亲自指挥疫情 第一书记王沪宁 vop 初二圣君 戴口赵 终身领导人 断崖式下跌 老歪脖子树 CoronaXi 冲塔 假.."~bang！卒 腊肉馅儿包子 世宗 贬词包用 头号球迷 昆明湖涨潮 次级乳包 习包子 野兽主席 喷粪帝 坟头蹦迪 影子末帝 庆丰称帝 “皇帝梦” 截颈平 号尿壶公 乳透社##小反旗 抗麦套装 黄俄 包禁评 扛麦郎 中国离岸隐匿资产管理工作领导小组组组长 xdd 10号跳跳虎被维尼拉清单 白猪 习近平光辉形象 阿平 崇祯帝 基拉大和习近平 维尼之声 法外狂徒Lucy（德国） 刁斤二 习习蛤蛤 nmslman（习主席） 习老八 包子金刚腿 最后领导人 沼气专家 核平全世界 平话 习歪嘴 武当七侠的政治斗争 Heil##Xitler 颐使气指 半羽习近平 嘻包皮 万岁来武汉 刁二将 包经 皇帝梦 共哀宗 墨索里习 Cicada##3301##XD 不同意的举手##没有##没有 包包大人 系包皮 习公奭 狙击手待命 nmslese##dream 武汉委托李克强 天安门合法继承人 刁二婚 劝进 席子兵法 习时代 shit禁评 “黄袍加身” 习二卒 包包侠 川普的朋友or敌人 “复辟” 武统时代 习奥赛斯库 当代秦始皇 习狍 近身平A 屎禁评 清华毕业 学包分子 万岁来武汉了 猪禁评 满脸喷粪 瘟疫领主习近平 宽衣帝 羽日帝 習敗敗 你是反贼吗 孙笑川 赵付 修宪连任 当代秦二世 通商宽衣 两会期间+隐瞒 毛二习 刁人13 央视姓党 习大林 习包子 号屎洞 习博士 习一尊 大大招牌 刁人13 不知名氏 电脑世代586 习猪头 人民战争 屎侯 習大佬 迈克尔·索伊 大海掀翻小池塘 习Core 包惠帝 维稳警察（O） 阿道夫-习 禁评的理由 包子病毒 冠子兵法 习梦死 习语录 孤独的毒王 大撒币 袁世凯第二 习近砰 十日文革 普近 夶 朝令夕改 尊蛤讨包 哲欣 “登基” 一天游泳一千米 亲自脱贫 禁评封号 世界最强乞丐 没规划的葬礼 腊肉包 习特勒 梁家河贵族 动物森友会 细瓶颈 大兔 赵家家仆 亲自指挥 晚共昏君 支那毒王 恐惊天上人 《生物安全法》 东瘟疫之地统治者暨全境守护者 维尼快乐组织（Winnie##Happy##Organization）简称WHO 洗包皮 读稿机 隔离”的金葫芦 二百五大帝 习二胖 现任匪首 不敢高声语 維尼頌 包子宪法 称帝修宪 习匪 战疫国 */
package com.pcdd.sonovel;


import cn.hutool.core.io.FileUtil;
import cn.hutool.core.io.file.FileAppender;
import com.pcdd.sonovel.util.FileUtils;
import lombok.SneakyThrows;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.RepeatedTest;

import java.io.*;
import java.nio.ByteBuffer;
import java.nio.MappedByteBuffer;
import java.nio.channels.FileChannel;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardOpenOption;
import java.util.List;

/**
 * 测试结论：多线程无法提高 I/O 密集型任务的性能（epub 章节的添加、多个 txt 合并）
 *
 * @author pcdd
 * Created at 2024/12/8
 */

class TxtMergerTest {

    // static File dir = FileUtil.file("e:/Temp/small_dir");
    static File dir = FileUtil.file("d:/Temp/small_dir");
    static File outputFile = FileUtil.file("e:/Temp/Merge.txt");

    @RepeatedTest(1)
    @DisplayName("首次执行速度最慢，73 s")
    void test01() {
        FileAppender appender = new FileAppender(outputFile, 16, true);
        for (File item : FileUtils.sortFilesByName(dir)) {
            System.out.println(item.getName());
            appender.append(FileUtil.readUtf8String(item));
        }
        appender.flush();
    }

    @RepeatedTest(1)
    @SneakyThrows
    void test02() {
        try (BufferedWriter writer = new BufferedWriter(new FileWriter(outputFile, StandardCharsets.UTF_8, true))) {
            for (File item : FileUtils.sortFilesByName(dir)) {
                System.out.println(item.getName());
                try (BufferedReader reader = new BufferedReader(new FileReader(item, StandardCharsets.UTF_8))) {
                    String line;
                    while ((line = reader.readLine()) != null) {
                        writer.write(line);
                        writer.newLine();
                    }
                }
                writer.newLine();
            }
        }
    }

    @RepeatedTest(1)
    @SneakyThrows
    @DisplayName("test02 的优化")
    void test03() {
        List<File> files = FileUtils.sortFilesByName(dir);
        try (BufferedWriter writer = new BufferedWriter(new FileWriter(outputFile, StandardCharsets.UTF_8, true), 16 * 1024)) {
            for (File item : files) {
                System.out.println("Processing: " + item.getName());
                try (BufferedReader reader = new BufferedReader(new FileReader(item, StandardCharsets.UTF_8), 16 * 1024)) {
                    char[] buffer = new char[16 * 1024]; // 缓冲数组
                    int len;
                    while ((len = reader.read(buffer)) != -1) {
                        writer.write(buffer, 0, len);
                    }
                }
                writer.newLine(); // 文件之间添加换行符
            }
        }
    }

    @RepeatedTest(1)
    @DisplayName("NIO 13.905 s")
    @SneakyThrows
    void test04() {
        List<File> files = FileUtils.sortFilesByName(dir);
        Path outputPath = Paths.get(outputFile.getAbsolutePath());
        try (BufferedWriter writer = Files.newBufferedWriter(outputPath, StandardCharsets.UTF_8, StandardOpenOption.CREATE, StandardOpenOption.APPEND)) {
            for (File item : files) {
                System.out.println("Processing: " + item.getName());
                Files.lines(item.toPath(), StandardCharsets.UTF_8).forEach(line -> {
                    try {
                        writer.write(line);
                        writer.newLine();
                    } catch (IOException e) {
                        throw new UncheckedIOException(e);
                    }
                });
                writer.newLine();
            }
        }
    }

    @RepeatedTest(1)
    @DisplayName("FileChannel 11.107 s")
    @SneakyThrows
    void test05() {
        List<File> files = FileUtils.sortFilesByName(dir);
        try (FileChannel outChannel = FileChannel.open(Paths.get(outputFile.getAbsolutePath()), StandardOpenOption.CREATE, StandardOpenOption.WRITE, StandardOpenOption.APPEND)) {
            for (File file : files) {
                System.out.println("Processing: " + file.getName());
                try (FileChannel inChannel = FileChannel.open(file.toPath(), StandardOpenOption.READ)) {
                    long size = inChannel.size();
                    MappedByteBuffer buffer = inChannel.map(FileChannel.MapMode.READ_ONLY, 0, size);
                    outChannel.write(buffer);
                }
                outChannel.write(ByteBuffer.wrap(System.lineSeparator().getBytes(StandardCharsets.UTF_8))); // 换行符
            }
        }
    }

}